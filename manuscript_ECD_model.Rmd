---
#title: |
#   | Predicting the effects of character displacement on food-web dynamics
#   | Food-web dynamics under ecological character displacement
#author: 
#- Matthew A. Barbour$^{1,2,\ast}$
# potentially use for 'date' for affiliations, as recommended by https://github.com/rstudio/bookdown/issues/348 for cross-format compatibility, with | to create new sections.
#date: | 
#    | 1. Affiliation
output:
  pdf_document:
    keep_tex: true
    toc: false
    number_sections: false
    df_print: paged
    fig_caption: true
    citation_package: natbib 
    includes:  
      in_header: Am-Nat-preamble-latex.tex
bibliography: references
biblio-style: amnat
fontsize: 11pt
fontfamily: mathpazo
documentclass: article
linkcolor: black
urlcolor: black
citecolor: black
---

<!-- Begin title page formatting -->

\vspace*{0.1cm} 
\begin{center} \LARGE Food-web dynamics under ecological character displacement \end{center}

\bigskip

<!-- Remove author info for double-blind peer review; Keep for bioRxiv submission -->
\begin{center} \large Matthew A. Barbour$^{1,2,\ast}$ \normalsize \end{center}

\bigskip

\noindent 1. University of Zurich, Department of Evolutionary Biology and Environmental Studies, Winterthurerstrasse 190, 8057 Zurich, Switzerland;

\noindent 2. University of British Columbia, Department of Zoology, Vancouver, BC V6T 1Z4, Canada;

$^\ast$ Corresponding author; e-mail: matthew.barbour@ieu.uzh.ch

\bigskip

*Manuscript elements*: Figure 1, figure 2, and figure 3. All figures should be printed in color.

\bigskip

*Keywords*: competition; eco-evolutionary dynamics; consumer-resource interactions; adaptive radiation; ecological community 

\bigskip

*Manuscript type*: Note.

\bigskip

\footnotesize Prepared using an *Am. Nat.* inspired \LaTeX{} template for Rmarkdown. \normalsize

<!-- End title page formatting -->

\linenumbers{}
\modulolinenumbers[3]

\newpage

<!-- Outline 

Introduction

1. ECD is an important process, and current empirical and theoretical work suggests it often results in divergence of consumer foraging traits.

2. Ecological consequences of character displacement have received surprisingly little attention. In particular, prior work doesn't allow a proper comparision of the effects of character displacement on community stability.

-> Another paragraph illustrating how the direct and indirect effects of character displacement likely have constrasting effects on stability.

3. Here we fill this knowledge gap. We focus on the ecological side of these dynamics, because the evolutionary aspects have been well characterized, although we show in the appendices that the evolutionary dynamics are as expected (especially for McCann model).

Methods and Results

- Underlying model of consumer-resource dynamics
  1. Explanation of model parameters
  2. Methods for assessing resource abundances and stability.
  3. Trade-off function and definition of character displacement.
  4. Analytical and simulation methods. Briefly mention the different scenarios I'll explore.

- Consumers can forage for resources simultaneously
  1. Functional response equation and illustration of assumptions
  2. Effect on attack rates, resource densities, and stability

- Consumers cannot foraging for resource simultaneously
  1. Functional response equation and illustration of assumptions
  2. Effect on attack rates, resource densities, and stability

- McCann's most realistic functional response
  1. Functional response equation and illustration of assumptions
  2. Effect on attack rates, resource densities, and stability

Discussion

-->



```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE)

## Load required libraries
library(deSolve) # numerical integration library
library(rootSolve) # for runsteady integration function
library(pse) # for latin hypercube
library(plyr) # for ldply
library(dplyr) # for manipulating data
library(tidyr) # for tidying data
library(cowplot) # for better base, ggplot graphics

## color palette
cbPalette <- c("#D55E00", "#0072B2", "#009E73")
```

```{r Simulations, include=FALSE, messages=TRUE, cache=TRUE}

#### GET REQUIRED FUNCTIONS ####

source('identify_steady_state.R')
source('eco_evo_sim_function.R')
source('Consumer_Resource_Functions.R')
source('CR_dynamics.R')

#### GENERAL PARAMETERS AND STATE VARIABLES #### 

## Intrinsic growth rates
r <- 1
r1 <- r 
r2 <- r 

## Carrying capacity
K <- 4
K1 <- K
K2 <- K

## Conversion efficiency
e <- 0.8
e11 <- e 
e12 <- e 
e21 <- e 
e22 <- e 

## Mortality rate
m <- 1
m1 <- m
m2 <- m

## General, non-evolving parameter set for 2C,2R model
general_parameters <- data.frame(r1 = r1, r2 = r2, K1 = K1, K2 = K2, e11 = e11, e12 = e12, e21 = e21, e22 = e22, m1 = m1, m2 = m2)

## Attack rate
A <- 2
aii <- A*0.61

## Habitat preference (for LawlorSmith and McCann models)
w <- 0.6
wii <- w
wij <- (1 - w)

## Handling time (only for McCann model)
h <- 0.4
h11 <- h
h12 <- h
h21 <- h
h22 <- h

## State variables
R <- 2
R1 <- R
R2 <- R
C <- 1
C1 <- C
C2 <- C

states_2C_2R <- data.frame(R1 = R1, R2 = R2, C1 = C1, C2 = C2)
states_1C_2R <- data.frame(R1 = R1, R2 = R2, C1 = C1)

## Trade-offs. Borrowed from Sargent and Otto, 2006 Am Nat
a12_tradeoff <- expression(A*(1-(a11m/A)^n)^(1/n)) 
a21_tradeoff <- expression(A*(1-(a22m/A)^n)^(1/n)) 

n_concaveDN <- 1.15
n_linear <- 1
n_concaveUP <- 0.85

concaveDN_df <- data.frame(n = n_concaveDN, aii = seq(0,A,0.01)) %>% mutate(aij = A*(1-(aii/A)^n_concaveDN)^(1/n_concaveDN))
linear_df <- data.frame(n = n_linear, aii = seq(0,A,0.01)) %>% mutate(aij = A*(1-(aii/A)^n_linear)^(1/n_linear))
concaveUP_df <- data.frame(n = n_concaveUP, aii = seq(0,A,0.01)) %>% mutate(aij = A*(1-(aii/A)^n_concaveUP)^(1/n_concaveUP))

bind_rows(concaveDN_df, linear_df, concaveUP_df) %>%
  ggplot(., aes(x=aii, y=aij, color = factor(n))) + geom_line() + ggtitle("Attack rate trade-offs")

bind_rows(concaveDN_df, linear_df, concaveUP_df) %>%
  ggplot(., aes(x=aii/(aii+aij), y=aii+aij, color = factor(n))) + geom_line() + ggtitle("Relationship between specialization and total attack rate")

######################################### MACARTHUR MODEL #######################################################

## Mutant growth rates
mC1_MacArthur <- expression(e11*a11m*R1 + e12*a12m*R2 - m1)
mC2_MacArthur <- expression(e21*a21m*R1 + e22*a22m*R2 - m2)

#### PARAMETERS ####

## Linear
params_2C_2R_MacArthur_linear <- data.frame(general_parameters,
                                            a11 = aii, 
                                            a12 = eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_linear)),                     
                                            a21 = eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_linear)), 
                                            a22 = aii)                      
params_1C_2R_MacArthur_linear <- params_2C_2R_MacArthur_linear[c("r1","r2","K1","K2","e11","e12","a11","a12","m1")]


## concaveDN
params_2C_2R_MacArthur_concaveDN <- params_2C_2R_MacArthur_linear
params_2C_2R_MacArthur_concaveDN["a12"] <- eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_concaveDN))
params_2C_2R_MacArthur_concaveDN["a21"] <- eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_concaveDN))
params_1C_2R_MacArthur_concaveDN <- params_2C_2R_MacArthur_concaveDN[c("r1","r2","K1","K2","e11","e12","a11","a12","m1")]

## concaveUP
params_2C_2R_MacArthur_concaveUP <- params_2C_2R_MacArthur_linear
params_2C_2R_MacArthur_concaveUP["a12"] <- eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_concaveUP))
params_2C_2R_MacArthur_concaveUP["a21"] <- eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_concaveUP))
params_1C_2R_MacArthur_concaveUP <- params_2C_2R_MacArthur_concaveUP[c("r1","r2","K1","K2","e11","e12","a11","a12","m1")]

#### SIMULATIONS ####

## Linear
sim_2C_2R_MacArthur_linear <- eco_evo_CR(init_parameters = params_2C_2R_MacArthur_linear, 
                                init_states = states_2C_2R, 
                                eco_CR_model = MacArthur_2C_2R, 
                                AD_CR_models = c(mC1_MacArthur, mC2_MacArthur),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_linear))
sim_1C_2R_MacArthur_linear <- eco_evo_CR(init_parameters = params_1C_2R_MacArthur_linear, 
                                init_states = states_1C_2R, 
                                eco_CR_model = MacArthur_1C_2R, 
                                AD_CR_models = c(mC1_MacArthur),
                                species_traits = c(1), 
                                eco_param_names = c("a11"), 
                                eco_tradeoff_names = c("a12"),  
                                evo_param_names = c("a11m"),  
                                evo_tradeoff_names = c("a12m"), 
                                tradeoff_functions = c(a12_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_linear))
# asymmetric starting points
params_2C_2R_MacArthur_linear_asymm <- params_2C_2R_MacArthur_linear
params_2C_2R_MacArthur_linear_asymm[c("a21","a22")] <- sim_1C_2R_MacArthur_linear[nrow(sim_1C_2R_MacArthur_linear), c("a12","a11")] # replace C2's attack rates with the ending point of the C1 generalist simulation. This will create an asymmetry in the attack rates and follows the logic (and our results) that a likely scenerio with asymmetry is a specialist invading a generalist.
# just altering the parameters, everything else stays the same
sim_2C_2R_MacArthur_linear_asymm <- eco_evo_CR(init_parameters = params_2C_2R_MacArthur_linear_asymm,
                                init_states = states_2C_2R, 
                                eco_CR_model = MacArthur_2C_2R, 
                                AD_CR_models = c(mC1_MacArthur, mC2_MacArthur),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_linear))

## concaveDN
sim_2C_2R_MacArthur_concaveDN <- eco_evo_CR(init_parameters = params_2C_2R_MacArthur_concaveDN, 
                                init_states = states_2C_2R, 
                                eco_CR_model = MacArthur_2C_2R, 
                                AD_CR_models = c(mC1_MacArthur, mC2_MacArthur),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_concaveDN))
sim_1C_2R_MacArthur_concaveDN <- eco_evo_CR(init_parameters = params_1C_2R_MacArthur_concaveDN, 
                                init_states = states_1C_2R, 
                                eco_CR_model = MacArthur_1C_2R, 
                                AD_CR_models = c(mC1_MacArthur),
                                species_traits = c(1), 
                                eco_param_names = c("a11"), 
                                eco_tradeoff_names = c("a12"),  
                                evo_param_names = c("a11m"),  
                                evo_tradeoff_names = c("a12m"), 
                                tradeoff_functions = c(a12_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_concaveDN))
# asymmetric starting points
params_2C_2R_MacArthur_concaveDN_asymm <- params_2C_2R_MacArthur_concaveDN
params_2C_2R_MacArthur_concaveDN_asymm[c("a21","a22")] <- sim_1C_2R_MacArthur_concaveDN[nrow(sim_1C_2R_MacArthur_concaveDN), c("a12","a11")] 
sim_2C_2R_MacArthur_concaveDN_asymm <- eco_evo_CR(init_parameters = params_2C_2R_MacArthur_concaveDN_asymm,
                                init_states = states_2C_2R, 
                                eco_CR_model = MacArthur_2C_2R, 
                                AD_CR_models = c(mC1_MacArthur, mC2_MacArthur),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_concaveDN))

## concaveUP
sim_2C_2R_MacArthur_concaveUP <- eco_evo_CR(init_parameters = params_2C_2R_MacArthur_concaveUP, 
                                       init_states = states_2C_2R, 
                                       eco_CR_model = MacArthur_2C_2R, 
                                       AD_CR_models = c(mC1_MacArthur, mC2_MacArthur),
                                       species_traits = c(1,2), 
                                       eco_param_names = c("a11","a22"), 
                                       eco_tradeoff_names = c("a12","a21"),  
                                       evo_param_names = c("a11m","a22m"),  
                                       evo_tradeoff_names = c("a12m","a21m"), 
                                       tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                       extra_tradeoff_params = c(A=A, n=n_concaveUP))
sim_1C_2R_MacArthur_concaveUP <- eco_evo_CR(init_parameters = params_1C_2R_MacArthur_concaveUP, 
                                       init_states = states_1C_2R, 
                                       eco_CR_model = MacArthur_1C_2R, 
                                       AD_CR_models = c(mC1_MacArthur),
                                       species_traits = c(1), 
                                       eco_param_names = c("a11"), 
                                       eco_tradeoff_names = c("a12"),  
                                       evo_param_names = c("a11m"),  
                                       evo_tradeoff_names = c("a12m"), 
                                       tradeoff_functions = c(a12_tradeoff),
                                       extra_tradeoff_params = c(A=A, n=n_concaveUP))
# asymmetric starting points
params_2C_2R_MacArthur_concaveUP_asymm <- params_2C_2R_MacArthur_concaveUP
params_2C_2R_MacArthur_concaveUP_asymm[c("a21","a22")] <- sim_1C_2R_MacArthur_concaveUP[nrow(sim_1C_2R_MacArthur_concaveUP), c("a12","a11")]
# max iterations reached!
sim_2C_2R_MacArthur_concaveUP_asymm <- eco_evo_CR(init_parameters = params_2C_2R_MacArthur_concaveUP_asymm,
                                init_states = states_2C_2R, 
                                eco_CR_model = MacArthur_2C_2R, 
                                AD_CR_models = c(mC1_MacArthur, mC2_MacArthur),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_concaveUP))

######################################### LAWLOR SMITH COARSE-GRAIN MODEL #######################################################


## Mutant growth rates
mC1_LawlorSmith <- expression(e11*w11*a11m*R1 + e12*w12*a12m*R2 - m1)
mC2_LawlorSmith <- expression(e21*w21*a21m*R1 + e22*w22*a22m*R2 - m2)

#### PARAMETERS ####

## Linear
params_2C_2R_LawlorSmith_linear <- data.frame(general_parameters,
                                              a11 = aii,
                                              a12 = eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_linear)), 
                                              a21 = eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_linear)), 
                                              a22 = aii,
                                              w11 = wii, 
                                              w12 = wij, 
                                              w21 = wij,
                                              w22 = wii)
params_1C_2R_LawlorSmith_linear <- params_2C_2R_LawlorSmith_linear[c("r1","r2","K1","K2","e11","e12","a11","a12","m1","w11","w12","w21","w22")]


## concaveDN
params_2C_2R_LawlorSmith_concaveDN <- params_2C_2R_LawlorSmith_linear
params_2C_2R_LawlorSmith_concaveDN["a12"] <- eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_concaveDN))
params_2C_2R_LawlorSmith_concaveDN["a21"] <- eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_concaveDN))
params_1C_2R_LawlorSmith_concaveDN <- params_2C_2R_LawlorSmith_concaveDN[c("r1","r2","K1","K2","e11","e12","a11","a12","m1","w11","w12","w21","w22")]

## concaveUP
params_2C_2R_LawlorSmith_concaveUP <- params_2C_2R_LawlorSmith_linear
params_2C_2R_LawlorSmith_concaveUP["a12"] <- eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_concaveUP))
params_2C_2R_LawlorSmith_concaveUP["a21"] <- eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_concaveUP))
params_1C_2R_LawlorSmith_concaveUP <- params_2C_2R_LawlorSmith_concaveUP[c("r1","r2","K1","K2","e11","e12","a11","a12","m1","w11","w12","w21","w22")]

#### SIMULATIONS ####

## Linear
sim_2C_2R_LawlorSmith_linear <- eco_evo_CR(init_parameters = params_2C_2R_LawlorSmith_linear, 
                                       init_states = states_2C_2R, 
                                       eco_CR_model = LawlorSmith_2C_2R, 
                                       AD_CR_models = c(mC1_LawlorSmith, mC2_LawlorSmith),
                                       species_traits = c(1,2), 
                                       eco_param_names = c("a11","a22"), 
                                       eco_tradeoff_names = c("a12","a21"),  
                                       evo_param_names = c("a11m","a22m"),  
                                       evo_tradeoff_names = c("a12m","a21m"), 
                                       tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                       extra_tradeoff_params = c(A=A, n=n_linear))
sim_1C_2R_LawlorSmith_linear <- eco_evo_CR(init_parameters = params_1C_2R_LawlorSmith_linear, 
                                       init_states = states_1C_2R, 
                                       eco_CR_model = LawlorSmith_1C_2R, 
                                       AD_CR_models = c(mC1_LawlorSmith),
                                       species_traits = c(1), 
                                       eco_param_names = c("a11"), 
                                       eco_tradeoff_names = c("a12"),  
                                       evo_param_names = c("a11m"),  
                                       evo_tradeoff_names = c("a12m"), 
                                       tradeoff_functions = c(a12_tradeoff),
                                       extra_tradeoff_params = c(A=A, n=n_linear))
# asymmetric starting points
params_2C_2R_LawlorSmith_linear_asymm <- params_2C_2R_LawlorSmith_linear
params_2C_2R_LawlorSmith_linear_asymm[c("a21","a22")] <- sim_1C_2R_LawlorSmith_linear[nrow(sim_1C_2R_LawlorSmith_linear), c("a12","a11")] 
sim_2C_2R_LawlorSmith_linear_asymm <- eco_evo_CR(init_parameters = params_2C_2R_LawlorSmith_linear_asymm,
                                init_states = states_2C_2R, 
                                eco_CR_model = LawlorSmith_2C_2R, 
                                AD_CR_models = c(mC1_LawlorSmith, mC2_LawlorSmith),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_linear))

## concaveDN
# max mut iter reach!
sim_2C_2R_LawlorSmith_concaveDN <- eco_evo_CR(init_parameters = params_2C_2R_LawlorSmith_concaveDN, 
                                       init_states = states_2C_2R, 
                                       eco_CR_model = LawlorSmith_2C_2R, 
                                       AD_CR_models = c(mC1_LawlorSmith, mC2_LawlorSmith),
                                       species_traits = c(1,2), 
                                       eco_param_names = c("a11","a22"), 
                                       eco_tradeoff_names = c("a12","a21"),  
                                       evo_param_names = c("a11m","a22m"),  
                                       evo_tradeoff_names = c("a12m","a21m"), 
                                       tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                       extra_tradeoff_params = c(A=A, n=n_concaveDN))
# note that although the max mutation iterations are reached, the evolving parameters appear to oscillate near high values, i.e. they are effectively at an ESS
plot(sim_2C_2R_LawlorSmith_concaveDN[,c("a11","a22")]) 
plot(sim_2C_2R_LawlorSmith_concaveDN[,c("a11","a22")], xlim=c(1.85,1.95)) 

sim_1C_2R_LawlorSmith_concaveDN <- eco_evo_CR(init_parameters = params_1C_2R_LawlorSmith_concaveDN, 
                                       init_states = states_1C_2R, 
                                       eco_CR_model = LawlorSmith_1C_2R, 
                                       AD_CR_models = c(mC1_LawlorSmith),
                                       species_traits = c(1), 
                                       eco_param_names = c("a11"), 
                                       eco_tradeoff_names = c("a12"),  
                                       evo_param_names = c("a11m"),  
                                       evo_tradeoff_names = c("a12m"), 
                                       tradeoff_functions = c(a12_tradeoff),
                                       extra_tradeoff_params = c(A=A, n=n_concaveDN))
# asymmetric starting points
params_2C_2R_LawlorSmith_concaveDN_asymm <- params_2C_2R_LawlorSmith_concaveDN
params_2C_2R_LawlorSmith_concaveDN_asymm[c("a21","a22")] <- sim_1C_2R_LawlorSmith_concaveDN[nrow(sim_1C_2R_LawlorSmith_concaveDN), c("a12","a11")] 
sim_2C_2R_LawlorSmith_concaveDN_asymm <- eco_evo_CR(init_parameters = params_2C_2R_LawlorSmith_concaveDN_asymm,
                                init_states = states_2C_2R, 
                                eco_CR_model = LawlorSmith_2C_2R, 
                                AD_CR_models = c(mC1_LawlorSmith, mC2_LawlorSmith),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_concaveDN))

## concaveUP
sim_2C_2R_LawlorSmith_concaveUP <- eco_evo_CR(init_parameters = params_2C_2R_LawlorSmith_concaveUP, 
                                        init_states = states_2C_2R, 
                                        eco_CR_model = LawlorSmith_2C_2R, 
                                        AD_CR_models = c(mC1_LawlorSmith, mC2_LawlorSmith),
                                        species_traits = c(1,2), 
                                        eco_param_names = c("a11","a22"), 
                                        eco_tradeoff_names = c("a12","a21"),  
                                        evo_param_names = c("a11m","a22m"),  
                                        evo_tradeoff_names = c("a12m","a21m"), 
                                        tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                        extra_tradeoff_params = c(A=A, n=n_concaveUP))
sim_1C_2R_LawlorSmith_concaveUP <- eco_evo_CR(init_parameters = params_1C_2R_LawlorSmith_concaveUP, 
                                        init_states = states_1C_2R, 
                                        eco_CR_model = LawlorSmith_1C_2R, 
                                        AD_CR_models = c(mC1_LawlorSmith),
                                        species_traits = c(1), 
                                        eco_param_names = c("a11"), 
                                        eco_tradeoff_names = c("a12"),  
                                        evo_param_names = c("a11m"),  
                                        evo_tradeoff_names = c("a12m"), 
                                        tradeoff_functions = c(a12_tradeoff),
                                        extra_tradeoff_params = c(A=A, n=n_concaveUP))
# asymmetric starting points
params_2C_2R_LawlorSmith_concaveUP_asymm <- params_2C_2R_LawlorSmith_concaveUP
params_2C_2R_LawlorSmith_concaveUP_asymm[c("a21","a22")] <- sim_1C_2R_LawlorSmith_concaveUP[nrow(sim_1C_2R_LawlorSmith_concaveUP), c("a12","a11")] 
sim_2C_2R_LawlorSmith_concaveUP_asymm <- eco_evo_CR(init_parameters = params_2C_2R_LawlorSmith_concaveUP_asymm,
                                init_states = states_2C_2R, 
                                eco_CR_model = LawlorSmith_2C_2R, 
                                AD_CR_models = c(mC1_LawlorSmith, mC2_LawlorSmith),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_concaveUP))

######################################### MCCANN MODEL #######################################################


## Mutant growth rates
mC1_McCann <- expression(e11*(((w11 * R1)/(w11 * R1 + w12 * R2)) * a11m * R1)/(1 + ((w11 * R1)/(w11 * R1 + w12 * R2)) * a11m * h11 * R1 + ((w12 * R2)/(w11 * R1 + w12 * R2)) * a12m * h12 * R2) + e12*(((w12 * R2)/(w11 * R1 + w12 * R2)) * a12m * R2)/(1 + ((w11 * R1)/(w11 * R1 + w12 * R2)) * a11m * h11 * R1 + ((w12 * R2)/(w11 * R1 + w12 * R2)) * a12m * h12 * R2) - m1)
mC2_McCann <- expression(e21*(((w21 * R1)/(w21 * R1 + w22 * R2)) * a21m * R1)/(1 + ((w21 * R1)/(w21 * R1 + w22 * R2)) * a21m * h21 * R1 + ((w22 * R2)/(w21 * R1 + w22 * R2)) * a22m * h22 * R2) + e22*(((w22 * R2)/(w21 * R1 + w22 * R2)) * a22m * R2)/(1 + ((w21 * R1)/(w21 * R1 + w22 * R2)) * a21m * h21 * R1 + ((w22 * R2)/(w21 * R1 + w22 * R2)) * a22m * h22 * R2) - m2)


#### PARAMETERS ####

## Linear
params_2C_2R_McCann_linear <- data.frame(general_parameters,
                                         a11 = aii,
                                         a12 = eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_linear)), 
                                         a21 = eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_linear)), 
                                         a22 = aii,
                                         w11 = wii, 
                                         w12 = wij, 
                                         w21 = wij,
                                         w22 = wii,
                                         h11 = h11,
                                         h12 = h12,
                                         h21 = h21,
                                         h22 = h22)
                                            
params_1C_2R_McCann_linear <- params_2C_2R_McCann_linear[c("r1","r2","K1","K2","e11","e12","a11","a12","m1","w11","w12","w21","w22","h11","h12","h21","h22")]


## concaveDN
params_2C_2R_McCann_concaveDN <- params_2C_2R_McCann_linear
params_2C_2R_McCann_concaveDN["a12"] <- eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_concaveDN))
params_2C_2R_McCann_concaveDN["a21"] <- eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_concaveDN))
params_1C_2R_McCann_concaveDN <- params_2C_2R_McCann_concaveDN[c("r1","r2","K1","K2","e11","e12","a11","a12","m1","w11","w12","w21","w22","h11","h12","h21","h22")]

## concaveUP
params_2C_2R_McCann_concaveUP <- params_2C_2R_McCann_linear
params_2C_2R_McCann_concaveUP["a12"] <- eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_concaveUP))
params_2C_2R_McCann_concaveUP["a21"] <- eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_concaveUP))
params_1C_2R_McCann_concaveUP <- params_2C_2R_McCann_concaveUP[c("r1","r2","K1","K2","e11","e12","a11","a12","m1","w11","w12","w21","w22","h11","h12","h21","h22")]

#### SIMULATIONS ####

## Linear
sim_2C_2R_McCann_linear <- eco_evo_CR(init_parameters = params_2C_2R_McCann_linear, 
                                         init_states = states_2C_2R, 
                                         eco_CR_model = McCann_2C_2R, 
                                         AD_CR_models = c(mC1_McCann, mC2_McCann),
                                         species_traits = c(1,2), 
                                         eco_param_names = c("a11","a22"), 
                                         eco_tradeoff_names = c("a12","a21"),  
                                         evo_param_names = c("a11m","a22m"),  
                                         evo_tradeoff_names = c("a12m","a21m"), 
                                         tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                         extra_tradeoff_params = c(A=A, n=n_linear))
sim_1C_2R_McCann_linear <- eco_evo_CR(init_parameters = params_1C_2R_McCann_linear, 
                                         init_states = states_1C_2R, 
                                         eco_CR_model = McCann_1C_2R, 
                                         AD_CR_models = c(mC1_McCann),
                                         species_traits = c(1), 
                                         eco_param_names = c("a11"), 
                                         eco_tradeoff_names = c("a12"),  
                                         evo_param_names = c("a11m"),  
                                         evo_tradeoff_names = c("a12m"), 
                                         tradeoff_functions = c(a12_tradeoff),
                                         extra_tradeoff_params = c(A=A, n=n_linear))
# I'm thinking these initial asymmetric simulations don't quite make sense (at least for LawlorSmith and McCann). This is because I didn't switch the pre-adapted habitat preferences as well...This is important because C1 in the first simulation becomes C2 in the 2C-2R sim. This isn't an issue in the symmetry model, because I assume they are pre-adapted on different resources. 
# asymmetric starting points
params_2C_2R_McCann_linear_asymm <- params_2C_2R_McCann_linear
params_2C_2R_McCann_linear_asymm[c("a21","a22")] <- sim_1C_2R_McCann_linear[nrow(sim_1C_2R_McCann_linear), c("a12","a11")] # make sure a_ij and a_ii are in correct order. Note that habitat preference (w) is already set in the appropriate direction 
sim_2C_2R_McCann_linear_asymm <- eco_evo_CR(init_parameters = params_2C_2R_McCann_linear_asymm,
                                init_states = states_2C_2R, 
                                eco_CR_model = McCann_2C_2R, 
                                AD_CR_models = c(mC1_McCann, mC2_McCann),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_linear))

## concaveDN
# max mut iter
sim_2C_2R_McCann_concaveDN <- eco_evo_CR(init_parameters = params_2C_2R_McCann_concaveDN, 
                                         init_states = states_2C_2R, 
                                         eco_CR_model = McCann_2C_2R, 
                                         AD_CR_models = c(mC1_McCann, mC2_McCann),
                                         species_traits = c(1,2), 
                                         eco_param_names = c("a11","a22"), 
                                         eco_tradeoff_names = c("a12","a21"),  
                                         evo_param_names = c("a11m","a22m"),  
                                         evo_tradeoff_names = c("a12m","a21m"), 
                                         tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                         extra_tradeoff_params = c(A=A, n=n_concaveDN))
# note that although the max mutation iterations are reached, the evolving parameters appear to oscillate near high values. i.e. they are effectively at an ESS
plot(sim_2C_2R_McCann_concaveDN[,c("a11","a22")]) 
plot(sim_2C_2R_McCann_concaveDN[,c("a11","a22")], xlim=c(1.85,1.95)) 

sim_1C_2R_McCann_concaveDN <- eco_evo_CR(init_parameters = params_1C_2R_McCann_concaveDN, 
                                         init_states = states_1C_2R, 
                                         eco_CR_model = McCann_1C_2R, 
                                         AD_CR_models = c(mC1_McCann),
                                         species_traits = c(1), 
                                         eco_param_names = c("a11"), 
                                         eco_tradeoff_names = c("a12"),  
                                         evo_param_names = c("a11m"),  
                                         evo_tradeoff_names = c("a12m"), 
                                         tradeoff_functions = c(a12_tradeoff),
                                         extra_tradeoff_params = c(A=A, n=n_concaveDN))
# asymmetric starting points
params_2C_2R_McCann_concaveDN_asymm <- params_2C_2R_McCann_concaveDN
params_2C_2R_McCann_concaveDN_asymm[c("a21","a22")] <- sim_1C_2R_McCann_concaveDN[nrow(sim_1C_2R_McCann_concaveDN), c("a12","a11")] 
sim_2C_2R_McCann_concaveDN_asymm <- eco_evo_CR(init_parameters = params_2C_2R_McCann_concaveDN_asymm,
                                init_states = states_2C_2R, 
                                eco_CR_model = McCann_2C_2R, 
                                AD_CR_models = c(mC1_McCann, mC2_McCann),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_concaveDN))

## concaveUP
sim_2C_2R_McCann_concaveUP <- eco_evo_CR(init_parameters = params_2C_2R_McCann_concaveUP, 
                                          init_states = states_2C_2R, 
                                          eco_CR_model = McCann_2C_2R, 
                                          AD_CR_models = c(mC1_McCann, mC2_McCann),
                                          species_traits = c(1,2), 
                                          eco_param_names = c("a11","a22"), 
                                          eco_tradeoff_names = c("a12","a21"),  
                                          evo_param_names = c("a11m","a22m"),  
                                          evo_tradeoff_names = c("a12m","a21m"), 
                                          tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                          extra_tradeoff_params = c(A=A, n=n_concaveUP))
sim_1C_2R_McCann_concaveUP <- eco_evo_CR(init_parameters = params_1C_2R_McCann_concaveUP, 
                                          init_states = states_1C_2R, 
                                          eco_CR_model = McCann_1C_2R, 
                                          AD_CR_models = c(mC1_McCann),
                                          species_traits = c(1), 
                                          eco_param_names = c("a11"), 
                                          eco_tradeoff_names = c("a12"),  
                                          evo_param_names = c("a11m"),  
                                          evo_tradeoff_names = c("a12m"), 
                                          tradeoff_functions = c(a12_tradeoff),
                                          extra_tradeoff_params = c(A=A, n=n_concaveUP))
# asymmetric starting points
params_2C_2R_McCann_concaveUP_asymm <- params_2C_2R_McCann_concaveUP
params_2C_2R_McCann_concaveUP_asymm[c("a21","a22")] <- sim_1C_2R_McCann_concaveUP[nrow(sim_1C_2R_McCann_concaveUP), c("a12","a11")] 
sim_2C_2R_McCann_concaveUP_asymm <- eco_evo_CR(init_parameters = params_2C_2R_McCann_concaveUP_asymm,
                                init_states = states_2C_2R, 
                                eco_CR_model = McCann_2C_2R, 
                                AD_CR_models = c(mC1_McCann, mC2_McCann),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_concaveUP))
```

```{r Organize_Simulation_Data, include=FALSE, cache=TRUE}

## Gather data. Note different formula for effective attack rate of consumer 1 "a_eff_C1". This accounts for the differences between fine- and coarse-grained environments
sim_data <- bind_rows(
  mutate(sim_2C_2R_MacArthur_linear, Model = "MacArthur", n = n_linear, Competitor = "Yes", a_eff_C1 = a11+a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_MacArthur_linear, Model = "MacArthur", n = n_linear, Competitor = "No", a_eff_C1 = a11+a12, Ctot = C1),
  mutate(sim_2C_2R_MacArthur_concaveDN, Model = "MacArthur", n = n_concaveDN, Competitor = "Yes", a_eff_C1 = a11+a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_MacArthur_concaveDN, Model = "MacArthur", n = n_concaveDN, Competitor = "No", a_eff_C1 = a11+a12, Ctot = C1),
  mutate(sim_2C_2R_MacArthur_concaveUP, Model = "MacArthur", n = n_concaveUP, Competitor = "Yes", a_eff_C1 = a11+a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_MacArthur_concaveUP, Model = "MacArthur", n = n_concaveUP, Competitor = "No", a_eff_C1 = a11+a12, Ctot = C1),
  mutate(sim_2C_2R_LawlorSmith_linear, Model = "LawlorSmith", n = n_linear, Competitor = "Yes", a_eff_C1 = w11*a11+w12*a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_LawlorSmith_linear, Model = "LawlorSmith", n = n_linear, Competitor = "No", a_eff_C1 = w11*a11+w12*a12, Ctot = C1),
  mutate(sim_2C_2R_LawlorSmith_concaveDN, Model = "LawlorSmith", n = n_concaveDN, Competitor = "Yes", a_eff_C1 = w11*a11+w12*a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_LawlorSmith_concaveDN, Model = "LawlorSmith", n = n_concaveDN, Competitor = "No", a_eff_C1 = w11*a11+w12*a12, Ctot = C1),
  mutate(sim_2C_2R_LawlorSmith_concaveUP, Model = "LawlorSmith", n = n_concaveUP, Competitor = "Yes", a_eff_C1 = w11*a11+w12*a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_LawlorSmith_concaveUP, Model = "LawlorSmith", n = n_concaveUP, Competitor = "No", a_eff_C1 = w11*a11+w12*a12, Ctot = C1),
  mutate(sim_2C_2R_McCann_linear, Model = "McCann", n = n_linear, Competitor = "Yes", a_eff_C1 = w11*a11+w12*a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_McCann_linear, Model = "McCann", n = n_linear, Competitor = "No", a_eff_C1 = w11*a11+w12*a12, Ctot = C1),
  mutate(sim_2C_2R_McCann_concaveDN, Model = "McCann", n = n_concaveDN, Competitor = "Yes", a_eff_C1 = w11*a11+w12*a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_McCann_concaveDN, Model = "McCann", n = n_concaveDN, Competitor = "No", a_eff_C1 = w11*a11+w12*a12, Ctot = C1),
  mutate(sim_2C_2R_McCann_concaveUP, Model = "McCann", n = n_concaveUP, Competitor = "Yes", a_eff_C1 = w11*a11+w12*a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_McCann_concaveUP, Model = "McCann", n = n_concaveUP, Competitor = "No", a_eff_C1 = w11*a11+w12*a12, Ctot = C1)) 

#### PREDICTING EFFECTS OF CHARACTER DISPLACEMENT ON C-R DYNAMICS ####

tradeoff_df <- bind_rows(mutate(concaveDN_df, n = n_concaveDN), 
                         mutate(linear_df, n = n_linear), 
                         mutate(concaveUP_df, n = n_concaveUP)) %>%
  data.frame(., general_parameters) %>%
  mutate(a11 = aii, a12 = aij, a21 = aij, a22 = aii,
         w11 = wii, w12 = wij, w21 = wij, w22 = wii)

## MacArthur
MacArthur_displacements <- bind_rows(
  mutate(sim_2C_2R_MacArthur_linear, Model = "MacArthur", n = n_linear, Competitor = "Yes")[c(1,nrow(sim_2C_2R_MacArthur_linear)), ], 
  mutate(sim_1C_2R_MacArthur_linear, Model = "MacArthur", n = n_linear, Competitor = "No")[c(1,nrow(sim_1C_2R_MacArthur_linear)), ],
  mutate(sim_2C_2R_MacArthur_concaveDN, Model = "MacArthur", n = n_concaveDN, Competitor = "Yes")[c(1,nrow(sim_2C_2R_MacArthur_concaveDN)), ], 
  mutate(sim_1C_2R_MacArthur_concaveDN, Model = "MacArthur", n = n_concaveDN, Competitor = "No")[c(1,nrow(sim_1C_2R_MacArthur_concaveDN)), ],
  mutate(sim_2C_2R_MacArthur_concaveUP, Model = "MacArthur", n = n_concaveUP, Competitor = "Yes")[c(1,nrow(sim_2C_2R_MacArthur_concaveUP)), ], 
  mutate(sim_1C_2R_MacArthur_concaveUP, Model = "MacArthur", n = n_concaveUP, Competitor = "No")[c(1,nrow(sim_1C_2R_MacArthur_concaveUP)), ]) 
MacArthur_displacements$Time <- rep(c("Begin","End"),6)

MacArthur_2C_2R_tradeoff_dynamics <- CR_dynamics(init_parameters = select(tradeoff_df, r1:a22), init_states = states_2C_2R, eco_CR_model = MacArthur_2C_2R)
MacArthur_1C_2R_tradeoff_dynamics <- CR_dynamics(init_parameters = select(tradeoff_df, r1:a12), init_states = states_1C_2R, eco_CR_model = MacArthur_1C_2R)

## MacArthur asymmetry. Note that all 1C_2R models are from the original simulations, as these were the starting points for the asymmetric sims (and therefore the appropriate comparison)
MacArthur_displacements_asymm <- bind_rows(
  mutate(sim_2C_2R_MacArthur_linear_asymm, Model = "MacArthur", n = n_linear, Competitor = "Yes")[c(1,nrow(sim_2C_2R_MacArthur_linear_asymm)), ], 
  mutate(sim_1C_2R_MacArthur_linear, Model = "MacArthur", n = n_linear, Competitor = "No")[c(1,nrow(sim_1C_2R_MacArthur_linear)), ],
  mutate(sim_2C_2R_MacArthur_concaveDN_asymm, Model = "MacArthur", n = n_concaveDN, Competitor = "Yes")[c(1,nrow(sim_2C_2R_MacArthur_concaveDN_asymm)), ], 
  mutate(sim_1C_2R_MacArthur_concaveDN, Model = "MacArthur", n = n_concaveDN, Competitor = "No")[c(1,nrow(sim_1C_2R_MacArthur_concaveDN)), ],
  mutate(sim_2C_2R_MacArthur_concaveUP_asymm, Model = "MacArthur", n = n_concaveUP, Competitor = "Yes")[c(1,nrow(sim_2C_2R_MacArthur_concaveUP_asymm)), ], 
  mutate(sim_1C_2R_MacArthur_concaveUP, Model = "MacArthur", n = n_concaveUP, Competitor = "No")[c(1,nrow(sim_1C_2R_MacArthur_concaveUP)), ]) 
MacArthur_displacements_asymm$Time <- rep(c("Begin","End"),6)

## Lawlor Smith
LawlorSmith_displacements <- bind_rows(
  mutate(sim_2C_2R_LawlorSmith_linear, Model = "LawlorSmith", n = n_linear, Competitor = "Yes")[c(1,nrow(sim_2C_2R_LawlorSmith_linear)), ], 
  mutate(sim_1C_2R_LawlorSmith_linear, Model = "LawlorSmith", n = n_linear, Competitor = "No")[c(1,nrow(sim_1C_2R_LawlorSmith_linear)), ],
  mutate(sim_2C_2R_LawlorSmith_concaveDN, Model = "LawlorSmith", n = n_concaveDN, Competitor = "Yes")[c(1,nrow(sim_2C_2R_LawlorSmith_concaveDN)), ], 
  mutate(sim_1C_2R_LawlorSmith_concaveDN, Model = "LawlorSmith", n = n_concaveDN, Competitor = "No")[c(1,nrow(sim_1C_2R_LawlorSmith_concaveDN)), ],
  mutate(sim_2C_2R_LawlorSmith_concaveUP, Model = "LawlorSmith", n = n_concaveUP, Competitor = "Yes")[c(1,nrow(sim_2C_2R_LawlorSmith_concaveUP)), ], 
  mutate(sim_1C_2R_LawlorSmith_concaveUP, Model = "LawlorSmith", n = n_concaveUP, Competitor = "No")[c(1,nrow(sim_1C_2R_LawlorSmith_concaveUP)), ]) 
LawlorSmith_displacements$Time <- rep(c("Begin","End"),6)

LawlorSmith_2C_2R_tradeoff_dynamics <- CR_dynamics(init_parameters = select(tradeoff_df, r1:w22), init_states = states_2C_2R, eco_CR_model = LawlorSmith_2C_2R)
LawlorSmith_1C_2R_tradeoff_dynamics <- CR_dynamics(init_parameters = select(tradeoff_df, r1:a12, w11, w12), init_states = states_1C_2R, eco_CR_model = LawlorSmith_1C_2R)

# asymmetry
LawlorSmith_displacements_asymm <- bind_rows(
  mutate(sim_2C_2R_LawlorSmith_linear_asymm, Model = "LawlorSmith", n = n_linear, Competitor = "Yes")[c(1,nrow(sim_2C_2R_LawlorSmith_linear_asymm)), ], 
  mutate(sim_1C_2R_LawlorSmith_linear, Model = "LawlorSmith", n = n_linear, Competitor = "No")[c(1,nrow(sim_1C_2R_LawlorSmith_linear)), ],
  mutate(sim_2C_2R_LawlorSmith_concaveDN_asymm, Model = "LawlorSmith", n = n_concaveDN, Competitor = "Yes")[c(1,nrow(sim_2C_2R_LawlorSmith_concaveDN_asymm)), ], 
  mutate(sim_1C_2R_LawlorSmith_concaveDN, Model = "LawlorSmith", n = n_concaveDN, Competitor = "No")[c(1,nrow(sim_1C_2R_LawlorSmith_concaveDN)), ],
  mutate(sim_2C_2R_LawlorSmith_concaveUP_asymm, Model = "LawlorSmith", n = n_concaveUP, Competitor = "Yes")[c(1,nrow(sim_2C_2R_LawlorSmith_concaveUP_asymm)), ], 
  mutate(sim_1C_2R_LawlorSmith_concaveUP, Model = "LawlorSmith", n = n_concaveUP, Competitor = "No")[c(1,nrow(sim_1C_2R_LawlorSmith_concaveUP)), ]) 
LawlorSmith_displacements_asymm$Time <- rep(c("Begin","End"),6)

## McCann
McCann_displacements <- bind_rows(
  mutate(sim_2C_2R_McCann_linear, Model = "McCann", n = n_linear, Competitor = "Yes")[c(1,nrow(sim_2C_2R_McCann_linear)), ], 
  mutate(sim_1C_2R_McCann_linear, Model = "McCann", n = n_linear, Competitor = "No")[c(1,nrow(sim_1C_2R_McCann_linear)), ],
  mutate(sim_2C_2R_McCann_concaveDN, Model = "McCann", n = n_concaveDN, Competitor = "Yes")[c(1,nrow(sim_2C_2R_McCann_concaveDN)), ], 
  mutate(sim_1C_2R_McCann_concaveDN, Model = "McCann", n = n_concaveDN, Competitor = "No")[c(1,nrow(sim_1C_2R_McCann_concaveDN)), ],
  mutate(sim_2C_2R_McCann_concaveUP, Model = "McCann", n = n_concaveUP, Competitor = "Yes")[c(1,nrow(sim_2C_2R_McCann_concaveUP)), ], 
  mutate(sim_1C_2R_McCann_concaveUP, Model = "McCann", n = n_concaveUP, Competitor = "No")[c(1,nrow(sim_1C_2R_McCann_concaveUP)), ]) 
McCann_displacements$Time <- rep(c("Begin","End"),6)

McCann_2C_2R_tradeoff_dynamics <- CR_dynamics(init_parameters = select(tradeoff_df, r1:w22), init_states = states_2C_2R, eco_CR_model = McCann_2C_2R)
McCann_1C_2R_tradeoff_dynamics <- CR_dynamics(init_parameters = select(tradeoff_df, r1:a12, w11, w12), init_states = states_1C_2R, eco_CR_model = McCann_1C_2R)

# asymmetry
McCann_displacements_asymm <- bind_rows(
  mutate(sim_2C_2R_McCann_linear_asymm, Model = "McCann", n = n_linear, Competitor = "Yes")[c(1,nrow(sim_2C_2R_McCann_linear_asymm)), ], 
  mutate(sim_1C_2R_McCann_linear, Model = "McCann", n = n_linear, Competitor = "No")[c(1,nrow(sim_1C_2R_McCann_linear)), ],
  mutate(sim_2C_2R_McCann_concaveDN_asymm, Model = "McCann", n = n_concaveDN, Competitor = "Yes")[c(1,nrow(sim_2C_2R_McCann_concaveDN_asymm)), ], 
  mutate(sim_1C_2R_McCann_concaveDN, Model = "McCann", n = n_concaveDN, Competitor = "No")[c(1,nrow(sim_1C_2R_McCann_concaveDN)), ],
  mutate(sim_2C_2R_McCann_concaveUP_asymm, Model = "McCann", n = n_concaveUP, Competitor = "Yes")[c(1,nrow(sim_2C_2R_McCann_concaveUP_asymm)), ], 
  mutate(sim_1C_2R_McCann_concaveUP, Model = "McCann", n = n_concaveUP, Competitor = "No")[c(1,nrow(sim_1C_2R_McCann_concaveUP)), ]) 
McCann_displacements_asymm$Time <- rep(c("Begin","End"),6)

# write out data for exploring later and avoiding rerunning the simulations
write.csv(bind_rows(MacArthur_displacements, LawlorSmith_displacements, McCann_displacements), file = "symmetric_displacement_data.csv")
write.csv(bind_rows(MacArthur_displacements_asymm, LawlorSmith_displacements_asymm, McCann_displacements_asymm), file = "asymmetric_displacement_data.csv")
```

# Abstract 

Ecological character displacement is an adaptive process, often enhancing coexistence between consumers by reducing competition for shared resources. 
This focus on competition has undermined the fact that consumer-resource interactions ultimately mediate the process of character displacement. 
As a consequence, the effects of character displacement on consumer-resource interactions and food-web dynamics have not been critically examined.
Here, I study a model of two consumers competing for two shared resources to examine how character displacement in consumers influences resource densities and the resilience of food webs to perturbations.
To test the generality of these effects, I examined them under different assumptions of evolutionary tradeoffs, consumer foraging behavior, and resource distributions.
My general finding was that, whenever character displacement increased the strength of consumer-resource interactions, it resulted in lower resource densities and less resilient food webs. 
Character displacement always strengthened consumer-resource interactions whenever consumers were competing for resources that occured in distinct habitats. 
This occurred under different evolutionary tradeoffs and in both simple and more realistic foraging scenarios.
While character displacement did not always increase the strength of consumer-resource interactions, these contingent effects only occurred under the simplest and least realistic foraging scenario. 
<!--In the simple ecological scenario that has been the focus of past models of character displacement (type 1 functional response and competing for resources in the same habitat), I find that the shape of the tradeoff can qualitatively affect the relationship between character displacement, resource densities, and food-web stability. 
Extensions of this model, ones that include other foraging scenarios with more realistic functional responses (e.g. saturating) and that reflect the biological reality that consumers are often more mobile than their resources, I find predictable effects of character displacement on resource densities and food-web stability.
Competition theory has generally shown that character displacement enhances consumer coexistence.
I show that this adaptive process comes at the ecological cost of making food webs less resilient to perturbations.  -->
Taken together, my results indicate that the adaptive process of character displacement often comes at the ecological cost of making food webs less resilient to perturbations. 
They also suggest that food-web and competition theory can give complimentary insights to the ecological consequences of adaptation. <!-- eco-evolutionary feedbacks -->

\newpage

# Introduction 

<!-- ECD is an important process, and current empirical and theoretical work suggests it often results in divergence of consumer foraging traits.-->

Ecological character displacement is thought to be a key evolutionary process generating biodiversity [@Schluter2000; @Pfennig2010; but see @Stuart2013]. Ecological character displacement describes the process of phenotypic evolution in a species generated or maintained by [exploitative] resource competition with one or more coexisting species [@Schluter2000]. Over the past 40 years, a large body of theoretical [e.g. @Lawlor1976; @Abrams1986; @Doebeli1996; @Taper1985] and empirical [reviewed in: @Schluter2000; @Dayan2005; @Stuart2013] work has been generated to understand the scenarios under which exploitative competition for resources leads to the divergence of consumer foraging traits. The general result emerging from these studies is that, if resources are nutritionally substitutable [@Abrams1987; @Fox2008] and there is no other strong source of density dependence acting on consumers [@Abrams1986], then resource competition drives the divergence of consumer foraging traits [@Lawlor1976; @Taper1985]. This process is not simply driven by ecological differences, but creates an eco-evolutionary feedback that drives further differentiation. This key insight was made by theoretical models that explicitly included resource dynamics as a mediator of competition in driving evolutionary change [@Lawlor1976; @Abrams1986; @Taper1985]. 

<!-- Ecological consequences of character displacement have received surprisingly little attention. In particular, prior work doesn't allow a proper comparision of the effects of character displacement on community stability.-->

Although explicit models of resources gave insights to the evolution of character displacement, the ecological feedback onto consumer-resource dynamics have received surprisingly little attention. 
This is likely because the ecological feedback has been primarily studied through the lens of competition and coexistence theory [@Lawlor1976; @Germain2018; @Bassar2017; @McPeek2019]. 
For example, early theoretical work by @Lawlor1976 showed that ecological character displacement promotes coexistence by favoring specialized consumers that experience reduced interspecific competition. 
<!--
On the other hand, specialization often increases a consumers ability to capture a specific resource.
From food-web theory, we know that increased feeding rates often lead to resource suppression, which if sufficient enough, can generate oscillations, and hence less stable, consumer-resource dynamics [Rosenzweig 1971; Murdoch et al. 2003; McCann 2011].
-->
Yet, this reduction in interspecific competition may, at the same time, increase the interspecific interaction between a consumer and the resource it specializes on.  
Both food-web theory and empirical studies have shown that increasing the strength of consumer-resource interactions often leads to resource suppression, which if sufficient enough, can generate oscillations, and hence less stable consumer-resource dynamics [@Rosenzweig1971; @Luckinbill1973; @Murdoch2002; @Murdoch2003; @McCann2011].
Thus, a food-web perspective, which accounts for both the direct and indirect effects of consumer-resource interactions, may yield new insight to the ecological consequences of character displacement.

<!--Thus, a consumer-resource perspective may yield new insight to the ecological feedback of character displacement on food-web dynamics. 
<!--Given that character displacement is mediated by a consumer-resource interaction, a food-web perspective may yield   NEED A LAST SENTENCE TO WRAP IT UP, HIGHLIGHTING HOW A FOOD-WEB PERSPECTIVE MAY YIELD NEW ECOLOGICAL INSIGHTS AND GIVE A CONTRASTING PERSPECTIVE TO COEXISTENCE THEORY. PERHAPS A I NEED TO INCLUDE A SENTENCE MID-WAY THROUGH SUGGESTING THAT A FOOD-WEB PERSPECTIVE MAY GIVE QUALITATIVELY DIFFERENT INSIGHTS. IT MAY BE NICE TO BRING IN THE SPATIAL COUPLING WORK OF MCCANN SUGGESTING THAT SPECIALIZATION CAN COUPLE FOOD-WEBS, BUT THIS WAS ONLY WITH ONE TOP PREDATOR (I.E. NO CONSUMERS...LOOK AT OLD TEXT FOR WORDING SUGGESTIONS.)-->

<!-- older idea...Write 3rd paragraph of intro, highlighting how the direct effects of character displacement, surprisingly, have been ignored. We are currently lacking insight to the relative importance of these direct and indirect effects of character displacement on community dynamics.

<!--
The role of character displacement in governing food-web dynamics remains unclear A food-web perspective, however, has been lacking from theoretical work on the ecological effects of character displacement. , thus the consequences of this process for food-web stabilit  

<!--
Despite the key insights made by explicit models of resource dynamics, 

gave key insights to the evolutionary dynamics of character displacement, the ecological effects on resources dynamics have received surprisingly little attention. Perhaps this is because the ecological dynamics have been studied primarily through the lens of competition and coexistence thoery

This oversight is unfortunate, given that the stability of consumer-resources is often closely tied with resource abundances.

Although character displacement is the result of an eco-evolutionary feedback, the ecological consequences of this process have received surprisingly little attention [@Germain2018]. Perhaps this is because early theoretical work suggested that character displacement was a potent stabilizing force in ecological communities [@Lawlor1976]. This ecological outcome is intuitive in light of competition theory ---character divergence reduces interspecific competition between consumers, promoting coexistence. On the other hand, specialization often enhances a consumers ability to capture a specific resource. A well known consequence of increased foraging efficiency (all else equal) is resource suppression, which if sufficient enough, can generate oscillations, and hence less stable, consumer-resource dynamics (Rosenzweig 1971; Murdoch et al. 2003; McCann 2011). 

Moreover, past inferences about the stabilizing effects of character displacement have only been made in communities where both consumers are present. However, I argue that inferences about the effect of character displacement, like the process itself, should only be made when comparing communities in the presence and absence of competition [criteria #3 for character displacement, @Schluter1992; @Schluter2000]. Therefore, the role of ecological character displacement in determining community stability remains unclear. 

<!--
However, inferences about the effect of character displacement, like the process itself, can only be made when comparing communities in the presence and absence of competition [criteria #3 for character displacement, @Schluter1992; @Schluter2000]. Current inferences about the stabilizing effects of consumer divergence are only comparisons about communities where there are two consumers, and even though, the focus is only on the stable coexistence of consumer species.

<!--
The consequence of this eco-evolutionary feedback for consumer coexistence has been well characterized (Lawlor and Smith 1976; Germain's work). Ecological character displacement has typically been considered to be a stabilizing factor in communities (Lawlor and Smith 1976). This is because divergence in foraging traits is thought to reduce the strength of interspecific competition between consumers. Reducing the strength of interspecific competition relative to intraspecific competition is a stabilizing force in consumer-resource systems. Consumer specialization on distinct resources suggests that there are niche differences between consumers. Mathematically, this is also often assumed to be the case, because using techniques such as evolutionary invasion analysis describe the ability for a consumer with a mutant allele to increase in abundance when rare, a demographic signature of niche differentiation. Therefore, if both consumers are able to invade when rare, then this suggests that they can coexist. 

Character displacement involves evolutionary shifts in character states in response to competition [@Schluter1992; @Schluter2000]. Theoretically, this is determined by comparing character changes in the presence and absence of a competitor. Empirically, this is determined by meeting several criteria that rule out other possible explanations [@Schluter1992; @Schluter2000]. Importantly, current inferences about the effect of character displacement on community stability do not meet this critera. For example, the inference that character displacement enhances species coexistence is only made in a scenario where consumers are competing. This type of stability is important, but it does not enable us to examine the effect of character displacement on community stability. As a consequence, I argue that the effect of character displacement on community stability remains an open question.

Of the prior models of character displacement, only @Lawlor1976 examine the effect of character displacement on the ecological stability of the system. They conducted a detailed theoretical analysis of three different metrics of stability: (i) stable coexistence of consumers, defined as the mutual invasibility of each consumer; (ii) global stability of consumers, defined as the continued coexistence of both consumers when resource dynamics are perturbed; and (iii) local stability, defined as the rate at which the four-species food web returned to equilibrium after a small perturbation to species abundances. Note that the first two metrics correspond to the stable coexistence of consumers, while the third metric measures the stability of the entire food web. @Lawlor1976 found that character displacement enhanced the stable coexistence of consumers, yet had a small negative effect on the local stability of the food web. 
@Lawlor1976's work gave fundamental insight to the effect of character displacement on ecological stability; however, none of their stability analyses compared food webs with and without a competing consumer. Such comparisons are necessary for inferring the effects of ecological character displacement, a point that has been made clear in the criteria to demonstrate character displacement (@Schluter2000; @Schluter1992). In fact, the first two metrics of stability can only be assessed when both consumers are present because it examines the effect of divergence on coexistence, which requires both consumers to be present. In contrast, local stability can be compared in food webs with and without a competing consumer, and thus provides a useful benchmark for examining the effects of character displacement on food-web stability.   


<!-- -> Another paragraph illustrating how the direct and indirect effects of character displacement likely have constrasting effects on stability. -->

<!--
Indeed, ecological character displacement often results in the evolution of characters that enhance a consumers ability to capture resources, which tends to destabilize consumer-resource interactions (Murdoch et al. 2003; McCann 2011). This occurs because increases in a consumers attack rate results in the resource being suppressed well below its carrying capacity, which if sufficient enough, can generate oscillations, and hence less stable, consumer-resource dynamics (Rosenzweig 1971; Murdoch et al. 2003). Experimental decreases in interaction strength between consumers and resources has been shown to promote coexistence between consumers and resources (Luckinbill 1973). Moreover, there is broad support that specialized consumers, since they are tightly coupled to their resources, tend to exhibit consumer-resource cycles, whereas this is not the case for generalists (Murdoch et al. 2002). Therefore, although evolutionary responses to exploitative competition may reduce the strength of interactions between consumers, they ultimately increase the strength of interactions with their resources which can destabilize the direct consumer-resource interaction (rather than the indirect consumer-consumer interaction). While prior models of character displacement have included more realistic functional responses and spatial relationships between consumers and resources, they have focused more on whether these factors alter patterns of character displacement rather than the effects of character displacement on the stability of the ecological community. As a consequence, it is currently unclear whether ecological character displacement has a net stabilizing or destabilizing effect on ecological communities.

<!-- Here we fill this knowledge gap. We focus on the ecological side of these dynamics, because the evolutionary aspects have been well characterized, although we show in the appendices that the evolutionary dynamics are as expected (especially for McCann model). -->

Here, I address this knowledge gap by building a mathematical model to examine how ecological character displacement affects consumer-resource dynamics in a food-web context. I address two questions: (1) How does ecological character displacement affect resource abundances? (2) How does character displacement affect food-web stability? To test the generality of these ecological effects, I examined three different foraging scenarios: *CONDENSE THIS. NO NEED TO GIVE ALL THE DETAILS YET. RIGHT NOW IT IS JUST CONFUSING.* (i) resources occur in the same habitat and consumers exhibit a linear functional response [e.g. @MacArthur1972; @Lawlor1976]; (ii) resources occur in different habitats and consumers exhibit a linear functional response [e.g. @Lawlor1976]; (iii) resources occur in distinct habitats and consumers exhibit a more realistic functional response [@McCann2005]. I also explore the contingency of these effects to different assumptions about evolutionary trade-offs in consumer foraging traits. I focus on the ecological side of these dynamics because the evolutionary aspects have been well characterized [@Lawlor1976; @Taper1985; @Abrams1986; @McPeek2019]. I show that the consequences of character displacement on food-web dynamics are not always intuitive and depend on the foraging scenario and tradeoff in consumer traits.


# Methods and Results

## Underlying Food-web Dynamics

<!-- Explanation of model parameters -->

To examine how ecological character displacement affects resource abundances and food-web stability<!--consumer-resource interactions and food-web dynamics-->, I analyzed a continuous-time model of two consumers ($C_1,C_2$) competing for two shared resources ($R_1,R_2$): 

$$\frac{dR_1}{dt}=r_1K_1(1-\frac{R_1}{K_1})-F_{11}(R_1)C_1-F_{21}(R_1)C_2,$$
$$\frac{dR_2}{dt}=r_2K_2(1-\frac{R_2}{K_2})-F_{12}(R_2)C_1-F_{22}(R_2)C_2,$$
$$\frac{dC_1}{dt}=e_{11}F_{11}(R_1)C_1+e_{12}F_{12}(R_2)C_1-m_1C_1,$$
$$\frac{dC_2}{dt}=e_{21}F_{21}(R_1)C_2+e_{22}F_{22}(R_2)C_2-m_2C_2,$$

where $r_i$ represents the intrinsic growth rate of resource $i$, $K_i$ represents the carrying capacity of resource $i$, $e_{ji}$ represents the conversion efficiency of resource $i$ into consumer $j$, and $m_j$ represents the mortality rate of consumer $j$. $F_{ji}(R_i)$ represents consumer $j$'s feeding rate (i.e. functional response) on resource $i$. This model is a useful characterization of a scenario where consumers compete for two distinct resources (e.g. zooplankton and benthic invertebrates) rather than if resources are better characterized by a continuous trait distribution (e.g. seed size, see @Taper1985 for an example). In the simplest scenario, consumers can forage for both resources simultaneously and their feeding rates increase linearly with resource density, such that $F_{ji}(R_i)=a_{ji}R_i$ where $a_{ji}$ is the attack rate of consumer $j$ on resource $i$ [@MacArthur1972]. The evolution of consumer attack rates in this model (and several extensions) have been analyzed in detail [@Lawlor1976; @Abrams1986], with the general result being divergent character displacement. I say consumers have undergone divergent character displacement if there evolved attack rates are more specialized, measured as $|\frac{a_{ii}}{a_{ii}+a_{ij}}-0.5|$, when evolving with a competing consumer. I focus here on the ecological consequences of this adaptive divergence.

<!-- Methods for assessing resource abundances and stability. -->

To investigate the ecological consequences, I studied the effect of adaptive divergence in consumers on resource densities and the stability of the entire food web at equilibrium. An equilibrium is reached when the four rates of change in the above equations are 0, and solving the system at this point gives equilibrium densities for each resource ($\hat R_1,\hat R_2$) and consumer ($\hat C_1,\hat C_2$). At the coexistence equilibrium (i.e., where $\hat R_1,\hat R_2, \hat C_1,\hat C_2 > 0$), I calculated resource densities and performed a linear stability analysis [@Otto2007]. This stability analysis derives the dominant (largest in absolute value) eigenvalue, $\lambda$, which determines whether (and how readily) the food web, when perturbed a small amount, will return to equilibrium (see supplementary material for derivation). Together, these two measures indicate how ecological character displacement affects resource densities and food-web stability.

<!-- Explain analytical methods -->

I examine the effects of character displacement on food-web dynamics by (i) deriving analytical expressions for the relationship between consumer attack rates and food-web dynamics and (ii) simulating the effects of competition on the eco-evolutionary dynamics of consumers and resources. To gain analytical insight, I assume that resources are equivalent ($r=r_1=r_2$ and $K=K_1=K_2$) as well as consumers ($e=e_{11}=e_{12}=e_{21}=e_{22}$; $m=m_1=m_2$), except that consumer attack rates are mirror images of each other ($a_{ii}=a_{11}=a_{22}$; $a_{ij}=a_{12}=a_{21}$). While this scenario is arguably simplistic, it allows me to isolate the effects of ecological character displacement. <!--, rather than any dependence on inherent asymmetries between consumers or resources.--> 

<!-- Explain simulations -->

To simulate eco-evolutionary dynamics, I used an Adaptive Dynamics approach. At each evolutionary time step, I created a mutant consumer by randomly choosing a consumer and modifying its attack rate on one resource by either subtracting or adding a small constant (0.001 in the following simulations) with equal probability. The mutant's attack rate on the other resource was determined by a tradeoff, such that $\big(a_{ii}/{A}\big)^n+\big(a_{ij}/{A}\big)^n=1$, where $A$ is the total investment in attack rates and $n$ describes the shape of the tradeoff [@Sargent2006]. This function has the useful property that it differentiates between cases where intermediate combinations of $a_{ii}$ and $a_{ij}$ are higher, on average, than the extremes (when $n>1$, green line in Fig. \ref{fig:MacArthur_Plot}A) or, conversely, where the two extremes are higher, on average, than intermediate investments (when $n<1$, orange line Fig. \ref{fig:MacArthur_Plot}A). When $n=1$, the tradeoff function is linear, and all combinations of $a_{ii}$ and $a_{ij}$ have the same total attack rate (blue line in Fig. \ref{fig:MacArthur_Plot}A). Assuming the mutant consumer was rare, I then determined whether the mutant had higher relative fitness than the resident consumer, and thus could invade and replace the resident consumer. If the mutant was able to invade, I updated the attack rate of the resident consumer to the mutant attack rate and allowed consumer and resource dynamics to reach a steady state. I then repeated the simulation up to 10,000 times, which was sufficient for consumers to either reach an evolutionary stable strategy [ESS, @Smith1973] or an evolutionary limit (e.g. $\frac{a_{ii}}{a_{ii}+a_{ij}}$ is constrained to a maximum of 1 and minimum of 0). 

<!-- Redundant, removing for now
In what follows, I examine the ecological consequences of character displacement under three different attack-rate tradeoffs (n>1, n=1, n<1) and in three different foraging scenarios: (i) resources occur in the same habitat and consumers exhibit a linear functional response (e.g. @MacArthur1972); (ii) resources occur in different habitats and consumers exhibit a linear functional response (e.g. @Lawlor1976); (iii) resources occur in distinct habitats and consumers exhibit a more realistic functional response [@McCann2005]. I show that the consequences of character displacement for food-web dynamics are not intuitive and depend critically on the foraging scenario and tradeoff in consumer attack rates. 
-->

```{r Tradeoff, include=FALSE, fig.pos="H", fig.cap="\\label{fig:Tradeoff}Tradeoff forms for consumer attack rates."}
initial_points <- bind_rows(params_2C_2R_MacArthur_linear, params_2C_2R_MacArthur_concaveDN, params_2C_2R_MacArthur_concaveUP) %>% mutate(n = c(n_linear, n_concaveDN, n_concaveUP))

tradeoff_plot <- bind_rows(concaveDN_df, linear_df, concaveUP_df) %>%
  ggplot(., aes(x=aii, y=aij, color = factor(n))) + 
  geom_line() + 
  geom_point(data = initial_points, aes(x=a11, y=a12)) +
  xlab(expression(a[ii])) +
  ylab(expression(a[ij])) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  

tradeoff_plot
```


## Consumers can forage for both resources simultaneously

<!-- Functional response equation and illustration of assumptions already given in previous section -->

<!-- Redundant, removing for now
The evolution of consumer attack rates in this model has been analyzed in detail [@Lawlor1976; @Abrams1986], with the general result being divergent character displacement. -->
When both consumers and resources are present, the density of resources at equilibrium are equivalent ($\hat R = \hat R_1 = \hat R_2$) and are determined by the following equation (derivation in supplementary material):

$$\hat{R}=\frac{1}{a_{ii}+a_{ij}}\cdot\frac{m}{e}$$
A key determinant of resource density in this model is the consumer's total attack rate, $a_{ii}+a_{ij}$. Therefore, the ecological consequences of character displacement depend on how the tradeoff influences the evolution of consumer attack rates.

My simulations show that the shape of the attack-rate tradeoff qualitatively affects the relationship between character displacement and resource density (Fig. \ref{fig:MacArthur_Plot}). For example, if consumer's are constrained by a linear tradeoff (blue lines), then there is no net change in total attack rate (Fig. \ref{fig:MacArthur_Plot}B) and character displacement has no effect on resource densities (Fig. \ref{fig:MacArthur_Plot}C). If the tradeoff is concave down (green lines), then resource abundances can actually increase under character displacement (Fig. \ref{fig:MacArthur_Plot}C). This is because the total attack rate of consumers is maximized at intermediate values ($a_{ii}=a_{ij}$) and decreases as consumers diverge (Fig. \ref{fig:MacArthur_Plot}B). When the tradeoff is concave up (orange lines), character displacement suppresses resource densities due to the increase in total attack rates (Fig. \ref{fig:MacArthur_Plot}B,C). Although the equation I derived for resource density was for the scenario where both consumers and both resources are present, it accurately predicts the density of resources when a single consumer reaches its ESS (triangles on respective colored lines in Fig. \ref{fig:MacArthur_Plot}C). This is because a single consumer evolves to be a generalist that has equal attack rates on each resource (triangles at 0.5 along x-axis in Fig. \ref{fig:MacArthur_Plot}B), resulting in equivalent resource densities. 

The effect of character displacement on resource density closely matches its impact on food-web stability (Fig. \ref{fig:MacArthur_Plot}D). For example, when character displacement results in resource suppression (orange), there is a corresponding decrease in stability. Similarly, if character displacement does not influence resource densities (blue), then there is no corresponding effect on stability. Curiously, this match between impact on resources and stability breakdowns with the concave down tradeoff (green). <!--This is not simply a consequence of having an additional consumer in the system, but emerges from the eco-evolutionary feedback between character displacement and resource suppression (Fig. \ref{fig:Stability}). The effect of this eco-evolutionary feedback can be seen by comparing initial (small points) with evolved strategies (large points). For example, when the tradeoff is concave up (orange points), the three-species system (small triangle) is initially more stable than the four-species system (small circle), but this relationship reverses by the time consumers reach their evolutionary stable strategy.-->

```{r MacArthur_Resources, include=FALSE, fig.cap="\\label{fig:MacArthur_Resources}Effect of character displacement on total attack rates (A) and resource densities (B) when consumers can forage for both resources simultaneously."}
Mac_attack <- ggplot(tradeoff_df, aes(x=aii/(aii+aij), y=aii+aij, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(MacArthur_displacements, Time=="End"), aes(x = a11/(a11+a12), y=a11+a12, fill=factor(n), shape=Competitor), size=3, color="white") + #, show.legend=FALSE) + size=5,
  geom_point(data = filter(MacArthur_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=a11+a12, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(expression(a[ii]+a[ij])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Mac_resources <- cbind.data.frame(select(tradeoff_df, n, aii, aij), MacArthur_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=R1+R2, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(MacArthur_displacements, Time=="End"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=3, color="white") + #, show.legend=FALSE) + size=5,
  geom_point(data = filter(MacArthur_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(expression(R[i]+R[j])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Mac_plots <- plot_grid(Mac_attack + theme(legend.position = "none"), Mac_resources, 
                       ncol=2, labels = "AUTO", rel_widths = c(0.65,1))
Mac_plots
```

```{r Stability, include=FALSE, fig.cap="\\label{fig:Stability}Effect of character displacement on local stability when consumers can (A) and cannot (B) forage for both resources simultaneously. Small and large points correspond to initial and evolved strategies, respectively."}
Stability_Mac <- cbind.data.frame(select(tradeoff_df, n, aii, aij), MacArthur_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=-1*max.Re.eigen, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(MacArthur_displacements, Time=="End"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=3, color="white", show.legend=FALSE) + #size=5,
  geom_point(data = filter(MacArthur_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  ylab(expression("Stability "(-lambda[max]))) + #ylab(expression(-1%*%"Re"(lambda[max]))) +
  scale_shape_manual(values=c(24,21))  +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  geom_hline(yintercept=0, linetype="dotted", color="grey") +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Stability_LS <- cbind.data.frame(select(tradeoff_df, n, aii, aij), LawlorSmith_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=-1*max.Re.eigen, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(LawlorSmith_displacements, Time=="End"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=3, color="white", show.legend=FALSE) +
  geom_point(data = filter(LawlorSmith_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  ylab(expression("Stability "(-lambda[max]))) + #ylab(expression(-1%*%"Re"(lambda[max]))) +
  scale_shape_manual(values=c(24,21))  +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  geom_hline(yintercept=0, linetype="dotted", color="grey") +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Stability_plots <- plot_grid(Stability_Mac + theme(legend.position = "none"), Stability_LS + theme( axis.title.y = element_blank()),
                             ncol = 2, labels = "AUTO", rel_widths = c(0.75,1))
Stability_plots
```

```{r MacArthur Model, include=FALSE}
plot_macarthur_model <- plot_grid(
  tradeoff_plot + theme(legend.position = "none"), 
  Mac_attack  + theme(legend.position = "none"), 
  Mac_resources  + theme(legend.position = "none"),
  Stability_Mac  + theme(legend.position = "none"), ncol=2, align='hv', labels = "AUTO")

save_plot(filename="Figure_ECD_MacArthur.pdf", plot=plot_macarthur_model, base_height = 6, base_width = 6)
```

```{r MacArthur_Plot, echo=FALSE, fig.pos="H", fig.cap="\\label{fig:MacArthur_Plot}**Effect of character displacement when consumers can forage for both resources simultaneously.** Panel (A) shows the different tradeoffs in consumer attack rates used in the simulation (green, *n* = 1.15; blue, *n* = 1; orange, *n* = 0.85). Panel (B) shows how the shape of this tradeoff affects the magnitude of character displacement and the evolution of total attack rates in the consumer community. Large circles (two consumers) and triangles (one consumer) correspond to the end points of the eco-evolutionary simulation. Panels (C) and (D) show how different tradeoffs indirectly affect total resource densities (C) and food-web stability (D). These simulations used the following parameter values: *r* = 1; *K* = 4; *e* = 0.8; *m* = 1; *A* = 2. We set an initial value of *a~ii~* = 1.2 and *a~ij~* depended on the value of *n*. We set initial consumer and resource abundances as: *R~i~* = *R~j~* = 2; *C~i~* = *C~j~* = 1."}
knitr::include_graphics("Figure_ECD_MacArthur.pdf")
```


## Consumers *cannot* forage for both resources simulanteously

<!-- Functional response equation and illustration of assumptions -->

The previous model, although the starting point for many models of competition, does not reflect many food webs where consumers are more mobile than their resources. In this scenario, consumer foraging behavior can link resources that occur in distinct habitats. The only character displacement model that I am aware of that modeled resources in different habitats was one examined by @Lawlor1976. This model takes the same form as the previous model, except now the consumer's feeding rate takes the form:

$$F_{ji}(R_i)=w_{ji}a_{ji}R_i$$

where $w_{ji}$ represents the proportion of time consumer $j$ spends foraging in a habitat where only resource $j$ is found (i.e. habitat preference). Note that since $w_{ji}$ is a proportion that $w_{jj}=1-w_{ji}$. As with attack rates, I assume that consumer habitat preferences are mirror images of each other ($w=w_{11}=w_{22}$). In @Lawlor1976's detailed evolutionary analysis of this model, they always observed divergent character displacement.

<!-- Effect on attack rates, resource densities, and stability -->

To examine the ecological consequences of this divergence, I again derive the equilibrium solution when both consumers and both resources are present. As before, resource densities are equivalent at this equilibrium ($\hat R = \hat R_1 = \hat R_2$ when both consumers and resources present), but are now determined by the following equation (derivation in supplementary material):

$$\hat{R}=\frac{1}{wa_{ii}+(1-w)a_{ij}}\cdot\frac{m}{e}$$

This equation implies that if consumers evolve to become specialists on resources that occur in their preferred habitat (e.g. $w>0.5$ and $a_{ii}>a_{ij}$), then the effective attack rate of consumers ($wa_{ii}+(1-w)a_{ij}$) will always increase, regardless of the tradeoff (Fig. \ref{fig:LS_Plot}A). Thus, character displacement always results in resource suppression if consumers are competing for resources that occur in different habitats (Fig. \ref{fig:LS_Plot}B). Note that the shape of the tradeoff can modify the effect of character displacement. This is not so much due to the tradeoff affecting the magnitude of displacement (it does, but the effect is minor), but because the form of the tradeoff affects resource abundances when a single consumer has reached its ESS (triangles in Fig. \ref{fig:LS_Plot}B). In contrast, resource densities reach a similar value when consumers evolve in the presence of a competitor (circles in Fig. \ref{fig:LS_Plot}B), because character displacement tends to reach a constraint of complete specialization. It is worth noting that in this foraging scenario, resource densities are consistently higher at the single consumer ESS compared to the predictions I derived for when both consumers are present (deviation of triangles from respective colored lines in Fig. \ref{fig:LS_Plot}B). This is likely because consumers actually evolve to be slightly specialized on the resources that occur in their non-preferred habitat (deviation of triangles from 0.5 along x-axis in Fig. \ref{fig:LS_Plot}B). <!-- I will revisit this subtle point when I examine the effects of character displacement on food-web stability. -->

As we saw previously, the effect of character displacement on resource densities qualitatively matches its negative effect on food-web stability (Fig. \ref{fig:LS_Plot}C). This is not simply a consequence of having an additional consumer in the system, but emerges from the eco-evolutionary feedback between character displacement and resource suppression (Fig. \ref{fig:LS_Plot}C). For example, when the tradeoff is concave up (orange), then the four-species (small circle) food web actually starts off as less stable than the three-species one (small triangle); however, the eco-evolutionary dynamics cause a switch in this pattern once they reach their evolutionary stable strategies (large points). 

```{r LS_Resources, include=FALSE, fig.cap="\\label{fig:LS_Resources}Effect of character displacement on effective attack rates (A) and resource densities (B) when consumers cannot forage for resources simultaneously."}
LS_attack <- ggplot(tradeoff_df, aes(x=aii/(aii+aij), y=wii*aii+wij*aij, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(LawlorSmith_displacements, Time=="End"), aes(x = a11/(a11+a12), y=w11*a11+w12*a12, fill=factor(n), shape=Competitor), size=3, color="white") + #, show.legend=FALSE) +
  geom_point(data = filter(LawlorSmith_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=w11*a11+w12*a12, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(expression(w*a[ii]+(1-w)*a[ij])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

LS_resources <- cbind.data.frame(select(tradeoff_df, n, aii, aij), LawlorSmith_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=R1+R2, color=factor(n))) + 
  geom_line() +
  geom_point(data = filter(LawlorSmith_displacements, Time=="End"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=3, color="white") + #, show.legend=FALSE) +
  geom_point(data = filter(LawlorSmith_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(expression(R[i]+R[j])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

LS_plots <- plot_grid(LS_attack + theme(legend.position = "none"), LS_resources, 
                      ncol=2, labels = "AUTO", rel_widths = c(0.65,1))
LS_plots
```

```{r LS Model, include=FALSE}
plot_LS_model <- plot_grid(
  #tradeoff_plot + theme(legend.position = "none"), 
  LS_attack  + theme(legend.position = "none"), 
  LS_resources  + theme(legend.position = "none"),
  Stability_LS  + theme(legend.position = "none"), ncol=2, align='hv', labels = "AUTO")

save_plot(filename="Figure_ECD_LS.pdf", plot=plot_LS_model, base_height = 6, base_width = 6)
```

```{r LS_Plot, echo=FALSE, fig.cap="\\label{fig:LS_Plot}**Effect of character displacement when consumers *cannot* forage for both resources simultaneously.** Different line colors correspond to different tradeoff values (green, *n* = 1.15; blue, *n* = 1; orange, *n* = 0.85). Large circles (two consumers) and triangles (one consumer) correspond to the end points of the eco-evolutionary simulation, whereas as small shapes correspond to the starting points (only in panel C). Panel (A) shows how, regardless of the tradeoff, character displacement increases the effective attack rate of the consumer community. This always resulted in a suppression of resource densities (B) and concomitant decrease in food-web stability (C). These simulations used the following parameter values: *r* = 1; *K* = 4; *e* = 0.8; *m* = 1; *A* = 2; *w~ii~*=0.6; *w~ij~*=0.4. We set an initial value of *a~ii~* = 1.2 and *a~ij~* depended on the value of *n*. We set initial consumer and resource abundances as: *R~i~* = *R~j~* = 2; *C~i~* = *C~j~* = 1."}
knitr::include_graphics("Figure_ECD_LS.pdf")
```

## Adding a more realistic functional response

<!-- Functional response equation and illustration of assumptions -->

So far I have only considered a simple functional response, where consumer feeding rates increase linearly with resource densities when foraging in either the same or distinct habitats. We know, however, that consumer feeding rates often saturate at high resource densities [@Holling1959; @Rosenzweig1963; @Murdoch2003; @McCann2011]. We also know that consumers do not usually spend a fixed proportion of time in a particular habitat, but their habitat preferences may be modified by resource densities [@McCann2005]. To account for these biological realities, I consider a more realistic functional response [derived by @McCann2005]:     

$$F_{ii}(R_i,R_j)=\frac{a_{ii}W_{ii}R_i}{1+a_{ii}hW_{ii}R_i+a_{ij}hW_{ij}R_j}$$

where consumer feeding rates on resource $i$ are influenced by both resource densities; saturate as resource densities increase (due to handling time $h$); and consumer habitat preferences are modified by relative resource densities, such that:

$$W_{ii}=\frac{wR_i}{wR_i+(1-w)R_j}$$ 

<!-- Effect on attack rates, resource densities, and stability -->

Even after adding more biological realism, I still observe the same qualitative relationship between character displacement and resource suppression (Fig. \ref{fig:McCann_Plot} in Appendix). This is because resource competition always leads to character divergence and equilibrium resource densities are governed by similar dynamics  (derivation in supplementary material):

$$\hat{R}=\frac{1}{wa_{ii}+(1-w)a_{ij}}\cdot\frac{m}{e-hm}$$

In the previous models, character displacement influences food-web stability, but all of the food webs ultimately return to a stable equlibrium (because $\lambda_{max}<0$). In this more realistic model, however, whether the food web is locally stable depends on the parameters of both consumers and resources. Specifically, <!--I conducted the previous simulations on a scenario where the food web remains locally stable ($\operatorname{Re}(\lambda_{max})<0$). Is it possible that character displacement would ever result in a locally unstable food web? To gain analytical insight to this question, I examined the conditions governing the local stability of the four-species food web when consumers exhibit a more realistic functional response (@McCann2005). I show that -->the four-species food web will transition from having a locally stable equilibrium to a limit cycle under the following conditions (derivation in supplementary material):

$$wa_{ii}+(1-w)a_{ij} > \frac{e+hm}{hK(e-hm)}$$

Previously, I showed that character displacement always increases the effective attack rate of consumers ($wa_{ii}+(1-w)a_{ij}$), regardless of the the shape of the tradeoff (Fig. \ref{fig:LS_Plot}A). Thus, character displacement always pushes the food web toward the boundary of local stability under this more realistic foraging scenario. <!--Whether or not the food web becomes locally unstable, however, depends on the choice of initial parameters.--> 

```{r McCann_Resources, include=FALSE, fig.cap="\\label{fig:McCann_Resources}Effect of character displacement on total attack rates (A) and resource densities (B) when consumers exhibit a more realistic functional response."}
McCann_attack <- ggplot(tradeoff_df, aes(x=aii/(aii+aij), y=wii*aii+wij*aij, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(McCann_displacements, Time=="End"), aes(x = a11/(a11+a12), y=w11*a11+w12*a12, fill=factor(n), shape=Competitor), size=3, color="white") + #, show.legend=FALSE) +
  geom_point(data = filter(McCann_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=w11*a11+w12*a12, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(expression(w*a[ii]+(1-w)*a[ij])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21))  +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

McCann_resources <- cbind.data.frame(select(tradeoff_df, n, aii, aij), McCann_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=R1+R2, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(McCann_displacements, Time=="End"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=3, color="white") + #, show.legend=FALSE) +
  geom_point(data = filter(McCann_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(expression(R[i]+R[j])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21))  +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

McCann_plots <- plot_grid(McCann_attack + theme(legend.position = "none"), McCann_resources, 
                          ncol=2, labels = "AUTO", rel_widths = c(0.65,1))
McCann_plots
```


```{r Stability_McCann, include=FALSE, fig.cap="\\label{fig:Stability_McCann}Effect of character displacement on local stability when consumers exhibit a more realistic functional response."}
Stability_McCann <- cbind.data.frame(select(tradeoff_df, n, aii, aij), McCann_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=-1*max.Re.eigen, color=factor(n))) + 
  geom_line() +
  geom_point(data = filter(McCann_displacements, Time=="End"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=3, color="white", show.legend = FALSE) +
  geom_point(data = filter(McCann_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  ylab(expression("Stability "(-lambda[max]))) + #ylab(expression(-1%*%"Re"(lambda[max]))) +
  scale_shape_manual(values=c(24,21))  +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  geom_hline(yintercept=0, linetype="dotted", color="grey") +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Stability_McCann
```

```{r McCann Model, include=FALSE}
plot_McCann_model <- plot_grid(
  #tradeoff_plot + theme(legend.position = "none"), 
  McCann_attack  + theme(legend.position = "none"), 
  McCann_resources  + theme(legend.position = "none"),
  Stability_McCann  + theme(legend.position = "none"), ncol=2, align='hv', labels = "AUTO")

save_plot(filename="Figure_ECD_McCann.pdf", plot=plot_McCann_model, base_height = 6, base_width = 6)
```

```{r McCann_Plot, echo=FALSE, fig.cap="\\label{fig:McCann_Plot}**Effect of character displacement when consumers exhibit a more realistic functional response.** Different line colors correspond to different tradeoff values (green, *n* = 1.15; blue, *n* = 1; orange, *n* = 0.85). Large circles (two consumers) and triangles (one consumer) correspond to the end points of the eco-evolutionary simulation, whereas as small shapes correspond to the starting points (only in panel C). Panel (A) shows how, regardless of the tradeoff, character displacement increases the effective attack rate of the consumer community. This always resulted in a suppression of resource densities (B) and concomitant decrease in food-web stability (C). These simulations used the following parameter values: *r* = 1; *K* = 4; *e* = 0.8; *m* = 1; *A* = 2; *w~ii~*=0.6, *w~ij~*=0.4. We set an initial value of *a~ii~* = 1.2 and *a~ij~* depended on the value of *n*. We set initial consumer and resource abundances as: *R~i~* = *R~j~* = 2; *C~i~* = *C~j~* = 1."}
knitr::include_graphics("Figure_ECD_McCann.pdf")
```

## Robustness to consumer asymmetry

The previous analytical results and simulations make a strong assumption that competing consumers start off as perfect mirror images of each other in their attack rates (i.e. symmetry). Yet, the theory presented here and in past work indicates that there would likely be a predictable asymmetry between consumers. This predictable asymmetry emerges from a process of community assembly where a single consumer invades a system, reaches an ESS (as a generalist), followed by the invasion of a second, more specialized, consumer. This theoretical scenario has also been hypothesized as the sequence of events leading to character displacement in threespine stickleback inhabiting lakes of coastal British Columbia, Canada [@Schluter1992; @Schluter2000].

To test whether our results were robust to this likely asymmetry, we used the evolved attack rates at the end of the one consumer simulations as the starting values for the competitor in the two consumer simulations. 
We did this for all foraging scenarios and tradeoffs previously examined. <!--As expected, consumer asymmetry resulted in different ecological conditions (\ref{fig:MacArthur_Plot_asymm}B,C, \ref{fig:LS_Plot_asymm}B,C, \ref{fig:McCann_Plot_asymm}B,C). This is evident by seeing the deviations in the small circles (initial two consumers) from the lines that map the resource and stability dynamics of a symmetric two consumer system. Despite these initial differences, the system-->
We found that our previous inferences were robust to including consumer asymmetry across different tradeoffs and foraging scenarios (\ref{fig:MacArthur_Plot_asymm}, \ref{fig:LS_Plot_asymm}, \ref{fig:McCann_Plot_asymm}).


# Discussion

<!-- Summarize key findings -->

<!--
Our results suggest that qualitative predictions about the effect of character displacement on food-web dynamics can be made from knowledge of evolutionary constraints/tradeoffs in attack rates as well as consumer foraging behavior. 
For all of the tradeoffs and foraging scenarios we examined, competition drives divergence in consumer foraging traits.
Yet, these different ecological and evolutionary constraints sometimes lead to qualitatively different effects on resources densities and food-web stability. 
Specifically, the shape of the tradeoff resulted in qualitatively different relationships between character displacement and food-web dynamics in the foraging scenario most frequently examined in past models of the evolution of character displacement. 
However, in a foraging scenario that is likely more common in nature, where mobile consumers compete for resources that occured in distinct habitats, character displacement suppressed resource densities and resulted in less stable food webs. 
Taken together, our results illustrate how a food-web perspective can give novel insight to an eco-evolutionary process that appears common in nature [@Schluter2000; @Pfennig2010; but see @Stuart2013].
-->

My results suggest that a revision is needed for one of the criteria used to demonstrate character displacement. 
Criteria #5 in @Schluter1992 states: "Sites of sympatry and allopatry should not differ greatly in food, ...". 
In contrast, my results show that character displacement leads to predictable differences in food (resource) availability and even food-web stability.
Specifically, I found<!--My general finding was--> that, whenever character displacement increased the effective attack rate of consumers, it resulted in lower resource densities and less resilient food webs. 
Character displacement always increased attack rates whenever consumers were competing for resources that occured in distinct habitats. 
This occurred under different evolutionary tradeoffs and in both simple and more realistic foraging scenarios.
Although character displacement did not always increase effective attack rates, these contingent effects only occurred under the simplest and (arguably) least realistic foraging scenario. 
My study takes advantage of past work showing that adaptive divergence in consumer attack rates is always favored under the scenarios examined here [@LawlorSmith1976; @Abrams1986].
Taken together, my results indicate that the adaptive process of character displacement often comes at the ecological cost of making food webs less resilient to perturbations. 

<!-- Influence of tradeoff shape and application to natural systems -->

The simplest foraging scenario examined here (linear functional response on resources occuring in the same habitat) is the foundation of mechanistic models of resource competition [@MacArthur1972; @Lawlor1976; @Abrams1986]<!--substitutable resources-->. 
<!--Under this scenario, character displacement either results in no change in food-web dynamics or a decrease in both resource densities and stability.-->
Under this scenario, it is theoretically possible that character displacement results in increased resource densities<!-- and food-web stability--> [green lines in \ref{fig:MacArthur_Plot}].
This only occurs, however, under an evolutionary tradeoff that constrains the magnitude of character displacement.
This suggests that it would be unlikely to ever observe divergent character displacement and increases in resource densities in a real system. 
In contrast, the evolutionary tradeoff that favors character displacement the most decreased resource densities<!-- and food-web stability-->. 
Although data on the shape of the tradeoff in consumer foraging traits is scarce, two classic examples of character displacement, Darwin's finches and threespine stickleback, both appear to exhibit a tradeoff where extreme trait values increase the foraging rate of consumers (orange lines in \ref{fig:MacArthur_Plot}A,B). 
This is evident by the disruptive selection observed for beak size/shape in Darwin's finches [@Schluter1985] and benthic/limnetic ecotypes for stickleback [@Arnegard2014] in resource-limited environments. 
Taken together, my model predicts that even in the simplest foraging scenario, the most likely relationship we would observe in nature is for food webs where consumers have undergone character displacement to have lower total resource densites<!-- and be less resilient to perturbations-->.

<!--
In this scenario, the shape of the evolutionary tradeoff in attack rates qualitatively affected the relationship between character displacement and food-web dynamics. 
In theory, resource densities and food-web stability can even be higher under character displacement if intermediate combinations of attack rates are higher than the extremes [green lines in \ref{fig:MacArthur_Plot}].
But the magnitude of character displacement in this scenario is quite small, resulting in negligible increases in resource densities and food-web stability.
Therefore, my models suggest that it would be highly unlikely to ever observe an increase in resource densities in natural settings, although zero or negligible change is possible (under certain constraints).

, although it is a simplistic representation of consumer-resource interactions [@Rosenzweig1963; @McCann2005; @McCann2011]

Although the shape of the tradeoff could qualitatively change the relationships between character displacement and food-web dynamics, I do not expect this to be common in real ecosystems. 
This is because these distinct effects only occur in a foraging scenario that I expect is uncommon in nature (linear functional response of consumers competiting for resources in the same habitat). 
It was still important to examine this scenario, however, as it is the basis of most theoretical models that explicitly model resource dynamics in competition [@MacArthur1972; @Lawlor1976; @Abrams1986]. 
Even if we suspend our disbelief (for the moment) about the reality of the foraging situation, I expect that we would only be able to detect two effects of character displacement on food-web dynamics: no change in resource densities or stability; or decrease in resource densities and stability. 
I expect it would be unlikely to ever observe an increase in resource densities under character displacement, although its theoretical plausible (fig. \ref{fig:MacArthur_Plot}A). 
This is because the concave down tradeoff does not favor strong divergence, and thus there is little potential for an increase in resource densities.
It is unclear to me which tradeoff shape is most common in nature. Of the two examples I found, there appears to be a concave up tradeoff in consumer foraging traits for two classic examples of character displacement: threespine stickleback in coastal lakes of British Columbia [@Arnegard2014] and Darwin's finches on the Galapagos islands [@Schluter1985]. 
A concave up tradeoff favors greater divergence, and thus is also the most likely evolutionary scenario to result in detectable character displacment.
The shape of the tradeoff becomes evident from examining the form of natural selection on consumer traits in the absence of interspecific competition and when resources were limiting. 
Specifically, in both systems there is evidence for disruptive selection (favoring extreme phenotypes) in environments with a broad spectrum of resources present, but where resources are ultimately limiting.
Note that while this gives insight to the shape of the tradeoff, it does not give insight to the evolutionary dynamics of the system. 
This is because, in the absence of interspecific competition, resource densities are the key determinant of consumer evolution (see supplementary material). 
This is because even if specialization on one resource is favored in the short-term, the other resource will increase in density, favoring consumer to evolve traits that better exploit the other resource. 
Thus, there is an eco-evolutionary feedback that eventually favors an intermediate phenotype that is able to best take advantage of both resources (fig. \ref{fig:MacArthur_Plot}C).
Based on the shape of their tradeoffs alone, I would predict character displacement in both of these systems to decrease total resource densities. I expect this prediction to hold particularly well for threespine stickleback, where the food-web dynamics more closely mimic this model (competition for two distinct resources, rather than competition along a continuous trait distribution, seeds for Darwin's finches).
Whether this translates into a detectable effect on food-web stability is difficult, but if does occur, I would expect it to be more likely in threespine stickleback. 
This is because there tends to be less of a stoichiometric mismatch between consumers and their resources in aquatic vs. terrestrial ecosystems. 
This means that energy transfer is more efficient to upper trophic levels, which creates more top-heavy food webs (cite McCann's work) that are less stable. 
-->

<!-- Influence of foraging scenario and application to natural systems -->
A general result emerging from our analysis was that, when consumers were competing for resources in distinct habitats, character displacement always supressed resource densities. <!--, regardless of the functional form of the consumer's feeding rate or shape of the tradeoff.-->
Consumers are generally larger, and as a result, more mobile than their resources; thus, their foraging behavior acts to couple resource dynamics across traditional habitat boundaries [@McCann2005].
<!--A disproporationate number of the documented cases of character displacement involve carnivores [@Schluter2000] that are larger, and as a result, often more mobile than their resources [@McCann2005].-->
An example of character displacement that matches this foraging scenario is threespine stickleback in postglacial lakes of British Columbia, Canada [@Schluter1992; @Schluter2000].
In these lakes, stickleback have undergone character displacement into limnetic and benthic species that have evolved specialized traits to forage on zooplankton and benthic invertebrates, respectively.
These resources occur in distinct zones of the lake (pelagic and littoral) and stickleback move between these zones when foraging for resources. 
The theory developed here predicts that total resource densities will be lower in lakes where stickleback have undergone character displacement compared to nearby lakes with only a single, generalist species.
A disproporationate number of the documented cases of character displacement involve carnivores that are larger, and likely more mobile, than their resources [@Schluter2000],
Therefore, my predictions may apply to many cases of ecological character displacement.

Character displacement is far from an all-or-nothing process, but may vary in its magnitude [@Schluter2000]. 
My results suggest that the magnitude of character displacement will be negatively correlated with total resource densities, at least when resources occur in distinct habitats (line trajectories in \ref{fig:LS_Plot}B, \ref{fig:McCann_Plot}B).
This prediction could be test either experimentally, by putting populations that vary in divergence in a common resource setting, or with field data that statistically controls for other factors affecting resources.
Note though, this prediction will only apply to comparisons within species where there is likely little difference in the shape of the tradeoff among populations.

<!-- Food-web stability -->
My most striking result was that character displacement, when examined through the lens of food-web theory, generally resulted in less stable food webs. 
In fact, under a foraging scenario that incorporates more biological realism, character displacement may even result in an unstable food web. 
This result aligns well with the general finding from food-web theory that stability tends to go hand-in-hand with resource abundances [@May1973; @Murdoch2003; @McCann2011]. 
Yet, this result contrasts the notion from competition theory that character displacement contributes to species coexistence. 
My results do not necessarily contradict these past inferences, as competition theory uses a different measure of stability that considers the ability of a consumer with a different phenotype to invade when rare [invasion criteria, @Chesson2000]. 
Instead, my results highlight that stability measures do not always go hand-in-hand [@Donohue2013; @Donohue2016].
A more pluralistic view of stability is likely needed for understanding the consequences of eco-evolutionary feedbacks in a food-web context.

<!-- But talk about the competition inference, and how it may not allow a proper view of how ecological character displacement affects stability, because it also does not compare the scenarios. For example, convergence is clearly favored in the absence of a competitor. It also doesn't account for the stability of the fully coupled food web that includes resources, which we know is a key contribute to the dynamics of ecological character displacement -->

<!-- Ghost of competition and stability past --->
A single species of threespine stickleback lives in hundreds of lakes of British Columbia, but the species pairs, where character displacement has happened, are only known from four lakes one of which has undergone reverse speciation [@Rudman2016]. 
Our results hint at an interesting hypothesis for the apparent rarity, namely founded on ecological stability [@Borrelli2015a; @Borrelli2015b]. 
Specifically, the commonness of the lakes with only a single species is due to the higher ecological stability of this food-web structure, compared to the one with a species pair. 
Testing this hypothesis may be quite difficult, but it could be possible with recent advances in genomics. 
For example, the species-pair lake that has undergone reverse speciation has a different ecological impact than other generalist lakes in that it is much more like the benthic-ecotype in its morphology. It is unclear whether this is a transient or persistent evolutionary state. 
But advances in genomics may be able to tease apart whether a currently generalist species had a genomic imprint of being more benthic or limnetic. 

<!-- Predictions for a natural system -->
Drawing on the theory I developed, I can point to systems where we would expect character displacement to result in less stable food webs. 
My theory suggests that this may be more likely to occur when character displacement occurs between: (i) consumers foraging in distinct habitats; (ii) exhibit concave-up tradeoff in attack rates; and (iii) in aquatic systems. 
Aquatic systems are more likely because its been shown that attack rates are often much stronger in these systems [@Rip2011]. 
This lower baseline, means that it is easier for character displacement to push these systems toward the boundary of local stability. 
Interestingly, one of the hallmark examples of character displacement, threespine stickleback, meets these criteria. Thus, I predict that in the coastal lakes of British Columbia, where stickleback have undergone character displacement, for these food webs to exhibit less stable dynamics and more variable population abundances. 
Although stability is a traditionally thorny issue to measure, there are now clear theoretical links between the stability measure we used here ($-\lambda_{\text{max}}$) and the coefficient of variation (CV), which simply measures the variability in a dynamic time series relative to the mean. 
Also, there are now methods for assessing the dynamics of natural communities that link to these theoretical stability measures [@Ives2003]. Now it just requires the effort to collect this data. 
Also, in applying this theory to a natural system, an assessment of stability for a specific system requires a realistic model of the population and community dynamics. e.g. stage-structure,...Still, our results point toward a general tendency toward instability. 

It's entirely plausible though that the some aspects of the system, e.g. stage structure could prevent this instability. This could be quite interesting, as this may point to systems where we are more likely to observe character displacement, because it enhances their stability.

It may be quite common for character displacement to result in less stable food webs. Recent theory has shown that consumer divergence and specialization on resources happens more readily when either: higher productivity, low structural complexity of habitat, and weak influences of stressors [@McPeek2019]. In our model, this corresponds to higher values of *K*, higher values of *A*, and lower values of *m*. In other words, this recent theory shows that the magnitude of consumer divergence happens in highly productive habitats, where consumers can easily find and consume their prey, and there is low consumer mortality. The first situation can lead to the "paradox of enrichment" [@Rosenzweig1971], where higher productivity, all else equal, can decrease food-web stability due to consumers suppressing resources more below their carrying capacity. The other factors, maximum attack rate and consumer mortality, also have predictable effects on the stability of the system [@Rip2011; @McCann2011]. For example, increases in attack rate, as we observed in our model, decreases food-web stability. Similarly, lower mortality increases enables consumers to have a higher impact on their resources. All of these result from the general tendency of for any biological mechanism that increases the strength of interspecific interactions relative to the strength of intraspecific interactions acts to destabilize consumer-resource dynamics [@Chesson2008; @Rip2011; @McCann2011]. Mathematically, this happens when their is an imaginary eigenvalue of the system, which puts some "spin" on the system. Otherwise, biological mechanisms that enhance interaction strength can be initially stabilizing, if the consumer is poorly adapted to foraging on the available resources (see first parts of stability figures).  

<!-- Caveats -->
An advantage of the Adaptive Dynamics approach is that we could examine the ecological dynamics of the system. Current consumer-resource models based on quantitative genetics become quickly intractable to gain analytical insight from, even for simple linear functional responses of consumers [@McPeek2019]. Those approaches have clear advantages in that they explicitly model a quantitative trait, which then influences the ecological rates (*r, K, A, e, m*, etc.). Our approach assumes that there is a one-to-one correspondence between trait evolution and the ecological rate. This simplifying assumption, however, allowed us to explore a much more realistic biological scenario and still gain analytical insight. This necessary tradeoff was worth it, we feel, because we were interested in the ecological consequences of character displacement, rather than in identifying the conditions resulting in character displacement and that alter the magnitude, as excellent work has already been done on this front [e.g. @Lawlor1976; @Abrams1986; @Doebeli1996; @Taper1985; @McPeek2019].

Although I used an Adaptive Dynamics approach here, I expect that these theoretical predictions would apply to models that assumed a different genetic architecture of attack rates (e.g. quantitative genetics). 
I expect this because, time and time again, models that explicitly include resource dynamics inevitably show that resource competition results in divergent character displacement, regardless of the genetic architecture of traits [see synthesis by @Taper1985]. 
Since these models are focused primarily on trait evolution, it is not clear that divergence in these models would have different ecological effects.
In fact, recent work by @McPeek2019 has shown that genetic divergence in a quantitative genetics model can lead to decreased resource abundances and unstable dynamics.
Finally, my conclusions may only apply to biological resources that are nutritionally substitutable. 
It would be interesting to extend these current analyses to non-substitutable resources where convergent character displacement is expected [@Abrams1987; @Fox2008].

While the underlying genetics of trait evolution may influence the amount of divergence in character displacement, this should not influence the effect of that trait evolution on the consumer-resource dynamics. Another way our results may quantitatively differ from a quantitative genetic model is that there is no intraspecific variation in our approach. While this may certainly have quantitative effects on the relationship between character displacement and food-web dynamics, or more likely, influence the magnitude of displacement [@McPeek2019], it is unclear whether this would qualitatively influence our inferences.  

Throughout, I have also setup a special case scenario where consumers are mirror images of each other. This resulted in symmetric character displacement, which is quite common in empirical data [@Schluter2000]. Again though, I do not expect that adding mild asymmetries (ones that still would permit coexistence) would qualitatively change our results. This is because, again, divergent character displacement is still evident in these models. Also, we conducted simulations to test whether our results were robust to this assumption and they were (ADD SUPPLEMENTARY MATERIAL).


<!-- older cut and pasted 

I find that the foraging scenario qualitatively affects the relationship between character displacement and resource densities.

Most models of character displacement have assumed a scenario where consumers can forage for both resources simultaneously [e.g. @Taper1985; @Abrams1986]. This assumption may be valid for some foraging scenarios (e.g. Darwin's finches foraging for seeds); however, in many situations consumers forage for resources that occur in different habitats, and thus cannot forage for both simultaneously [@McCann2005]. 

The effect of the foraging scenario on the relationship between character displacement and resource densities appears to be quite general.

Note that detecting this effect in nature would likely be difficult, since a concave-down tradeoff results in relatively small displacement relative to other tradeoff shapes (@Lawlor1976; green points in Fig. \ref{fig:MacArthur_Resources}A,B).

Previous work has shown that consumers undergo divergent character displacement regardless of the shape of the tradeoff (@Lawlor1976; @Abrams1986). 

Important point: Criteria 5 in @Schluter1992 does not make sense since character displacement usually alters resource distributions. Think about this more.

<!-- This more realistic consumer functional response does actually make an interesting evolutionary prediction that differs from the scenario where consumer feeding rate scales linearly with resource density. Specifically, a consumer's ESS in the absence of competition will remain slightly more specialized on the resources that occur in their preferred habitats. This is in contrast to the prediction when feeding rates scale linearly with resource density, where consumers evolve to be slightly more specialized on resources occurring in their non-preferred habitats. An important caveat for these predictions is that my model does not allow habitat preferences to evolve, which would likely alter these predictions. 

@Lawlor1976 found that consumers still underwent divergent character displacement regardless of whether consumers could or could not forage for resources simultaneously. 


In general, I find that resource supression goes hand-in-hand with local stability, a tendency that has been noted by others (@Murdoch2003; @McCann2011). 

<!-- Looking for this effect in nature 

The scenario where the relationship between character displacement and resource suppression is the strongest is when the tradeoff in attack rates is concave-up and consumers are competing for resources that occur in different habitats (orange points in Fig. \ref{fig:LS_Resources}B and Fig. \ref{fig:McCann_Resources}B). Prior work in threespine stickleback suggests that the evolution of stickleback attack rates are constrained by a concave-up tradeoff (@Schluter1993; @Arnegard2014) and that stickleback ecotypes are competing for resources that occur in different habitats (benthic vs. limnetic, @Schluter1992). Thus, I predict that ecological character displacement in sticklebacks would suppress resource densities and decrease local stability. 

While measuring resource densities is relatively straightforward, measuring stability is notoriously difficult. One of the more easy to acquire empirical metrics of stability is the coefficient of variation ($CV=\frac{\sigma}{\mu}$) as this only requires measurements of resource (or consumer) densities over time. Interestingly, there is a close correspondence between the coefficient of variation and the local stability of a food web (@Gellner2016). <!-- This close correspondence emerges from the fact that stochastic perturbations in resource (or consumer) densities will determine the variability in abundances. And since food webs are constantly buffeted by stochastic processes in the real world, I expect that my predictions using local stability would correspond to the $CV$ of resources (or consumers). Thus, I predict that character displacement in threespine stickleback will increase the $CV$ of resource (or consumer) densities.

Consumer and resource densities in these dynamical models can be interpreted from either a population or biomass perspective (@Yodzis1992; @Murdoch2003; @McCann2011). For the stickleback system, you have data on seasonal dynamics of resources in terms of both abundances and biomass. Within a season, I do not expect stickleback abundances to be coupled to the abundances of zooplankton and benthic invertebrates, given that stickleback reproduce annually whereas zooplankton and benthic invertebrates can reproduce many times within a season. Instead, I expect that stickleback biomass will be coupled to the biomass of zooplankton and benthic invertebrates within a season. This is because there will be lots of young stickleback at the beginning of the season, and they will eat a lot of resources and grow in size as the season progresses. If this is true, I also expect to see the largest negative effect of stickleback on resource densities late in the season.   
-->

# Acknowledgements

The content of this paper was greatly enhanced by numerous conversations with Seth Rudman. Sally Otto provided much help in early analyses of the mathematical model and I would not have been able to take the theory as far as I did without her guidance and encouragement. A discussion with Ben Gilbert pushed me to take a comparative approach that looked across different foraging scenarios to examine the generality of my conclusions. Discussions with Dolph Schluter pushed me to also to take a comparative approach that better set my results in the context of past theory on character displacement.

# Supplementary Material

```{r MacArthur_asymm, include=FALSE}
# replaced MacArthur_displacements with MacArthur_displacements_asymm

Mac_attack_asymm <- ggplot(tradeoff_df, aes(x=aii/(aii+aij), y=aii+aij, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(MacArthur_displacements_asymm, Time=="End"), aes(x = a11/(a11+a12), y=a11+a12, fill=factor(n), shape=Competitor), size=3, color="white") + #, show.legend=FALSE) + size=5,
  geom_point(data = filter(MacArthur_displacements_asymm, Time=="Begin"), aes(x = a11/(a11+a12), y=a11+a12, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(expression(a[ii]+a[ij])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Mac_resources_asymm <- cbind.data.frame(select(tradeoff_df, n, aii, aij), MacArthur_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=R1+R2, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(MacArthur_displacements_asymm, Time=="End"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=3, color="white") + #, show.legend=FALSE) + size=5,
  geom_point(data = filter(MacArthur_displacements_asymm, Time=="Begin"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(expression(R[i]+R[j])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Stability_Mac_asymm <- cbind.data.frame(select(tradeoff_df, n, aii, aij), MacArthur_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=-1*max.Re.eigen, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(MacArthur_displacements_asymm, Time=="End"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=3, color="white", show.legend=FALSE) + #size=5,
  geom_point(data = filter(MacArthur_displacements_asymm, Time=="Begin"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  ylab(expression("Stability "(-lambda[max]))) + #ylab(expression(-1%*%"Re"(lambda[max]))) +
  scale_shape_manual(values=c(24,21))  +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  geom_hline(yintercept=0, linetype="dotted", color="grey") +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Mac_plots_asymm <- plot_grid(Mac_attack_asymm + theme(legend.position = "none"), 
                             Mac_resources_asymm + theme(legend.position = "none"), 
                             Stability_Mac_asymm + theme(legend.position = "none"), 
                       ncol=2, labels = "AUTO", align = 'hv')
Mac_plots_asymm

save_plot(filename="Figure_ECD_MacArthur_asymm.pdf", plot=Mac_plots_asymm, base_height = 6, base_width = 6)
```

```{r MacArthur_Plot_asymm, echo=FALSE, fig.pos="H", fig.cap="\\label{fig:MacArthur_Plot_asymm}**Effect of character displacement when consumers can forage for both resources simultaneously and have an asymmetry in initial attack rates.** Different line colors correspond to different tradeoff values (green, *n* = 1.15; blue, *n* = 1; orange, *n* = 0.85). Large circles (two consumers) and triangles (one consumer) correspond to the end points of the eco-evolutionary simulation, whereas as small shapes correspond to the starting points. Panel (A) shows how the shape of this tradeoff affects the magnitude of character displacement and the evolution of total attack rates in the consumer community. Panels (B) and (C) show how different tradeoffs indirectly affect total resource densities (B) and food-web stability (C). These simulations used the following parameter values: *r* = 1; *K* = 4; *e* = 0.8; *m* = 1; *A* = 2. We set an initial value of *a~ii~* = 1.2 and *a~ij~* depended on the value of *n*. To create an asymmetry in initial attack rates, we used the ending *a~ii~* and *a~ij~* values for the one consumer simulation as the starting values for *C~2~* in the two consumer simulation. We set initial consumer and resource abundances as: *R~i~* = *R~j~* = 2; *C~i~* = *C~j~* = 1."}
knitr::include_graphics("Figure_ECD_MacArthur_asymm.pdf")
```

```{r LawlorSmith_asymm, include=FALSE}
# replaced LawlorSmith_displacements with LawlorSmith_displacements_asymm

LS_attack_asymm <- ggplot(tradeoff_df, aes(x=aii/(aii+aij), y=wii*aii+wij*aij, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(LawlorSmith_displacements_asymm, Time=="End"), aes(x = a11/(a11+a12), y=w11*a11+w12*a12, fill=factor(n), shape=Competitor), size=3, color="white") + #, show.legend=FALSE) + size=5,
  geom_point(data = filter(LawlorSmith_displacements_asymm, Time=="Begin"), aes(x = a11/(a11+a12), y=w11*a11+w12*a12, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(expression(w*a[ii]+(1-w)*a[ij])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

LS_resources_asymm <- cbind.data.frame(select(tradeoff_df, n, aii, aij), LawlorSmith_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=R1+R2, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(LawlorSmith_displacements_asymm, Time=="End"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=3, color="white") + #, show.legend=FALSE) + size=5,
  geom_point(data = filter(LawlorSmith_displacements_asymm, Time=="Begin"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(expression(R[i]+R[j])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Stability_LS_asymm <- cbind.data.frame(select(tradeoff_df, n, aii, aij), LawlorSmith_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=-1*max.Re.eigen, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(LawlorSmith_displacements_asymm, Time=="End"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=3, color="white", show.legend=FALSE) + #size=5,
  geom_point(data = filter(LawlorSmith_displacements_asymm, Time=="Begin"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  ylab(expression("Stability "(-lambda[max]))) + #ylab(expression(-1%*%"Re"(lambda[max]))) +
  scale_shape_manual(values=c(24,21))  +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  geom_hline(yintercept=0, linetype="dotted", color="grey") +
  guides(fill = guide_legend(override.aes=list(shape=21)))

LS_plots_asymm <- plot_grid(LS_attack_asymm + theme(legend.position = "none"), 
                             LS_resources_asymm + theme(legend.position = "none"), 
                             Stability_LS_asymm + theme(legend.position = "none"), 
                       ncol=2, labels = "AUTO", align='hv')
LS_plots_asymm

save_plot(filename="Figure_ECD_LS_asymm.pdf", plot=LS_plots_asymm, base_height = 6, base_width = 6)
```

```{r LS_Plot_asymm, echo=FALSE, fig.cap="\\label{fig:LS_Plot_asymm}**Effect of character displacement when consumers *cannot* forage for both resources simultaneously and have an asymmetry in initial attack rates.** Different line colors correspond to different tradeoff values (green, *n* = 1.15; blue, *n* = 1; orange, *n* = 0.85). Large circles (two consumers) and triangles (one consumer) correspond to the end points of the eco-evolutionary simulation, whereas as small shapes correspond to the starting points. Panel (A) shows how, regardless of the tradeoff, character displacement increases the effective attack rate of the consumer community. This always resulted in a suppression of resource densities (B) and concomitant decrease in food-web stability (C). These simulations used the following parameter values: *r* = 1; *K* = 4; *e* = 0.8; *m* = 1; *A* = 2; *w~ii~*=0.6, *w~ij~*=0.4. We set an initial value of *a~ii~* = 1.2 and *a~ij~* depended on the value of *n*. To create an asymmetry in initial attack rates, we used the ending *a~ii~* and *a~ij~* values for the one consumer simulation as the starting values for *C~2~* in the two consumer simulation. We set initial consumer and resource abundances as: *R~i~* = *R~j~* = 2; *C~i~* = *C~j~* = 1."}
knitr::include_graphics("Figure_ECD_LS_asymm.pdf")
```

```{r McCann_asymm, include=FALSE}
# replaced McCann_displacements with McCann_displacements_asymm

McCann_attack_asymm <- ggplot(tradeoff_df, aes(x=aii/(aii+aij), y=wii*aii+wij*aij, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(McCann_displacements_asymm, Time=="End"), aes(x = a11/(a11+a12), y=w11*a11+w12*a12, fill=factor(n), shape=Competitor), size=3, color="white") + #, show.legend=FALSE) + size=5,
  geom_point(data = filter(McCann_displacements_asymm, Time=="Begin"), aes(x = a11/(a11+a12), y=w11*a11+w12*a12, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(expression(w*a[ii]+(1-w)*a[ij])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

McCann_resources_asymm <- cbind.data.frame(select(tradeoff_df, n, aii, aij), McCann_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=R1+R2, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(McCann_displacements_asymm, Time=="End"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=3, color="white") + #, show.legend=FALSE) + size=5,
  geom_point(data = filter(McCann_displacements_asymm, Time=="Begin"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(expression(R[i]+R[j])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Stability_McCann_asymm <- cbind.data.frame(select(tradeoff_df, n, aii, aij), McCann_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=-1*max.Re.eigen, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(McCann_displacements_asymm, Time=="End"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=3, color="white", show.legend=FALSE) + #size=5,
  geom_point(data = filter(McCann_displacements_asymm, Time=="Begin"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  ylab(expression("Stability "(-lambda[max]))) + #ylab(expression(-1%*%"Re"(lambda[max]))) +
  scale_shape_manual(values=c(24,21))  +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  geom_hline(yintercept=0, linetype="dotted", color="grey") +
  guides(fill = guide_legend(override.aes=list(shape=21)))

McCann_plots_asymm <- plot_grid(McCann_attack_asymm + theme(legend.position = "none"), 
                             McCann_resources_asymm + theme(legend.position = "none"), 
                             Stability_McCann_asymm + theme(legend.position = "none"), 
                       ncol=2, labels = "AUTO", align = 'hv')
McCann_plots_asymm

save_plot(filename="Figure_ECD_McCann_asymm.pdf", plot=McCann_plots_asymm, base_height = 6, base_width = 6)
```

```{r McCann_Plot_asymm, echo=FALSE, fig.cap="\\label{fig:McCann_Plot_asymm}**Effect of character displacement when consumers exhibit a more realistic functional response and have an asymmetry in initial attack rates.** Different line colors correspond to different tradeoff values (green, *n* = 1.15; blue, *n* = 1; orange, *n* = 0.85). Large circles (two consumers) and triangles (one consumer) correspond to the end points of the eco-evolutionary simulation, whereas as small shapes correspond to the starting points. Panel (A) shows how, regardless of the tradeoff, character displacement increases the effective attack rate of consumers. This always resulted in a suppression of resource densities (B) and concomitant decrease in food-web stability (C). These simulations used the following parameter values: *r* = 1; *K* = 4; *e* = 0.8; *m* = 1; *A* = 2; *w~ii~*=0.6, *w~ij~*=0.4. We set an initial value of *a~ii~* = 1.2 and *a~ij~* depended on the value of *n*. To create an asymmetry in initial attack rates, we used the ending *a~ii~* and *a~ij~* values for the one consumer simulation as the starting values for *C~2~* in the two consumer simulation. We set initial consumer and resource abundances as: *R~i~* = *R~j~* = 2; *C~i~* = *C~j~* = 1."}
knitr::include_graphics("Figure_ECD_McCann_asymm.pdf")
```