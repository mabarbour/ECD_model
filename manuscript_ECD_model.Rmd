---
#title: |
#   | Predicting the effects of character displacement on food-web dynamics
#   | Food-web dynamics under ecological character displacement
#author: 
#- Matthew A. Barbour$^{1,2,\ast}$
# potentially use for 'date' for affiliations, as recommended by https://github.com/rstudio/bookdown/issues/348 for cross-format compatibility, with | to create new sections.
#date: | 
#    | 1. Affiliation
output:
  pdf_document:
    keep_tex: true
    toc: false
    number_sections: false
    df_print: paged
    fig_caption: true
    citation_package: natbib 
    includes:  
      in_header: Am-Nat-preamble-latex.tex
bibliography: references
biblio-style: amnat
fontsize: 11pt
fontfamily: mathpazo
documentclass: article
linkcolor: black
urlcolor: black
citecolor: black
---

<!-- Begin title page formatting -->

\vspace*{0.1cm} 
\begin{center} \LARGE Ecological character displacement destabilizes food webs \end{center}
<!--\begin{center} \LARGE Food-web dynamics under ecological character displacement \end{center}-->

\bigskip

<!-- Remove author info for double-blind peer review; Keep for bioRxiv submission -->
\begin{center} \large Matthew A. Barbour$^{1,2,\ast}$ \normalsize \end{center}

\bigskip

\noindent 1. University of Zurich, Department of Evolutionary Biology and Environmental Studies, 8057 Zurich, Switzerland;

\noindent 2. University of British Columbia, Department of Zoology, Vancouver, BC V6T 1Z4, Canada;

$^\ast$ Corresponding author; e-mail: matthew.barbour@ieu.uzh.ch, phone: +41 44 635 57 11

\bigskip

*Running title*: Character divergence destabilizes food webs

\bigskip

*Keywords*: competition; eco-evolutionary dynamics; consumer-resource interactions; adaptation; community stability 

\bigskip

*Manuscript type*: Letter. <!-- consider e-Article, depending on length -->

\bigskip

*Number of words in abstract*: 

*Number of words in main text*: 

*Number of references*:

*Number of figures*: 

<!-- End title page formatting -->

\linenumbers{}
\modulolinenumbers[3]

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE)

## Load required libraries
library(deSolve) # numerical integration library
library(rootSolve) # for runsteady integration function
library(pse) # for latin hypercube
library(plyr) # for ldply
library(dplyr) # for manipulating data
library(tidyr) # for tidying data
library(cowplot) # for better base, ggplot graphics

## color palette
cbPalette <- c("#D55E00", "#0072B2", "#009E73")
```

```{r Simulations, include=FALSE, messages=TRUE, cache=TRUE}

#### GET REQUIRED FUNCTIONS ####

source('identify_steady_state.R')
source('eco_evo_sim_function.R')
source('Consumer_Resource_Functions.R')
source('CR_dynamics.R')

#### GENERAL PARAMETERS AND STATE VARIABLES #### 

## Intrinsic growth rates
r <- 1
r1 <- r 
r2 <- r 

## Carrying capacity
K <- 4
K1 <- K
K2 <- K

## Conversion efficiency
e <- 0.8
e11 <- e 
e12 <- e 
e21 <- e 
e22 <- e 

## Mortality rate
m <- 1
m1 <- m
m2 <- m

## General, non-evolving parameter set for 2C,2R model
general_parameters <- data.frame(r1 = r1, r2 = r2, K1 = K1, K2 = K2, e11 = e11, e12 = e12, e21 = e21, e22 = e22, m1 = m1, m2 = m2)

## Attack rate
A <- 2
aii <- A*0.61

## Habitat preference (for LawlorSmith and McCann models)
w <- 0.6
wii <- w
wij <- (1 - w)

## Handling time (only for McCann model)
h <- 0.4
h11 <- h
h12 <- h
h21 <- h
h22 <- h

## State variables
R <- 2
R1 <- R
R2 <- R
C <- 1
C1 <- C
C2 <- C

states_2C_2R <- data.frame(R1 = R1, R2 = R2, C1 = C1, C2 = C2)
states_1C_2R <- data.frame(R1 = R1, R2 = R2, C1 = C1)

## Trade-offs. Borrowed from Sargent and Otto, 2006 Am Nat
a12_tradeoff <- expression(A*(1-(a11m/A)^n)^(1/n)) 
a21_tradeoff <- expression(A*(1-(a22m/A)^n)^(1/n)) 

n_concaveDN <- 1.15
n_linear <- 1
n_concaveUP <- 0.85

concaveDN_df <- data.frame(n = n_concaveDN, aii = seq(0,A,0.01)) %>% mutate(aij = A*(1-(aii/A)^n_concaveDN)^(1/n_concaveDN))
linear_df <- data.frame(n = n_linear, aii = seq(0,A,0.01)) %>% mutate(aij = A*(1-(aii/A)^n_linear)^(1/n_linear))
concaveUP_df <- data.frame(n = n_concaveUP, aii = seq(0,A,0.01)) %>% mutate(aij = A*(1-(aii/A)^n_concaveUP)^(1/n_concaveUP))

bind_rows(concaveDN_df, linear_df, concaveUP_df) %>%
  ggplot(., aes(x=aii, y=aij, color = factor(n))) + geom_line() + ggtitle("Attack rate trade-offs")

bind_rows(concaveDN_df, linear_df, concaveUP_df) %>%
  ggplot(., aes(x=aii/(aii+aij), y=aii+aij, color = factor(n))) + geom_line() + ggtitle("Relationship between specialization and total attack rate")

######################################### MACARTHUR MODEL #######################################################

## Mutant growth rates
mC1_MacArthur <- expression(e11*a11m*R1 + e12*a12m*R2 - m1)
mC2_MacArthur <- expression(e21*a21m*R1 + e22*a22m*R2 - m2)

#### PARAMETERS ####

## Linear
params_2C_2R_MacArthur_linear <- data.frame(general_parameters,
                                            a11 = aii, 
                                            a12 = eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_linear)),                     
                                            a21 = eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_linear)), 
                                            a22 = aii)                      
params_1C_2R_MacArthur_linear <- params_2C_2R_MacArthur_linear[c("r1","r2","K1","K2","e11","e12","a11","a12","m1")]


## concaveDN
params_2C_2R_MacArthur_concaveDN <- params_2C_2R_MacArthur_linear
params_2C_2R_MacArthur_concaveDN["a12"] <- eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_concaveDN))
params_2C_2R_MacArthur_concaveDN["a21"] <- eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_concaveDN))
params_1C_2R_MacArthur_concaveDN <- params_2C_2R_MacArthur_concaveDN[c("r1","r2","K1","K2","e11","e12","a11","a12","m1")]

## concaveUP
params_2C_2R_MacArthur_concaveUP <- params_2C_2R_MacArthur_linear
params_2C_2R_MacArthur_concaveUP["a12"] <- eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_concaveUP))
params_2C_2R_MacArthur_concaveUP["a21"] <- eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_concaveUP))
params_1C_2R_MacArthur_concaveUP <- params_2C_2R_MacArthur_concaveUP[c("r1","r2","K1","K2","e11","e12","a11","a12","m1")]

#### SIMULATIONS ####

## Linear
sim_2C_2R_MacArthur_linear <- eco_evo_CR(init_parameters = params_2C_2R_MacArthur_linear, 
                                init_states = states_2C_2R, 
                                eco_CR_model = MacArthur_2C_2R, 
                                AD_CR_models = c(mC1_MacArthur, mC2_MacArthur),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_linear))
sim_1C_2R_MacArthur_linear <- eco_evo_CR(init_parameters = params_1C_2R_MacArthur_linear, 
                                init_states = states_1C_2R, 
                                eco_CR_model = MacArthur_1C_2R, 
                                AD_CR_models = c(mC1_MacArthur),
                                species_traits = c(1), 
                                eco_param_names = c("a11"), 
                                eco_tradeoff_names = c("a12"),  
                                evo_param_names = c("a11m"),  
                                evo_tradeoff_names = c("a12m"), 
                                tradeoff_functions = c(a12_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_linear))
# asymmetric starting points
params_2C_2R_MacArthur_linear_asymm <- params_2C_2R_MacArthur_linear
params_2C_2R_MacArthur_linear_asymm[c("a21","a22")] <- sim_1C_2R_MacArthur_linear[nrow(sim_1C_2R_MacArthur_linear), c("a12","a11")] # replace C2's attack rates with the ending point of the C1 generalist simulation. This will create an asymmetry in the attack rates and follows the logic (and our results) that a likely scenerio with asymmetry is a specialist invading a generalist.
# just altering the parameters, everything else stays the same
sim_2C_2R_MacArthur_linear_asymm <- eco_evo_CR(init_parameters = params_2C_2R_MacArthur_linear_asymm,
                                init_states = states_2C_2R, 
                                eco_CR_model = MacArthur_2C_2R, 
                                AD_CR_models = c(mC1_MacArthur, mC2_MacArthur),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_linear))

## concaveDN
sim_2C_2R_MacArthur_concaveDN <- eco_evo_CR(init_parameters = params_2C_2R_MacArthur_concaveDN, 
                                init_states = states_2C_2R, 
                                eco_CR_model = MacArthur_2C_2R, 
                                AD_CR_models = c(mC1_MacArthur, mC2_MacArthur),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_concaveDN))
sim_1C_2R_MacArthur_concaveDN <- eco_evo_CR(init_parameters = params_1C_2R_MacArthur_concaveDN, 
                                init_states = states_1C_2R, 
                                eco_CR_model = MacArthur_1C_2R, 
                                AD_CR_models = c(mC1_MacArthur),
                                species_traits = c(1), 
                                eco_param_names = c("a11"), 
                                eco_tradeoff_names = c("a12"),  
                                evo_param_names = c("a11m"),  
                                evo_tradeoff_names = c("a12m"), 
                                tradeoff_functions = c(a12_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_concaveDN))
# asymmetric starting points
params_2C_2R_MacArthur_concaveDN_asymm <- params_2C_2R_MacArthur_concaveDN
params_2C_2R_MacArthur_concaveDN_asymm[c("a21","a22")] <- sim_1C_2R_MacArthur_concaveDN[nrow(sim_1C_2R_MacArthur_concaveDN), c("a12","a11")] 
sim_2C_2R_MacArthur_concaveDN_asymm <- eco_evo_CR(init_parameters = params_2C_2R_MacArthur_concaveDN_asymm,
                                init_states = states_2C_2R, 
                                eco_CR_model = MacArthur_2C_2R, 
                                AD_CR_models = c(mC1_MacArthur, mC2_MacArthur),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_concaveDN))

## concaveUP
sim_2C_2R_MacArthur_concaveUP <- eco_evo_CR(init_parameters = params_2C_2R_MacArthur_concaveUP, 
                                       init_states = states_2C_2R, 
                                       eco_CR_model = MacArthur_2C_2R, 
                                       AD_CR_models = c(mC1_MacArthur, mC2_MacArthur),
                                       species_traits = c(1,2), 
                                       eco_param_names = c("a11","a22"), 
                                       eco_tradeoff_names = c("a12","a21"),  
                                       evo_param_names = c("a11m","a22m"),  
                                       evo_tradeoff_names = c("a12m","a21m"), 
                                       tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                       extra_tradeoff_params = c(A=A, n=n_concaveUP))
sim_1C_2R_MacArthur_concaveUP <- eco_evo_CR(init_parameters = params_1C_2R_MacArthur_concaveUP, 
                                       init_states = states_1C_2R, 
                                       eco_CR_model = MacArthur_1C_2R, 
                                       AD_CR_models = c(mC1_MacArthur),
                                       species_traits = c(1), 
                                       eco_param_names = c("a11"), 
                                       eco_tradeoff_names = c("a12"),  
                                       evo_param_names = c("a11m"),  
                                       evo_tradeoff_names = c("a12m"), 
                                       tradeoff_functions = c(a12_tradeoff),
                                       extra_tradeoff_params = c(A=A, n=n_concaveUP))
# asymmetric starting points
params_2C_2R_MacArthur_concaveUP_asymm <- params_2C_2R_MacArthur_concaveUP
params_2C_2R_MacArthur_concaveUP_asymm[c("a21","a22")] <- sim_1C_2R_MacArthur_concaveUP[nrow(sim_1C_2R_MacArthur_concaveUP), c("a12","a11")]
# max iterations reached!
sim_2C_2R_MacArthur_concaveUP_asymm <- eco_evo_CR(init_parameters = params_2C_2R_MacArthur_concaveUP_asymm,
                                init_states = states_2C_2R, 
                                eco_CR_model = MacArthur_2C_2R, 
                                AD_CR_models = c(mC1_MacArthur, mC2_MacArthur),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_concaveUP))

######################################### LAWLOR SMITH COARSE-GRAIN MODEL #######################################################


## Mutant growth rates
mC1_LawlorSmith <- expression(e11*w11*a11m*R1 + e12*w12*a12m*R2 - m1)
mC2_LawlorSmith <- expression(e21*w21*a21m*R1 + e22*w22*a22m*R2 - m2)

#### PARAMETERS ####

## Linear
params_2C_2R_LawlorSmith_linear <- data.frame(general_parameters,
                                              a11 = aii,
                                              a12 = eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_linear)), 
                                              a21 = eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_linear)), 
                                              a22 = aii,
                                              w11 = wii, 
                                              w12 = wij, 
                                              w21 = wij,
                                              w22 = wii)
params_1C_2R_LawlorSmith_linear <- params_2C_2R_LawlorSmith_linear[c("r1","r2","K1","K2","e11","e12","a11","a12","m1","w11","w12","w21","w22")]


## concaveDN
params_2C_2R_LawlorSmith_concaveDN <- params_2C_2R_LawlorSmith_linear
params_2C_2R_LawlorSmith_concaveDN["a12"] <- eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_concaveDN))
params_2C_2R_LawlorSmith_concaveDN["a21"] <- eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_concaveDN))
params_1C_2R_LawlorSmith_concaveDN <- params_2C_2R_LawlorSmith_concaveDN[c("r1","r2","K1","K2","e11","e12","a11","a12","m1","w11","w12","w21","w22")]

## concaveUP
params_2C_2R_LawlorSmith_concaveUP <- params_2C_2R_LawlorSmith_linear
params_2C_2R_LawlorSmith_concaveUP["a12"] <- eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_concaveUP))
params_2C_2R_LawlorSmith_concaveUP["a21"] <- eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_concaveUP))
params_1C_2R_LawlorSmith_concaveUP <- params_2C_2R_LawlorSmith_concaveUP[c("r1","r2","K1","K2","e11","e12","a11","a12","m1","w11","w12","w21","w22")]

#### SIMULATIONS ####

## Linear
sim_2C_2R_LawlorSmith_linear <- eco_evo_CR(init_parameters = params_2C_2R_LawlorSmith_linear, 
                                       init_states = states_2C_2R, 
                                       eco_CR_model = LawlorSmith_2C_2R, 
                                       AD_CR_models = c(mC1_LawlorSmith, mC2_LawlorSmith),
                                       species_traits = c(1,2), 
                                       eco_param_names = c("a11","a22"), 
                                       eco_tradeoff_names = c("a12","a21"),  
                                       evo_param_names = c("a11m","a22m"),  
                                       evo_tradeoff_names = c("a12m","a21m"), 
                                       tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                       extra_tradeoff_params = c(A=A, n=n_linear))
sim_1C_2R_LawlorSmith_linear <- eco_evo_CR(init_parameters = params_1C_2R_LawlorSmith_linear, 
                                       init_states = states_1C_2R, 
                                       eco_CR_model = LawlorSmith_1C_2R, 
                                       AD_CR_models = c(mC1_LawlorSmith),
                                       species_traits = c(1), 
                                       eco_param_names = c("a11"), 
                                       eco_tradeoff_names = c("a12"),  
                                       evo_param_names = c("a11m"),  
                                       evo_tradeoff_names = c("a12m"), 
                                       tradeoff_functions = c(a12_tradeoff),
                                       extra_tradeoff_params = c(A=A, n=n_linear))
# asymmetric starting points
params_2C_2R_LawlorSmith_linear_asymm <- params_2C_2R_LawlorSmith_linear
params_2C_2R_LawlorSmith_linear_asymm[c("a21","a22")] <- sim_1C_2R_LawlorSmith_linear[nrow(sim_1C_2R_LawlorSmith_linear), c("a12","a11")] 
sim_2C_2R_LawlorSmith_linear_asymm <- eco_evo_CR(init_parameters = params_2C_2R_LawlorSmith_linear_asymm,
                                init_states = states_2C_2R, 
                                eco_CR_model = LawlorSmith_2C_2R, 
                                AD_CR_models = c(mC1_LawlorSmith, mC2_LawlorSmith),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_linear))

## concaveDN
# max mut iter reach!
sim_2C_2R_LawlorSmith_concaveDN <- eco_evo_CR(init_parameters = params_2C_2R_LawlorSmith_concaveDN, 
                                       init_states = states_2C_2R, 
                                       eco_CR_model = LawlorSmith_2C_2R, 
                                       AD_CR_models = c(mC1_LawlorSmith, mC2_LawlorSmith),
                                       species_traits = c(1,2), 
                                       eco_param_names = c("a11","a22"), 
                                       eco_tradeoff_names = c("a12","a21"),  
                                       evo_param_names = c("a11m","a22m"),  
                                       evo_tradeoff_names = c("a12m","a21m"), 
                                       tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                       extra_tradeoff_params = c(A=A, n=n_concaveDN))
# note that although the max mutation iterations are reached, the evolving parameters appear to oscillate near high values, i.e. they are effectively at an ESS
plot(sim_2C_2R_LawlorSmith_concaveDN[,c("a11","a22")]) 
plot(sim_2C_2R_LawlorSmith_concaveDN[,c("a11","a22")], xlim=c(1.85,1.95)) 

sim_1C_2R_LawlorSmith_concaveDN <- eco_evo_CR(init_parameters = params_1C_2R_LawlorSmith_concaveDN, 
                                       init_states = states_1C_2R, 
                                       eco_CR_model = LawlorSmith_1C_2R, 
                                       AD_CR_models = c(mC1_LawlorSmith),
                                       species_traits = c(1), 
                                       eco_param_names = c("a11"), 
                                       eco_tradeoff_names = c("a12"),  
                                       evo_param_names = c("a11m"),  
                                       evo_tradeoff_names = c("a12m"), 
                                       tradeoff_functions = c(a12_tradeoff),
                                       extra_tradeoff_params = c(A=A, n=n_concaveDN))
# asymmetric starting points
params_2C_2R_LawlorSmith_concaveDN_asymm <- params_2C_2R_LawlorSmith_concaveDN
params_2C_2R_LawlorSmith_concaveDN_asymm[c("a21","a22")] <- sim_1C_2R_LawlorSmith_concaveDN[nrow(sim_1C_2R_LawlorSmith_concaveDN), c("a12","a11")] 
sim_2C_2R_LawlorSmith_concaveDN_asymm <- eco_evo_CR(init_parameters = params_2C_2R_LawlorSmith_concaveDN_asymm,
                                init_states = states_2C_2R, 
                                eco_CR_model = LawlorSmith_2C_2R, 
                                AD_CR_models = c(mC1_LawlorSmith, mC2_LawlorSmith),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_concaveDN))

## concaveUP
sim_2C_2R_LawlorSmith_concaveUP <- eco_evo_CR(init_parameters = params_2C_2R_LawlorSmith_concaveUP, 
                                        init_states = states_2C_2R, 
                                        eco_CR_model = LawlorSmith_2C_2R, 
                                        AD_CR_models = c(mC1_LawlorSmith, mC2_LawlorSmith),
                                        species_traits = c(1,2), 
                                        eco_param_names = c("a11","a22"), 
                                        eco_tradeoff_names = c("a12","a21"),  
                                        evo_param_names = c("a11m","a22m"),  
                                        evo_tradeoff_names = c("a12m","a21m"), 
                                        tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                        extra_tradeoff_params = c(A=A, n=n_concaveUP))
sim_1C_2R_LawlorSmith_concaveUP <- eco_evo_CR(init_parameters = params_1C_2R_LawlorSmith_concaveUP, 
                                        init_states = states_1C_2R, 
                                        eco_CR_model = LawlorSmith_1C_2R, 
                                        AD_CR_models = c(mC1_LawlorSmith),
                                        species_traits = c(1), 
                                        eco_param_names = c("a11"), 
                                        eco_tradeoff_names = c("a12"),  
                                        evo_param_names = c("a11m"),  
                                        evo_tradeoff_names = c("a12m"), 
                                        tradeoff_functions = c(a12_tradeoff),
                                        extra_tradeoff_params = c(A=A, n=n_concaveUP))
# asymmetric starting points
params_2C_2R_LawlorSmith_concaveUP_asymm <- params_2C_2R_LawlorSmith_concaveUP
params_2C_2R_LawlorSmith_concaveUP_asymm[c("a21","a22")] <- sim_1C_2R_LawlorSmith_concaveUP[nrow(sim_1C_2R_LawlorSmith_concaveUP), c("a12","a11")] 
sim_2C_2R_LawlorSmith_concaveUP_asymm <- eco_evo_CR(init_parameters = params_2C_2R_LawlorSmith_concaveUP_asymm,
                                init_states = states_2C_2R, 
                                eco_CR_model = LawlorSmith_2C_2R, 
                                AD_CR_models = c(mC1_LawlorSmith, mC2_LawlorSmith),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_concaveUP))

######################################### MCCANN MODEL #######################################################


## Mutant growth rates
mC1_McCann <- expression(e11*(((w11 * R1)/(w11 * R1 + w12 * R2)) * a11m * R1)/(1 + ((w11 * R1)/(w11 * R1 + w12 * R2)) * a11m * h11 * R1 + ((w12 * R2)/(w11 * R1 + w12 * R2)) * a12m * h12 * R2) + e12*(((w12 * R2)/(w11 * R1 + w12 * R2)) * a12m * R2)/(1 + ((w11 * R1)/(w11 * R1 + w12 * R2)) * a11m * h11 * R1 + ((w12 * R2)/(w11 * R1 + w12 * R2)) * a12m * h12 * R2) - m1)
mC2_McCann <- expression(e21*(((w21 * R1)/(w21 * R1 + w22 * R2)) * a21m * R1)/(1 + ((w21 * R1)/(w21 * R1 + w22 * R2)) * a21m * h21 * R1 + ((w22 * R2)/(w21 * R1 + w22 * R2)) * a22m * h22 * R2) + e22*(((w22 * R2)/(w21 * R1 + w22 * R2)) * a22m * R2)/(1 + ((w21 * R1)/(w21 * R1 + w22 * R2)) * a21m * h21 * R1 + ((w22 * R2)/(w21 * R1 + w22 * R2)) * a22m * h22 * R2) - m2)


#### PARAMETERS ####

## Linear
params_2C_2R_McCann_linear <- data.frame(general_parameters,
                                         a11 = aii,
                                         a12 = eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_linear)), 
                                         a21 = eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_linear)), 
                                         a22 = aii,
                                         w11 = wii, 
                                         w12 = wij, 
                                         w21 = wij,
                                         w22 = wii,
                                         h11 = h11,
                                         h12 = h12,
                                         h21 = h21,
                                         h22 = h22)
                                            
params_1C_2R_McCann_linear <- params_2C_2R_McCann_linear[c("r1","r2","K1","K2","e11","e12","a11","a12","m1","w11","w12","w21","w22","h11","h12","h21","h22")]


## concaveDN
params_2C_2R_McCann_concaveDN <- params_2C_2R_McCann_linear
params_2C_2R_McCann_concaveDN["a12"] <- eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_concaveDN))
params_2C_2R_McCann_concaveDN["a21"] <- eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_concaveDN))
params_1C_2R_McCann_concaveDN <- params_2C_2R_McCann_concaveDN[c("r1","r2","K1","K2","e11","e12","a11","a12","m1","w11","w12","w21","w22","h11","h12","h21","h22")]

## concaveUP
params_2C_2R_McCann_concaveUP <- params_2C_2R_McCann_linear
params_2C_2R_McCann_concaveUP["a12"] <- eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_concaveUP))
params_2C_2R_McCann_concaveUP["a21"] <- eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_concaveUP))
params_1C_2R_McCann_concaveUP <- params_2C_2R_McCann_concaveUP[c("r1","r2","K1","K2","e11","e12","a11","a12","m1","w11","w12","w21","w22","h11","h12","h21","h22")]

#### SIMULATIONS ####

## Linear
sim_2C_2R_McCann_linear <- eco_evo_CR(init_parameters = params_2C_2R_McCann_linear, 
                                         init_states = states_2C_2R, 
                                         eco_CR_model = McCann_2C_2R, 
                                         AD_CR_models = c(mC1_McCann, mC2_McCann),
                                         species_traits = c(1,2), 
                                         eco_param_names = c("a11","a22"), 
                                         eco_tradeoff_names = c("a12","a21"),  
                                         evo_param_names = c("a11m","a22m"),  
                                         evo_tradeoff_names = c("a12m","a21m"), 
                                         tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                         extra_tradeoff_params = c(A=A, n=n_linear))
sim_1C_2R_McCann_linear <- eco_evo_CR(init_parameters = params_1C_2R_McCann_linear, 
                                         init_states = states_1C_2R, 
                                         eco_CR_model = McCann_1C_2R, 
                                         AD_CR_models = c(mC1_McCann),
                                         species_traits = c(1), 
                                         eco_param_names = c("a11"), 
                                         eco_tradeoff_names = c("a12"),  
                                         evo_param_names = c("a11m"),  
                                         evo_tradeoff_names = c("a12m"), 
                                         tradeoff_functions = c(a12_tradeoff),
                                         extra_tradeoff_params = c(A=A, n=n_linear))
# I'm thinking these initial asymmetric simulations don't quite make sense (at least for LawlorSmith and McCann). This is because I didn't switch the pre-adapted habitat preferences as well...This is important because C1 in the first simulation becomes C2 in the 2C-2R sim. This isn't an issue in the symmetry model, because I assume they are pre-adapted on different resources. 
# asymmetric starting points
params_2C_2R_McCann_linear_asymm <- params_2C_2R_McCann_linear
params_2C_2R_McCann_linear_asymm[c("a21","a22")] <- sim_1C_2R_McCann_linear[nrow(sim_1C_2R_McCann_linear), c("a12","a11")] # make sure a_ij and a_ii are in correct order. Note that habitat preference (w) is already set in the appropriate direction 
sim_2C_2R_McCann_linear_asymm <- eco_evo_CR(init_parameters = params_2C_2R_McCann_linear_asymm,
                                init_states = states_2C_2R, 
                                eco_CR_model = McCann_2C_2R, 
                                AD_CR_models = c(mC1_McCann, mC2_McCann),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_linear))

## concaveDN
# max mut iter
sim_2C_2R_McCann_concaveDN <- eco_evo_CR(init_parameters = params_2C_2R_McCann_concaveDN, 
                                         init_states = states_2C_2R, 
                                         eco_CR_model = McCann_2C_2R, 
                                         AD_CR_models = c(mC1_McCann, mC2_McCann),
                                         species_traits = c(1,2), 
                                         eco_param_names = c("a11","a22"), 
                                         eco_tradeoff_names = c("a12","a21"),  
                                         evo_param_names = c("a11m","a22m"),  
                                         evo_tradeoff_names = c("a12m","a21m"), 
                                         tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                         extra_tradeoff_params = c(A=A, n=n_concaveDN))
# note that although the max mutation iterations are reached, the evolving parameters appear to oscillate near high values. i.e. they are effectively at an ESS
plot(sim_2C_2R_McCann_concaveDN[,c("a11","a22")]) 
plot(sim_2C_2R_McCann_concaveDN[,c("a11","a22")], xlim=c(1.85,1.95)) 

sim_1C_2R_McCann_concaveDN <- eco_evo_CR(init_parameters = params_1C_2R_McCann_concaveDN, 
                                         init_states = states_1C_2R, 
                                         eco_CR_model = McCann_1C_2R, 
                                         AD_CR_models = c(mC1_McCann),
                                         species_traits = c(1), 
                                         eco_param_names = c("a11"), 
                                         eco_tradeoff_names = c("a12"),  
                                         evo_param_names = c("a11m"),  
                                         evo_tradeoff_names = c("a12m"), 
                                         tradeoff_functions = c(a12_tradeoff),
                                         extra_tradeoff_params = c(A=A, n=n_concaveDN))
# asymmetric starting points
params_2C_2R_McCann_concaveDN_asymm <- params_2C_2R_McCann_concaveDN
params_2C_2R_McCann_concaveDN_asymm[c("a21","a22")] <- sim_1C_2R_McCann_concaveDN[nrow(sim_1C_2R_McCann_concaveDN), c("a12","a11")] 
sim_2C_2R_McCann_concaveDN_asymm <- eco_evo_CR(init_parameters = params_2C_2R_McCann_concaveDN_asymm,
                                init_states = states_2C_2R, 
                                eco_CR_model = McCann_2C_2R, 
                                AD_CR_models = c(mC1_McCann, mC2_McCann),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_concaveDN))

## concaveUP
sim_2C_2R_McCann_concaveUP <- eco_evo_CR(init_parameters = params_2C_2R_McCann_concaveUP, 
                                          init_states = states_2C_2R, 
                                          eco_CR_model = McCann_2C_2R, 
                                          AD_CR_models = c(mC1_McCann, mC2_McCann),
                                          species_traits = c(1,2), 
                                          eco_param_names = c("a11","a22"), 
                                          eco_tradeoff_names = c("a12","a21"),  
                                          evo_param_names = c("a11m","a22m"),  
                                          evo_tradeoff_names = c("a12m","a21m"), 
                                          tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                          extra_tradeoff_params = c(A=A, n=n_concaveUP))
sim_1C_2R_McCann_concaveUP <- eco_evo_CR(init_parameters = params_1C_2R_McCann_concaveUP, 
                                          init_states = states_1C_2R, 
                                          eco_CR_model = McCann_1C_2R, 
                                          AD_CR_models = c(mC1_McCann),
                                          species_traits = c(1), 
                                          eco_param_names = c("a11"), 
                                          eco_tradeoff_names = c("a12"),  
                                          evo_param_names = c("a11m"),  
                                          evo_tradeoff_names = c("a12m"), 
                                          tradeoff_functions = c(a12_tradeoff),
                                          extra_tradeoff_params = c(A=A, n=n_concaveUP))
# asymmetric starting points
params_2C_2R_McCann_concaveUP_asymm <- params_2C_2R_McCann_concaveUP
params_2C_2R_McCann_concaveUP_asymm[c("a21","a22")] <- sim_1C_2R_McCann_concaveUP[nrow(sim_1C_2R_McCann_concaveUP), c("a12","a11")] 
sim_2C_2R_McCann_concaveUP_asymm <- eco_evo_CR(init_parameters = params_2C_2R_McCann_concaveUP_asymm,
                                init_states = states_2C_2R, 
                                eco_CR_model = McCann_2C_2R, 
                                AD_CR_models = c(mC1_McCann, mC2_McCann),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_concaveUP))
```

```{r Organize_Simulation_Data, include=FALSE, cache=TRUE}

## Gather data. Note different formula for effective attack rate of consumer 1 "a_eff_C1". This accounts for the differences between fine- and coarse-grained environments
sim_data <- bind_rows(
  mutate(sim_2C_2R_MacArthur_linear, Model = "MacArthur", n = n_linear, Competitor = "Yes", a_eff_C1 = a11+a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_MacArthur_linear, Model = "MacArthur", n = n_linear, Competitor = "No", a_eff_C1 = a11+a12, Ctot = C1),
  mutate(sim_2C_2R_MacArthur_concaveDN, Model = "MacArthur", n = n_concaveDN, Competitor = "Yes", a_eff_C1 = a11+a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_MacArthur_concaveDN, Model = "MacArthur", n = n_concaveDN, Competitor = "No", a_eff_C1 = a11+a12, Ctot = C1),
  mutate(sim_2C_2R_MacArthur_concaveUP, Model = "MacArthur", n = n_concaveUP, Competitor = "Yes", a_eff_C1 = a11+a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_MacArthur_concaveUP, Model = "MacArthur", n = n_concaveUP, Competitor = "No", a_eff_C1 = a11+a12, Ctot = C1),
  mutate(sim_2C_2R_LawlorSmith_linear, Model = "LawlorSmith", n = n_linear, Competitor = "Yes", a_eff_C1 = w11*a11+w12*a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_LawlorSmith_linear, Model = "LawlorSmith", n = n_linear, Competitor = "No", a_eff_C1 = w11*a11+w12*a12, Ctot = C1),
  mutate(sim_2C_2R_LawlorSmith_concaveDN, Model = "LawlorSmith", n = n_concaveDN, Competitor = "Yes", a_eff_C1 = w11*a11+w12*a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_LawlorSmith_concaveDN, Model = "LawlorSmith", n = n_concaveDN, Competitor = "No", a_eff_C1 = w11*a11+w12*a12, Ctot = C1),
  mutate(sim_2C_2R_LawlorSmith_concaveUP, Model = "LawlorSmith", n = n_concaveUP, Competitor = "Yes", a_eff_C1 = w11*a11+w12*a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_LawlorSmith_concaveUP, Model = "LawlorSmith", n = n_concaveUP, Competitor = "No", a_eff_C1 = w11*a11+w12*a12, Ctot = C1),
  mutate(sim_2C_2R_McCann_linear, Model = "McCann", n = n_linear, Competitor = "Yes", a_eff_C1 = w11*a11+w12*a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_McCann_linear, Model = "McCann", n = n_linear, Competitor = "No", a_eff_C1 = w11*a11+w12*a12, Ctot = C1),
  mutate(sim_2C_2R_McCann_concaveDN, Model = "McCann", n = n_concaveDN, Competitor = "Yes", a_eff_C1 = w11*a11+w12*a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_McCann_concaveDN, Model = "McCann", n = n_concaveDN, Competitor = "No", a_eff_C1 = w11*a11+w12*a12, Ctot = C1),
  mutate(sim_2C_2R_McCann_concaveUP, Model = "McCann", n = n_concaveUP, Competitor = "Yes", a_eff_C1 = w11*a11+w12*a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_McCann_concaveUP, Model = "McCann", n = n_concaveUP, Competitor = "No", a_eff_C1 = w11*a11+w12*a12, Ctot = C1)) 

#### PREDICTING EFFECTS OF CHARACTER DISPLACEMENT ON C-R DYNAMICS ####

tradeoff_df <- bind_rows(mutate(concaveDN_df, n = n_concaveDN), 
                         mutate(linear_df, n = n_linear), 
                         mutate(concaveUP_df, n = n_concaveUP)) %>%
  data.frame(., general_parameters) %>%
  mutate(a11 = aii, a12 = aij, a21 = aij, a22 = aii,
         w11 = wii, w12 = wij, w21 = wij, w22 = wii)

## MacArthur
MacArthur_displacements <- bind_rows(
  mutate(sim_2C_2R_MacArthur_linear, Model = "MacArthur", n = n_linear, Competitor = "Yes")[c(1,nrow(sim_2C_2R_MacArthur_linear)), ], 
  mutate(sim_1C_2R_MacArthur_linear, Model = "MacArthur", n = n_linear, Competitor = "No")[c(1,nrow(sim_1C_2R_MacArthur_linear)), ],
  mutate(sim_2C_2R_MacArthur_concaveDN, Model = "MacArthur", n = n_concaveDN, Competitor = "Yes")[c(1,nrow(sim_2C_2R_MacArthur_concaveDN)), ], 
  mutate(sim_1C_2R_MacArthur_concaveDN, Model = "MacArthur", n = n_concaveDN, Competitor = "No")[c(1,nrow(sim_1C_2R_MacArthur_concaveDN)), ],
  mutate(sim_2C_2R_MacArthur_concaveUP, Model = "MacArthur", n = n_concaveUP, Competitor = "Yes")[c(1,nrow(sim_2C_2R_MacArthur_concaveUP)), ], 
  mutate(sim_1C_2R_MacArthur_concaveUP, Model = "MacArthur", n = n_concaveUP, Competitor = "No")[c(1,nrow(sim_1C_2R_MacArthur_concaveUP)), ]) 
MacArthur_displacements$Time <- rep(c("Begin","End"),6)

MacArthur_2C_2R_tradeoff_dynamics <- CR_dynamics(init_parameters = select(tradeoff_df, r1:a22), init_states = states_2C_2R, eco_CR_model = MacArthur_2C_2R)
MacArthur_1C_2R_tradeoff_dynamics <- CR_dynamics(init_parameters = select(tradeoff_df, r1:a12), init_states = states_1C_2R, eco_CR_model = MacArthur_1C_2R)

## MacArthur asymmetry. Note that all 1C_2R models are from the original simulations, as these were the starting points for the asymmetric sims (and therefore the appropriate comparison)
MacArthur_displacements_asymm <- bind_rows(
  mutate(sim_2C_2R_MacArthur_linear_asymm, Model = "MacArthur", n = n_linear, Competitor = "Yes")[c(1,nrow(sim_2C_2R_MacArthur_linear_asymm)), ], 
  mutate(sim_1C_2R_MacArthur_linear, Model = "MacArthur", n = n_linear, Competitor = "No")[c(1,nrow(sim_1C_2R_MacArthur_linear)), ],
  mutate(sim_2C_2R_MacArthur_concaveDN_asymm, Model = "MacArthur", n = n_concaveDN, Competitor = "Yes")[c(1,nrow(sim_2C_2R_MacArthur_concaveDN_asymm)), ], 
  mutate(sim_1C_2R_MacArthur_concaveDN, Model = "MacArthur", n = n_concaveDN, Competitor = "No")[c(1,nrow(sim_1C_2R_MacArthur_concaveDN)), ],
  mutate(sim_2C_2R_MacArthur_concaveUP_asymm, Model = "MacArthur", n = n_concaveUP, Competitor = "Yes")[c(1,nrow(sim_2C_2R_MacArthur_concaveUP_asymm)), ], 
  mutate(sim_1C_2R_MacArthur_concaveUP, Model = "MacArthur", n = n_concaveUP, Competitor = "No")[c(1,nrow(sim_1C_2R_MacArthur_concaveUP)), ]) 
MacArthur_displacements_asymm$Time <- rep(c("Begin","End"),6)

## Lawlor Smith
LawlorSmith_displacements <- bind_rows(
  mutate(sim_2C_2R_LawlorSmith_linear, Model = "LawlorSmith", n = n_linear, Competitor = "Yes")[c(1,nrow(sim_2C_2R_LawlorSmith_linear)), ], 
  mutate(sim_1C_2R_LawlorSmith_linear, Model = "LawlorSmith", n = n_linear, Competitor = "No")[c(1,nrow(sim_1C_2R_LawlorSmith_linear)), ],
  mutate(sim_2C_2R_LawlorSmith_concaveDN, Model = "LawlorSmith", n = n_concaveDN, Competitor = "Yes")[c(1,nrow(sim_2C_2R_LawlorSmith_concaveDN)), ], 
  mutate(sim_1C_2R_LawlorSmith_concaveDN, Model = "LawlorSmith", n = n_concaveDN, Competitor = "No")[c(1,nrow(sim_1C_2R_LawlorSmith_concaveDN)), ],
  mutate(sim_2C_2R_LawlorSmith_concaveUP, Model = "LawlorSmith", n = n_concaveUP, Competitor = "Yes")[c(1,nrow(sim_2C_2R_LawlorSmith_concaveUP)), ], 
  mutate(sim_1C_2R_LawlorSmith_concaveUP, Model = "LawlorSmith", n = n_concaveUP, Competitor = "No")[c(1,nrow(sim_1C_2R_LawlorSmith_concaveUP)), ]) 
LawlorSmith_displacements$Time <- rep(c("Begin","End"),6)

LawlorSmith_2C_2R_tradeoff_dynamics <- CR_dynamics(init_parameters = select(tradeoff_df, r1:w22), init_states = states_2C_2R, eco_CR_model = LawlorSmith_2C_2R)
LawlorSmith_1C_2R_tradeoff_dynamics <- CR_dynamics(init_parameters = select(tradeoff_df, r1:a12, w11, w12), init_states = states_1C_2R, eco_CR_model = LawlorSmith_1C_2R)

# asymmetry
LawlorSmith_displacements_asymm <- bind_rows(
  mutate(sim_2C_2R_LawlorSmith_linear_asymm, Model = "LawlorSmith", n = n_linear, Competitor = "Yes")[c(1,nrow(sim_2C_2R_LawlorSmith_linear_asymm)), ], 
  mutate(sim_1C_2R_LawlorSmith_linear, Model = "LawlorSmith", n = n_linear, Competitor = "No")[c(1,nrow(sim_1C_2R_LawlorSmith_linear)), ],
  mutate(sim_2C_2R_LawlorSmith_concaveDN_asymm, Model = "LawlorSmith", n = n_concaveDN, Competitor = "Yes")[c(1,nrow(sim_2C_2R_LawlorSmith_concaveDN_asymm)), ], 
  mutate(sim_1C_2R_LawlorSmith_concaveDN, Model = "LawlorSmith", n = n_concaveDN, Competitor = "No")[c(1,nrow(sim_1C_2R_LawlorSmith_concaveDN)), ],
  mutate(sim_2C_2R_LawlorSmith_concaveUP_asymm, Model = "LawlorSmith", n = n_concaveUP, Competitor = "Yes")[c(1,nrow(sim_2C_2R_LawlorSmith_concaveUP_asymm)), ], 
  mutate(sim_1C_2R_LawlorSmith_concaveUP, Model = "LawlorSmith", n = n_concaveUP, Competitor = "No")[c(1,nrow(sim_1C_2R_LawlorSmith_concaveUP)), ]) 
LawlorSmith_displacements_asymm$Time <- rep(c("Begin","End"),6)

## McCann
McCann_displacements <- bind_rows(
  mutate(sim_2C_2R_McCann_linear, Model = "McCann", n = n_linear, Competitor = "Yes")[c(1,nrow(sim_2C_2R_McCann_linear)), ], 
  mutate(sim_1C_2R_McCann_linear, Model = "McCann", n = n_linear, Competitor = "No")[c(1,nrow(sim_1C_2R_McCann_linear)), ],
  mutate(sim_2C_2R_McCann_concaveDN, Model = "McCann", n = n_concaveDN, Competitor = "Yes")[c(1,nrow(sim_2C_2R_McCann_concaveDN)), ], 
  mutate(sim_1C_2R_McCann_concaveDN, Model = "McCann", n = n_concaveDN, Competitor = "No")[c(1,nrow(sim_1C_2R_McCann_concaveDN)), ],
  mutate(sim_2C_2R_McCann_concaveUP, Model = "McCann", n = n_concaveUP, Competitor = "Yes")[c(1,nrow(sim_2C_2R_McCann_concaveUP)), ], 
  mutate(sim_1C_2R_McCann_concaveUP, Model = "McCann", n = n_concaveUP, Competitor = "No")[c(1,nrow(sim_1C_2R_McCann_concaveUP)), ]) 
McCann_displacements$Time <- rep(c("Begin","End"),6)

McCann_2C_2R_tradeoff_dynamics <- CR_dynamics(init_parameters = select(tradeoff_df, r1:w22), init_states = states_2C_2R, eco_CR_model = McCann_2C_2R)
McCann_1C_2R_tradeoff_dynamics <- CR_dynamics(init_parameters = select(tradeoff_df, r1:a12, w11, w12), init_states = states_1C_2R, eco_CR_model = McCann_1C_2R)

# asymmetry
McCann_displacements_asymm <- bind_rows(
  mutate(sim_2C_2R_McCann_linear_asymm, Model = "McCann", n = n_linear, Competitor = "Yes")[c(1,nrow(sim_2C_2R_McCann_linear_asymm)), ], 
  mutate(sim_1C_2R_McCann_linear, Model = "McCann", n = n_linear, Competitor = "No")[c(1,nrow(sim_1C_2R_McCann_linear)), ],
  mutate(sim_2C_2R_McCann_concaveDN_asymm, Model = "McCann", n = n_concaveDN, Competitor = "Yes")[c(1,nrow(sim_2C_2R_McCann_concaveDN_asymm)), ], 
  mutate(sim_1C_2R_McCann_concaveDN, Model = "McCann", n = n_concaveDN, Competitor = "No")[c(1,nrow(sim_1C_2R_McCann_concaveDN)), ],
  mutate(sim_2C_2R_McCann_concaveUP_asymm, Model = "McCann", n = n_concaveUP, Competitor = "Yes")[c(1,nrow(sim_2C_2R_McCann_concaveUP_asymm)), ], 
  mutate(sim_1C_2R_McCann_concaveUP, Model = "McCann", n = n_concaveUP, Competitor = "No")[c(1,nrow(sim_1C_2R_McCann_concaveUP)), ]) 
McCann_displacements_asymm$Time <- rep(c("Begin","End"),6)

# write out data for exploring later and avoiding rerunning the simulations
write.csv(bind_rows(MacArthur_displacements, LawlorSmith_displacements, McCann_displacements), file = "symmetric_displacement_data.csv")
write.csv(bind_rows(MacArthur_displacements_asymm, LawlorSmith_displacements_asymm, McCann_displacements_asymm), file = "asymmetric_displacement_data.csv")
```

# Abstract 

Ecological character displacement is an adaptive process that generally increases phenotypic diversity. 
Despite the fact that this diversification is due to an eco-evolutionary feedback between consumers competing for shared resources, its consequences for food-web dynamics have not been examined.
Here, I study a model of two consumers competing for two shared resources to examine how character displacement in consumers affects resource abundances and the resilience of food webs to perturbations.
I found that character displacement always strengthened consumer-resource interactions whenever consumers competed for resources that occurred in different habitats.
This increase in interaction strength resulted in lower resource abundances and less resilient food webs.
This occurred under different evolutionary tradeoffs and in both simple and more realistic foraging scenarios.
Taken together, my results show that the adaptive process of character displacement often comes with the ecological cost of decreasing food-web resilience. 

\newpage

# Introduction 

Ecological character displacement is an important adaptive process in generating biodiversity [@Schluter2000; @Pfennig2010]. 
This process results from "phenotypic evolution in a species generated or maintained by [exploitative] resource competition with one or more coexisting speciesâ€ [@Schluter2000]. 
Over the past 40 years, a large body of theoretical [e.g. @Lawlor1976; @Abrams1986; @Doebeli1996; @Taper1985; @McPeek2019] and empirical [reviewed in: @Schluter2000; @Dayan2005; @Stuart2013] work has examined which scenarios lead to phenotypic divergence or convergence of competing consumers.
The general result has been that, if resources are nutritionally substitutable [@Abrams1987; @Fox2008] and there is no other strong source of density dependence acting on consumers [@Abrams1986], then resource competition drives the adaptive divergence of competitors [@Lawlor1976; @Taper1985]. 
This adaptive process is not simply a response to static differences in resource distributions, but creates an eco-evolutionary feedback that drives further differentiation. 
This crucial insight was made by theoretical models that explicitly included resource dynamics as a mediator of competition in driving evolutionary change [@Lawlor1976; @Abrams1986; @Taper1985]. 

Although models that included resources gave insights to the evolution of character displacement, the ecological feedback onto consumer-resource dynamics has received surprisingly little attention. 
This is likely because the ecological feedback has been primarily studied through the lens of coexistence theory [@Lawlor1976; @Germain2018; @Bassar2017; @McPeek2019]. 
For example, early theoretical work by @Lawlor1976 showed that ecological character displacement promotes coexistence by favoring specialized consumers that experience reduced interspecific competition. 
Yet, this reduction in interspecific competition may, at the same time, increase interspecific interactions between specialized consumers and their resources. 
Both food-web theory and empirical studies have shown that increasing the strength of consumer-resource interactions often suppresses the abundance of resources, which if sufficient enough, can generate oscillations and less stable consumer-resource dynamics [@Rosenzweig1971; @Luckinbill1973; @Murdoch2002; @Murdoch2003; @McCann2011].
Thus, a food-web perspective, which accounts for both the direct and indirect effects of consumer-resource interactions, may yield new insight to the ecological consequences of character displacement.

Here, I address this knowledge gap by studying a mathematical model that examines how ecological character displacement affects consumer-resource dynamics in a food-web context. 
I address two questions: (1) How does ecological character displacement affect resource abundances? (2) How does character displacement affect food-web stability? 
To test the generality of these effects, I explored different assumptions of ecological foraging scenarios (Fig. \ref{fig:foraging_scenarios}) and evolutionary trade-offs in consumer foraging traits (Fig. \ref{fig:tradeoff}). 
I found that the adaptive process of character displacement often comes with an ecological cost; resulting in food webs with lower resource availability and less resilient to perturbations.

# Material and methods 

## Underlying Consumer-Resource Dynamics

To examine how ecological character displacement affects resource abundances and food-web stability, I analyzed a continuous-time model of two consumers ($C_1,C_2$) competing for two shared resources ($R_1,R_2$): 

$$\frac{dR_1}{dt}=r_1K_1(1-\frac{R_1}{K_1})-F_{11}(R_1)C_1-F_{21}(R_1)C_2,$$
$$\frac{dR_2}{dt}=r_2K_2(1-\frac{R_2}{K_2})-F_{12}(R_2)C_1-F_{22}(R_2)C_2,$$
$$\frac{dC_1}{dt}=e_{11}F_{11}(R_1)C_1+e_{12}F_{12}(R_2)C_1-m_1C_1,$$
$$\frac{dC_2}{dt}=e_{21}F_{21}(R_1)C_2+e_{22}F_{22}(R_2)C_2-m_2C_2,$$

where $r_i$ represents the intrinsic growth rate of resource $i$, $K_i$ represents the carrying capacity of resource $i$, $e_{ij}$ represents the conversion efficiency of resource $j$ into consumer $i$, and $m_i$ represents the mortality rate of consumer $i$. $F_{ij}(R_j)$ represents consumer $i$'s feeding rate on resource $j$ (i.e. functional response). 
This model is a useful characterization of a scenario where consumers compete for two distinct resources (e.g. zooplankton and benthic invertebrates) rather than if resources are better characterized by a continuous trait distribution (e.g. seed size, see @Taper1985 for an example). Importantly, inferences about ecological character displacement can only be made by comparing food webs with and without a competing consumer [@Schluter1992]; therefore, we arbitrarily removed $C_2$ from the system to compare and infer the effects of character displacement on food-web dynamics.

## Foraging Scenarios

I studied three different foraging scenarios (Fig. \ref{fig:foraging_scenarios}). 
In the first, I assume that consumers can forage for both resources simultaneously and their feeding rates increase linearly with resource abundance, such that:

$$F_{ii}(R_i)=a_{ii}R_i$$ 

where $a_{ii}$ is the attack rate of consumer $i$ on resource $i$. 
This first scenario is the starting point for many models of resource competition [@MacArthur1972]; however, it does not reflect many food webs where consumers are mobile and their foraging behavior links resources that occur in different habitats [@McCann2005]. 
A simple extension of the above scenario takes the form:

$$F_{ii}(R_i)=w_{ii}a_{ii}R_i$$

where $w_{ii}$ represents the proportion of time consumer $i$ spends foraging in a habitat where only resource $i$ is found (i.e. habitat preference). 
Note that since $w_{ii}$ is a proportion that $w_{ij}=1-w_{ii}$. 
Finally, it is well known that consumer feeding rates often saturate at high resource abundances [@Holling1959; @Rosenzweig1963; @Murdoch2003; @McCann2011] and that consumers do not usually spend a fixed proportion of time in a particular habitat [@McCann2005]. 
To account for these biological realities, I consider a more realistic functional response [derived by @McCann2005]:     

$$F_{ii}(R_i,R_j)=\frac{a_{ii}W_{ii}R_i}{1+a_{ii}h_{ii}W_{ii}R_i+a_{ij}h_{ij}W_{ij}R_j}$$

where consumer $i$'s feeding rate on resource $i$ is influenced by the abundance of each resource; saturates as resource abundances increase (due to handling times $h_{ii}$, $h_{ij}$); and consumer habitat preferences are modified by the relative abundance of resources, such that: $W_{ii}=\frac{w_{ii}R_i}{w_{ii}R_i+(1-w_{ij})R_j}$. 

Previous studies have analyzed the evolution of consumer attack rates in the first two foraging scenarios using an Adaptive Dynamics approach, with the general result being character divergence [@Lawlor1976; @Abrams1986]. 
I say consumers have undergone character divergence if there evolved attack rates are more specialized, measured as $|\frac{a_{ii}}{a_{ii}+a_{ij}}-0.5|$, when evolving with a competing consumer.
I also used an Adaptive Dynamics approach to analyze character displacement in the third foraging scenario, and I too observed character divergence (detailed analysis in Appendix S1 of Supplementary Information).

```{r foraging_scenarios, echo=FALSE, fig.pos="H", fig.cap="\\label{fig:foraging_scenarios}**Ecological foraging scenarios.** I examined whether the effect of ecological character displacement on food-web dynamics depended on whether consumers competed for resources that occurred in the same vs. different habitats. In both scenarios, I assumed consumer feeding rate increased linearly with resource density. Later, I relax this assumption and consider a more realistic functional response when resources occurred in different habitats. Note that C~i~ was always pre-adapted to R~i~ (a~ii~ > a~ij~)."}
knitr::include_graphics("ECD_model_foraging_scenarios")
```

## Food-web Dynamics

Given that character divergence was an expected result, I focus here on its consequences for food-web dynamics across these foraging scenarios.
To do this, I analyzed differences in resource abundances and food-web stability at equilibrium. 
An equilibrium is reached when the four rates of change in the above equations are 0, and solving the system at this point gives equilibrium abundances for each resource ($\hat R_1,\hat R_2$) and each consumer ($\hat C_1,\hat C_2$). 
At the coexistence equilibrium (i.e., where $\hat R_1,\hat R_2, \hat C_1,\hat C_2 > 0$), I calculated resource abundances and performed a local stability analysis [@Otto2007]. 
This stability analysis derives the dominant eigenvalue, $\lambda$, which determines whether (and how readily) the food web will return to equilibrium after a small perturbation. 

When possible, I derived analytical expressions for the relationship between consumer attack rates and food-web dynamics. 
To do this, I simplified the model by assuming that resources are equivalent ($r=r_1=r_2$ and $K=K_1=K_2$) as well as consumers ($e=e_{11}=e_{12}=e_{21}=e_{22}$; $h=h_{11}=h_{12}=h_{21}=h_{22}$; $m=m_1=m_2$), except that consumer attack rates and their habitat preferences (if present) are mirror images of each other ($a_{ii}=a_{11}=a_{22}$; $a_{ij}=a_{12}=a_{21}$; $w_{ii}=w_{11}=w_{22}$). 
Controlling for other sources of variability allowed me to isolate the general effects of character divergence.
All mathematical derivations were conducted in @Mathematica and are provided in the Supplementary Information (Appendix S1-3).

To gain insight to the eco-evolutionary feedback generated by character displacement, I conducted simulations using an Adaptive Dynamics approach. 
<!--
The evolutionary dynamics of character displacement have been well characterized in some of the ecological scenarios examined here [@Lawlor1976; @Abrams1986] and are not the focus of this work. 
Still, 
Although divergent character displacement occurs in all scenarios we examined, the magnitude of this divergence may be context dependent.
Therefore, I simulated the eco-evolutionary feedback between consumers and resources using an Adaptive Dynamics approach.
-->
Specifically, at each evolutionary time step, I created a mutant consumer by randomly choosing one and modifying its attack rate on one resource by either subtracting or adding a small constant (0.01 in the following simulations) with equal probability. 
The mutant's attack rate on the other resource was determined by a tradeoff, such that $\big(a_{ii}/{A}\big)^n+\big(a_{ij}/{A}\big)^n=1$, where $A$ is the total investment in attack rates and $n$ describes the shape of the tradeoff [@Sargent2006]. 
This function has the useful property that it differentiates between cases where intermediate combinations of $a_{ii}$ and $a_{ij}$ are higher than the extremes (when $n>1$, green line in Fig. \ref{fig:tradeoff}) or, conversely, where the two extremes are higher than intermediate investments (when $n<1$, orange line Fig. \ref{fig:tradeoff}). 
When $n=1$, the tradeoff function is linear, and all combinations of $a_{ii}$ and $a_{ij}$ have the same total attack rate (blue line in Fig. \ref{fig:tradeoff}). 
Assuming the mutant consumer was rare, I then determined whether the mutant had higher relative fitness than the resident consumer, and thus could invade and replace the resident consumer. 
If the mutant was able to invade, I updated the attack rate of the resident consumer to the mutant attack rate and allowed consumer and resource dynamics to reach a steady state. 
I then repeated the simulation up to 10,000 times, which was sufficient for consumers to either reach an evolutionary stable strategy [ESS, @Smith1973] or an evolutionary limit (e.g. $\frac{a_{ii}}{a_{ii}+a_{ij}}$ is constrained to a maximum of 1 and minimum of 0). 
Unless otherwise noted, I conducted simulations with the following parameter values: *r* = 1; *K* = 4; *e* = 0.8; *m* = 1; *A* = 2; *h* = 0.4; and *w_{ii}* = 0.6. 
I set an initial value of *a~ii~* = 1.2 and *a~ij~* depended on the value of *n*. 
I set initial consumer and resource abundances as: *R~1~* = *R~2~* = 2; *C~1~* = *C~2~* = 1.
All simulations were conducted in R [@R] and the code to reproduce these simulations is publically available on GitHub (https://github.com/mabarbour/ECD_model).

```{r plot tradeoff, include=FALSE}
initial_points <- bind_rows(params_2C_2R_MacArthur_linear, params_2C_2R_MacArthur_concaveDN, params_2C_2R_MacArthur_concaveUP) %>% mutate(n = c(n_linear, n_concaveDN, n_concaveUP))

tradeoff_plot <- bind_rows(concaveDN_df, linear_df, concaveUP_df) %>%
  ggplot(., aes(x=aii, y=aij, color = factor(n))) + 
  geom_line() + # size=1.5
  geom_point(data = initial_points, aes(x=a11, y=a12), size=3, show.legend=FALSE) + # size=5
  xlab(expression(bold(a[ii]))) +
  ylab(expression(bold(a[ij]))) +
  scale_color_manual(name="Evolutionary\ntradeoff (n)", values=cbPalette) #+
  #theme_cowplot(font_size = 30, line_size=2)# +
  #theme(axis.title = element_text(size = 30),
  #      axis.text = element_text(size = 20),
  #      legend.title = element_text(size = 25),
  #      legend.text = element_text(size = 20),
  #      legend.spacing = unit(1.0,'cm'))

save_plot(filename = "attack_tradeoffs.pdf", plot = tradeoff_plot, 
          base_height = 5, # 6
          base_width = 8) #9
```

```{r tradeoff, fig.pos="H", fig.cap="\\label{fig:tradeoff}**Evolutionary tradeoffs in consumer attack rates.** In each foraging scenario, I explored the effects of three different tradeoffs: intermediate combinations of attack rates (a~ii~, a~ij~) are higher than the extremes (green line, n > 1); extreme combinations of attack rates are higher than intermediate investments (orange line, n < 1); and all combinations of attack rates have the same total attack rate (blue line, n = 1). Points corresponding to attack rates at the beginning of the simulation. Note that C~i~ was always pre-adapted to R~i~ (a~ii~ > a~ij~)."}
knitr::include_graphics("attack_tradeoffs.pdf")
```

# Results

## Resources occur in same habitat

<!-- I haven't made clear that this explores a specific scenario, MacArthur's model 

In the simplest scenario, consumers can forage for both resources simultaneously and their feeding rates increase linearly with resource abundance, such that $F_{ji}(R_i)=a_{ji}R_i$ where $a_{ji}$ is the attack rate of consumer $j$ on resource $i$ [@MacArthur1972]. 
The evolution of consumer attack rates in this model (and several extensions) have been analyzed in detail [@Lawlor1976; @Abrams1986], with the general result being divergent character displacement. 
I say consumers have undergone divergent character displacement if there evolved attack rates are more specialized, measured as $|\frac{a_{ii}}{a_{ii}+a_{ij}}-0.5|$, when evolving with a competing consumer.
-->

In this first scenario, the abundance of resources at equilibrium are equivalent when both consumers and resources are present ($\hat R = \hat R_1 = \hat R_2$), and are determined by the following equation (derived in Appendix S**?**):

$$\hat{R}=\frac{1}{a_{ii}+a_{ij}}\cdot\frac{m}{e}$$
A key determinant of resource abundance in this model is the consumer's total attack rate, $a_{ii}+a_{ij}$. Therefore, the effect of character displacement on food-web dynamics depends on how the tradeoff influences the evolution of consumer attack rates.

My simulations show that the shape of the tradeoff qualitatively affects the relationship between character displacement and resource abundances (Fig. \ref{fig:plot_fig3}). 
For example, if consumer's are constrained by a linear tradeoff (blue lines), then there is no net change in total attack rate (Fig. \ref{fig:plot_fig3}) and character displacement has no effect on resource abundances (Fig. \ref{fig:plot_fig3}). 
If the tradeoff is concave down (green lines), then resource abundances can actually increase under character displacement (Fig. \ref{fig:plot_fig3}). 
This is because the total attack rate of consumers is maximized at intermediate values ($a_{ii}=a_{ij}$) and decreases as consumers diverge (Fig. \ref{fig:plot_fig3}). 
When the tradeoff is concave up (orange lines), character displacement suppresses resource abundances due to the increase in total attack rates (Fig. \ref{fig:plot_fig3}). 
Although the equation I derived for resource abundances was for the scenario where both consumers and both resources were present, it accurately predicts the abundance of resources when a single consumer reaches its ESS (triangles on respective colored lines in Fig. \ref{fig:plot_fig3}). This is because a single consumer evolves to be a generalist that has equal attack rates on each resource (triangles at 0.5 along x-axis in Fig. \ref{fig:MacArthur_Plot}), resulting in equivalent resource abundances. 

The effect of character displacement on resources corresponds to its impact on food-web stability. 
For example, when character displacement decreases resource abundances (orange points in \ref{fig:plot_fig3}), there is a decrease in food-web stability (\ref{fig:plot_fig3}). 
Similarly, if character displacement does not alter resource abundances (blue and green points in \ref{fig:plot_fig3}), then there is no change in food-web stability (\ref{fig:plot_fig3}).  

```{r MacArthur_Resources, include=FALSE, fig.cap="\\label{fig:MacArthur_Resources}Effect of character displacement on total attack rates (A) and resource abundances (B) when consumers can forage for both resources simultaneously."}
Mac_attack <- ggplot(tradeoff_df, aes(x=aii/(aii+aij), y=aii+aij, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(MacArthur_displacements, Time=="End"), aes(x = a11/(a11+a12), y=a11+a12, fill=factor(n), shape=Competitor), size=3, color="white") + 
  #geom_point(data = filter(MacArthur_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=a11+a12, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(expression(a[ii]+a[ij])) +
  #xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Mac_resources <- cbind.data.frame(select(tradeoff_df, n, aii, aij), MacArthur_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=R1+R2, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(MacArthur_displacements, Time=="End"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=3, color="white") +
  #geom_point(data = filter(MacArthur_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(expression(R[i]+R[j])) +
  #xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Mac_plots <- plot_grid(Mac_attack + theme(legend.position = "none"), Mac_resources, 
                       ncol=2, labels = "AUTO", rel_widths = c(0.65,1))
Mac_plots
```

```{r Stability, include=FALSE, fig.cap="\\label{fig:Stability}Effect of character displacement on local stability when consumers can (A) and cannot (B) forage for both resources simultaneously. Small and large points correspond to initial and evolved strategies, respectively."}
Stability_Mac <- cbind.data.frame(select(tradeoff_df, n, aii, aij), MacArthur_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=-1*max.Re.eigen, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(MacArthur_displacements, Time=="End"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=3, color="white", show.legend=FALSE) + #size=5,
  geom_point(data = filter(MacArthur_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=1.5, color="white") +
 #xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  ylab(expression("Stability "(-lambda[max]))) + #ylab(expression(-1%*%"Re"(lambda[max]))) +
  scale_shape_manual(values=c(24,21))  +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  geom_hline(yintercept=0, color="grey") +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Stability_LS <- cbind.data.frame(select(tradeoff_df, n, aii, aij), LawlorSmith_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=-1*max.Re.eigen, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(LawlorSmith_displacements, Time=="End"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=3, color="white", show.legend=FALSE) +
  geom_point(data = filter(LawlorSmith_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  #xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  ylab(expression("Stability "(-lambda[max]))) + #ylab(expression(-1%*%"Re"(lambda[max]))) +
  scale_shape_manual(values=c(24,21))  +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  geom_hline(yintercept=0, color="grey") +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Stability_plots <- plot_grid(Stability_Mac + theme(legend.position = "none"), Stability_LS + theme( axis.title.y = element_blank()),
                             ncol = 2, labels = "AUTO", rel_widths = c(0.75,1))
Stability_plots
```

```{r MacArthur Model, include=FALSE}
plot_macarthur_model <- plot_grid(
  tradeoff_plot + theme(legend.position = "none"), 
  Mac_attack  + theme(legend.position = "none"), 
  Mac_resources  + theme(legend.position = "none"),
  Stability_Mac  + theme(legend.position = "none"), ncol=2, align='hv', labels = "AUTO")

save_plot(filename="Figure_ECD_MacArthur.pdf", plot=plot_macarthur_model, base_height = 6, base_width = 6)
```

```{r MacArthur_Plot, include=FALSE, eval=FALSE, fig.pos="H", fig.cap="\\label{fig:MacArthur_Plot}**Effect of character displacement when consumers can forage for both resources simultaneously.** Panel (A) shows the different tradeoffs in consumer attack rates used in the simulation (green, *n* = 1.15; blue, *n* = 1; orange, *n* = 0.85). Panel (B) shows how the shape of this tradeoff affects the magnitude of character displacement and the evolution of total attack rates in the consumer community. Large circles (two consumers) and triangles (one consumer) correspond to the end points of the eco-evolutionary simulation. Panels (C) and (D) show how different tradeoffs indirectly affect total resource abundances (C) and food-web stability (D). These simulations used the following parameter values: *r* = 1; *K* = 4; *e* = 0.8; *m* = 1; *A* = 2. We set an initial value of *a~ii~* = 1.2 and *a~ij~* depended on the value of *n*. We set initial consumer and resource abundances as: *R~i~* = *R~j~* = 2; *C~i~* = *C~j~* = 1."}
knitr::include_graphics("Figure_ECD_MacArthur.pdf")
```


## Resources occur in different habitats
<!--
The previous model, although the starting point for many models of competition, does not reflect many food webs where consumers are mobile and their foraging behavior links resources that occur in distinct habitats [@McCann2005]. 
The only character displacement model that I am aware of that examined the effect of resources in different habitats was studied by @Lawlor1976. This model is the same as before, except now the consumer's feeding rate takes the form:

$$F_{ji}(R_i)=w_{ji}a_{ji}R_i$$

where $w_{ji}$ represents the proportion of time consumer $j$ spends foraging in a habitat where only resource $j$ is found (i.e. habitat preference). Note that since $w_{ji}$ is a proportion that $w_{jj}=1-w_{ji}$. As with attack rates, I assume that consumer habitat preferences are mirror images of each other ($w=w_{11}=w_{22}$). In @Lawlor1976's detailed evolutionary analysis of this model, they always observed divergent character displacement.

To examine the ecological consequences of this divergence, I again derive the equilibrium solution when both consumers and both resources are present. 
As before, resource abundances are equivalent at this equilibrium ($\hat R = \hat R_1 = \hat R_2$ when both consumers and resources present), but are now determined by the following equation (derivation in supplementary material):
-->
In this second scenario, I again see that resource abundances are equivalent when both consumers and resources are present ($\hat R = \hat R_1 = \hat R_2$), but are now determined by the following equation (derived in Appendix S**?**):

$$\hat{R}=\frac{1}{w_{ii}a_{ii}+(1-w_{ii})a_{ij}}\cdot\frac{m}{e}$$

This equation implies that if consumers evolve to become specialists on resources that occur in their preferred habitat (e.g. $w_{ii}>0.5$ and $a_{ii}>a_{ij}$), then the effective attack rate of consumers ($wa_{ii}+(1-w_{ii})a_{ij}$) will always increase, regardless of the tradeoff (Fig. \ref{fig:plot_fig3}). 
Thus, character divergence always results in resource suppression (Fig. \ref{fig:plot_fig3}). 
Note that the shape of the tradeoff can modify the effect of character displacement. 
This is not so much due to the tradeoff affecting the magnitude of displacement (it does, but the effect is minor), but because the form of the tradeoff affects resource abundances when a single consumer has reached an evolutionary stable strategy (ESS, triangles in Fig. \ref{fig:plot_fig3}). 
In contrast, resource abundances reach a similar value when consumers evolve in the presence of a competitor (circles in Fig. \ref{fig:plot_fig3}), because character displacement tends to reach a constraint of complete specialization. 
It is worth noting that resource abundances are consistently higher at the single consumer ESS compared to the predictions I derived for when both consumers are present (deviation of triangles from respective colored lines in Fig. \ref{fig:plot_fig3}). 
This is because consumers actually evolve to be slightly specialized on the resources that occur in their non-preferred habitat (deviation of triangles from 0.5 along x-axis in Fig. \ref{fig:plot_fig3}). 

As seen previously, the effect of character displacement on resource abundances qualitatively corresponds to its effect on food-web stability (Fig. \ref{fig:plot_fig3}C). 
Specifically, character divergence decreases food-web stability, regardless of the tradeoff in attack rates.
This is not simply a consequence of having an additional consumer in the system, but emerges from the eco-evolutionary feedback between character displacement and resource suppression (Fig. \ref{fig:plot_fig3}C). 
For example, when the tradeoff is concave up (orange), then the four-species (small circle) food web actually starts off as more stable than the three-species one (small triangle); however, this pattern switches by the end of the eco-evolutionary simulation (large points). 

```{r LS_Resources, include=FALSE, fig.cap="\\label{fig:LS_Resources}Effect of character displacement on effective attack rates (A) and resource abundances (B) when consumers cannot forage for resources simultaneously."}
LS_attack <- ggplot(tradeoff_df, aes(x=aii/(aii+aij), y=wii*aii+wij*aij, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(LawlorSmith_displacements, Time=="End"), aes(x = a11/(a11+a12), y=w11*a11+w12*a12, fill=factor(n), shape=Competitor), size=3, color="white") + 
  #geom_point(data = filter(LawlorSmith_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=w11*a11+w12*a12, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(expression(w*a[ii]+(1-w)*a[ij])) +
  #xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

LS_resources <- cbind.data.frame(select(tradeoff_df, n, aii, aij), LawlorSmith_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=R1+R2, color=factor(n))) + 
  geom_line() +
  geom_point(data = filter(LawlorSmith_displacements, Time=="End"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=3, color="white") + 
  #geom_point(data = filter(LawlorSmith_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(expression(R[i]+R[j])) +
  #xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

LS_plots <- plot_grid(LS_attack + theme(legend.position = "none"), LS_resources, 
                      ncol=2, labels = "AUTO", rel_widths = c(0.65,1))
LS_plots
```

```{r LS Model, include=FALSE}
plot_LS_model <- plot_grid(
  LS_attack  + theme(legend.position = "none"), 
  LS_resources  + theme(legend.position = "none"),
  Stability_LS  + theme(legend.position = "none"), ncol=2, align='hv', labels = "AUTO")

save_plot(filename="Figure_ECD_LS.pdf", plot=plot_LS_model, base_height = 6, base_width = 6)
```

```{r LS_Plot, include=FALSE, eval=FALSE, fig.cap="\\label{fig:LS_Plot}**Effect of character displacement when consumers *cannot* forage for both resources simultaneously.** Different line colors correspond to different tradeoff values (green, *n* = 1.15; blue, *n* = 1; orange, *n* = 0.85). Large circles (two consumers) and triangles (one consumer) correspond to the end points of the eco-evolutionary simulation, whereas as small shapes correspond to the starting points (only in panel C). Panel (A) shows how, regardless of the tradeoff, character displacement increases the effective attack rate of the consumer community. This always resulted in a suppression of resource abundances (B) and concomitant decrease in food-web stability (C). These simulations used the following parameter values: *r* = 1; *K* = 4; *e* = 0.8; *m* = 1; *A* = 2; *w~ii~*=0.6; *w~ij~*=0.4. We set an initial value of *a~ii~* = 1.2 and *a~ij~* depended on the value of *n*. We set initial consumer and resource abundances as: *R~i~* = *R~j~* = 2; *C~i~* = *C~j~* = 1."}
knitr::include_graphics("Figure_ECD_LS.pdf")
```

```{r Fig 3, include=FALSE}
# plot.margin = unit(c(0, 0, 0, 0), "cm") to shrink space between plots

Macs <- plot_grid(
  Mac_attack + xlab("") + ylab(bquote(atop("Effective attack rate","("*a[ii]+a[ij]*")"))) + ggtitle("Resources: Same Habitat\n") + theme(legend.position = "none",  axis.text.x = element_blank(), plot.title = element_text(size = 10), axis.title.y=element_text(vjust=0)), #  + scale_y_continuous(breaks=c(1.8,2.0,2.2)) 
  Mac_resources + xlab("") + ylab(bquote(atop("Resource abundance","("*R[1]+R[2]*")"))) + theme(legend.position = "none", axis.text.x = element_blank(), axis.title.y=element_text(vjust=0)), # + scale_y_continuous(breaks=c(1.0,1.2,1.4), limits=c(1.0,1.45)) 
  Stability_Mac + xlab("")  +  ylab(bquote(atop("Food-web stability","("*-lambda[max]*")"))) + theme(legend.position = "none", axis.title.y=element_text(vjust=0)), # + scale_y_continuous(breaks=c(0,0.1))
  ncol=1, align='v'#, labels = "AUTO"
) # c(0,0.02,0.04,0.06,0.08,0.1)


LSs <- plot_grid(
  LS_attack  + xlab("") + ylab(bquote(w*a[ii]+"("*1-w*")"*a[ij])) + ggtitle("Resources: Different Habitats\n") + theme(legend.position = "none", axis.text.x = element_blank(), plot.title = element_text(size = 10)), #+ scale_y_continuous(breaks=c(0.8,1.0,1.2)) 
  LS_resources+ xlab("") + ylab("") + theme(legend.position = "none", axis.text.x = element_blank()), #+ scale_y_continuous(breaks=c(2.0,2.5,3.0), limits=c(2.0,3.2))  
  Stability_LS + xlab("") + ylab("") + theme(legend.position = "none"), # + scale_y_continuous(breaks=c(0,0.1,0.2))
  ncol=1, align='v'
)


plot_fig3 <- plot_grid(Macs, LSs, ncol=2, rel_widths = c(1,0.9)) 
plot_fig3_sub <- add_sub(plot_fig3, expression(paste("Specialization ", bgroup("(",frac(a[ii],a[ii]+a[ij]),")"))), vjust = 0) 

save_plot(filename="Figure_3.pdf", plot=plot_fig3_sub, base_height = 8, base_width = 6)
```

```{r plot_fig3, echo=FALSE, fig.pos="H", fig.cap="\\label{fig:plot_fig3}**Effect of character displacement on food-web dynamics.** Different line colors correspond to different tradeoffs in attack rates (green, *n* = 1.15; blue, *n* = 1; orange, *n* = 0.85; as in Fig. 1). Large circles (two consumers) and triangles (one consumer) correspond to the end points of the eco-evolutionary simulation, whereas as small shapes correspond to the starting points (only in panel C). Different panels show the effect of character displacement on effective attack rates (A), resource abundances (B), and food-web stability (C) when resources occur in the same vs. different habitats. Note that the equation for effective attack rate depends on the foraging scenario. These simulations used the following parameter values: *r* = 1; *K* = 4; *e* = 0.8; *m* = 1; *A* = 2; *w~ii~*=0.6; *w~ij~*=0.4. I set an initial value of *a~ii~* = 1.2 and *a~ij~* depended on the value of *n*. I set initial consumer and resource abundances as: *R~i~* = *R~j~* = 2; *C~i~* = *C~j~* = 1."}
knitr::include_graphics("Figure_3.pdf")
```


## Adding a more realistic functional response

<!--
So far I have only considered a simple functional response, where consumer feeding rates increase linearly with resource abundances when foraging in either the same or distinct habitats. 
We know, however, that consumer feeding rates often saturate at high resource abundances [@Holling1959; @Rosenzweig1963; @Murdoch2003; @McCann2011]. 
We also know that consumers do not usually spend a fixed proportion of time in a particular habitat, but their habitat preferences may be modified by resource abundances [@McCann2005]. 
To account for these biological realities, I consider a more realistic functional response [derived by @McCann2005]:     

$$F_{ii}(R_i,R_j)=\frac{a_{ii}W_{ii}R_i}{1+a_{ii}hW_{ii}R_i+a_{ij}hW_{ij}R_j}$$

where consumer $i$'s feeding rate on resource $i$ is influenced by the abundance of each resource; saturates as resource abundances increase (due to handling time $h$); and consumer habitat preferences are modified by the relative abundance of resources, such that:

$$W_{ii}=\frac{wR_i}{wR_i+(1-w)R_j}$$ 

The evolutionary dynamics of consumer attack rates have not been examined in this model, but as with the other models [@LawlorSmith1976], I find that divergent character displacement is inevitable. 
This is because, in the absence of competition, consumer evolution is determined by both resource abundances and their habitat preferences, and reach an evolutionary stable strategy (ESS) when:

$$w_{ii}R_i^2\delta_{ii}=w_{ij}R_j^2\delta_{ij}$$ 
where $\delta_{ii}$ represents a small mutation in $a_{ii}$ and we assume a negative tradeoff in attack rates, such that $\delta_{ij}=-f(\delta_{ii})$. 
The square-terms for resource abundances indicate that they largely govern the evolutionary dynamics. 
This scenario favors the evolution of a generalist phenotype, as resource specialization will decrease that resource's abundance, thus favoring evolution toward the other resource until an ESS is reached.
In contrast, in the presence of a competitor, resource abundances will be equivalent at equilibrium (derivation in Appendix S2) and consumers reach an ESS when:

$$w_{ii}\delta_{ii}=w_{ij}\delta_{ij}$$ 

Assuming consumers have a preferred resource (i.e. $w_{ii}>0.5$), then consumers will only reach an ESS when $|\delta_{ii}|<|\delta_{ij}|$ (e.g. green line, Fig. \ref{MacArthur_Plot}A). 
Otherwise, they will evolve to be complete specialists on their preferred resource.
-->

In the third foraging scenario, I observed the same general effect of character divergence as the previous scenario (resources in different habitats, but linear functional response).
<!--Divergent character displacement in this foraging scenario has the same general effect on food-web dynamics as the previous scenario (resources in different habitats, but linear functional response). 
<!--In terms of food-web dynamics, I observe the same general effect of ecological character displacement as before when resources occurred in distinct habitats, but consumers had a simpler functional response. -->
This is because resource abundances at equilibrium are governed by a similar dynamic (derived in Appendix S**?**):
<!--
Even after adding more biological realism, I still observe the same qualitative relationship between character displacement and resource suppression (Fig. \ref{fig:McCann_Plot} in Appendix). This is because resource competition always leads to character divergence and equilibrium resource abundances are governed by similar dynamics  (derivation in supplementary material):
-->

$$\hat{R}=\frac{1}{wa_{ii}+(1-w)a_{ij}}\cdot\frac{m}{e-hm}$$

And since evolution favors consumer divergence onto their preferred resources (see Appendix S1), the effective attack rate of consumers ($wa_{ii}+(1-w)a_{ij}$) will always increase (Fig. \ref{fig:McCann_Plot}A), resulting in lower resource abundances and decreased food-web stability (Appendix S?).

In the previous foraging scenarios, character displacement influences food-web stability, but all of the food webs ultimately return to a stable equlibrium (because $\lambda_{max}<0$, see Appendix S1 and S2). 
In this more realistic model, however, whether the food web is locally stable depends on consumer and resource parameters. 
Specifically, I found that the four-species food web will transition from having a locally stable equilibrium to a limit cycle under the following conditions (derived using Routh-Hurwitz criteria in Appendix S**?**):

$$w_{ii}a_{ii}+(1-w_{ii})a_{ij} > \frac{e+hm}{hK(e-hm)}$$

<!--Previously, I showed that character displacement always increases the effective attack rate of consumers ($wa_{ii}+(1-w)a_{ij}$), regardless of the the shape of the tradeoff (Fig. \ref{fig:LS_Plot}A).--> 
Thus, character displacement always pushes the food web toward an unstable stucture in this more realistic foraging scenario (Fig. \ref{fig:bifur_plot}). 

```{r McCann_Resources, include=FALSE, fig.cap="\\label{fig:McCann_Resources}Effect of character displacement on total attack rates (A) and resource abundances (B) when consumers exhibit a more realistic functional response."}
McCann_attack <- ggplot(tradeoff_df, aes(x=aii/(aii+aij), y=wii*aii+wij*aij, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(McCann_displacements, Time=="End"), aes(x = a11/(a11+a12), y=w11*a11+w12*a12, fill=factor(n), shape=Competitor), size=3, color="white") + 
  #geom_point(data = filter(McCann_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=w11*a11+w12*a12, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(bquote(atop("Effective attack rate","("*w*a[ii]+"("*1-w*")"*a[ij]*")"))) +
  #ylab(expression(w*a[ii]+(1-w)*a[ij])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21))  +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

McCann_resources <- cbind.data.frame(select(tradeoff_df, n, aii, aij), McCann_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=R1+R2, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(McCann_displacements, Time=="End"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=3, color="white") + 
  #geom_point(data = filter(McCann_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(bquote(atop("Resource abundance","("*R[1]+R[2]*")"))) +
  #ylab(expression(R[i]+R[j])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21))  +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

McCann_plots <- plot_grid(McCann_attack + theme(legend.position = "none"), McCann_resources, 
                          ncol=2, labels = "AUTO", rel_widths = c(0.65,1))
McCann_plots
```


```{r Stability_McCann, include=FALSE, fig.cap="\\label{fig:Stability_McCann}Effect of character displacement on local stability when consumers exhibit a more realistic functional response."}
Stability_McCann <- cbind.data.frame(select(tradeoff_df, n, aii, aij), McCann_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=-1*max.Re.eigen)) + 
  geom_line(aes(color=factor(n))) +
  #geom_point(data = filter(McCann_displacements, Time=="End"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=3, color="white", show.legend = FALSE) +
  #geom_point(data = filter(McCann_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  geom_point(data = McCann_displacements, aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor, size=Time), color="white", inherit.aes = FALSE) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  ylab(bquote(atop("Food-web stability","("*-lambda[max]*")"))) +
  #ylab(expression("Stability "(-lambda[max]))) + 
  scale_shape_manual(values=c(24,21))  +
  scale_size_manual(values=c(1.5,3)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  geom_hline(yintercept=0, color="grey") +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Stability_McCann
```

```{r McCann Model, include=FALSE}
McCann_legend <- get_legend(Stability_McCann)

plot_McCann_model <- plot_grid(
  McCann_attack    + theme(legend.position = "none") + xlab(""), 
  McCann_resources    + theme(legend.position = "none") + xlab(""),
  Stability_McCann    + theme(legend.position = "none") + xlab(""), ncol=2, align='hv') # , labels = "AUTO"

plot_McCann_model <- add_sub(plot_McCann_model, label = expression(paste("Specialization ", bgroup("(",frac(a[ii],a[ii]+a[ij]),")"))))

#plot_McCann_model <- ggdraw(plot_McCann_model) + draw_grob(McCann_legend, x = 0.7, y=-0.2)

save_plot(filename="Figure_ECD_McCann.pdf", plot=plot_McCann_model, base_height = 6, base_width = 6)
# moved to supplementary information
```

```{r bifurcation, echo=FALSE, cache=TRUE}

## set state variables; same as previous models but in vector form
i.state.2C_2R <- c(R1 = R1, R2 = R2, C1 = C1, C2 = C2) 
i.state.1C_2R <- c(R1 = R1, R2 = R2, C1 = C1)

## set duration of simulations
Time <- 1000

# when r = 2.5, A = 3.3 and concaveUp=0.85, we get consmers evolving toward instability; we don't get this when n=n_linear but we do if we increase mut.size=0.01 (order of magnitude) and even when r=1!

## IDEAL PARAMETERS RIGHT NOW: A=3.3, r=1, mut.size=0.01, n=n_linear (excellent looking figure with bifurcation just after0.8)

## set up general code for bifurcation plot; increase to get bifurcation
# when A = 2.5 get strong divergence
# at 2.9, consumer doesn't divergence, C1 becomes generalist though
# at 2.8, there is less divergence...
A <- 3.3
# K <- K+0.5 # increasing K to 4.5 creates a bifurcation at extreme specialization, but the consumer no longer evolves...
#r <- r #2.5 # r=1.5, now the consumer is still diverging when A = 2.9... at 3.3 though, there is no longer divergence in two consumer situation; get divergence again when r=2
#aii <- 2.4
#aij <- 2.0

# assuming linear trade-off in attack rates for simulation; sometimes, the consumer doesn't evolve toward asymmetry though...
#linear_df <- data.frame(n = n_linear, aii = seq(0,A,0.01)) %>% mutate(aij = A*(1-(aii/A)^n_linear)^(1/n_linear))
aii_seq <- seq(A/2, A, by = 0.01)#[1:75] # seq(aii, A, by = 0.01)[1:75]
aij_seq <- (A*(1-(aii_seq/A)^n_linear)^(1/n_linear)) # n_linear #[1:75] #seq(A/2, 0, by = -0.01)[1:75]


## Bifurcation plot code
# this code loops over the sequence of different parameter values
out <- list()
for (i in 1:length(aii_seq)) {
   
  r1 <- r2 <- r 
  K1 <- K2 <- K 
  e11 <- e12 <- e21 <- e22 <- e 
  h11 <- h12 <- h21 <- h22 <- h 
  m1 <- m2 <- m 
  w11 <- w22 <- wii
  w12 <- w21 <- wij
  
  # set params 
  param.loop <- c(r1 = r1, r2 = r2, K1 = K1, K2 = K2,
                  e11 = e11, e12 = e12, e21 = e21, e22 = e22,
                  h11 = h11, h12 = h12, h21 = h21, h22 = h22,
                  a11 = aii_seq[i], a12 = aij_seq[i], a21 = aij_seq[i], a22 = aii_seq[i],
                  m1 = m1, m2 = m2, w11 = w11, w22 = w22, w12 = w12, w21 = w21)
  
  # Run the experiment.
  init <- ode(i.state.2C_2R, 
              1:Time, McCann_2C_2R, param.loop)
  # Rerun the experiment with the state variables at the end of the initial simulation. This will enable me to determine the range of state variables around the equilibrium.
  temp <- ode(init[Time,-1], 1:Time, McCann_2C_2R, param.loop)[,-1]
  out[[i]] <- cbind(temp, Rt = temp[,"R1"] + temp[,"R2"], Ct = temp[,"C1"] + temp[ ,"C2"])
}

sim.list <- list()
for (i in 1:length(aii_seq)) {
  sim.list[[i]] <- data.frame(rep = i,
                              R_max = max(out[[i]][900:1000,"Rt"]),
                              R_min = min(out[[i]][900:1000,"Rt"]),
                              C_max = max(out[[i]][900:1000,"Ct"]),
                              C_min = min(out[[i]][900:1000,"Ct"]))
}


sim.df <- ldply(sim.list) %>%
  mutate(a11 = aii_seq,
         a12 = aij_seq) %>%
  gather(state, value, -rep, -a11, -a12) %>%
  separate(state, into = c("species","max_min"))


## Simulate 3 species food web ----

out_3 <- list()
for (i in 1:length(aii_seq)) {
   
  r1 <- r2 <- r
  K1 <- K2 <- K
  e11 <- e12 <- e21 <- e22 <- e
  h11 <- h12 <- h21 <- h22 <- h
  m1 <- m2 <- m
  
  # set params 
  param.loop <- c(r1 = r1, r2 = r2, K1 = K1, K2 = K2,
                  e11 = e11, e12 = e12, 
                  h11 = h11, h12 = h12,
                  a11 = aii_seq[i], a12 = aij_seq[i], 
                  m1 = m1, w11 = w11, w12 = w12)
  
  # Run the experiment.
  init <- ode(i.state.1C_2R, 
              1:Time, McCann_1C_2R, param.loop)
  # Rerun the experiment with the state variables at the end of the initial simulation; this will enable me to determine the range of state variables around the equilibrium.
  temp <- ode(init[Time,-1], 1:Time, McCann_1C_2R, param.loop)[,-1]   
  out_3[[i]] <- cbind(temp, Rt = temp[,"R1"] + temp[,"R2"])
}

sim.list_3 <- list()
for (i in 1:length(aii_seq)) {
  sim.list_3[[i]] <- data.frame(rep = i,
                                R_max = max(out_3[[i]][900:1000,"Rt"]),
                                R_min = min(out_3[[i]][900:1000,"Rt"]),
                                C_max = max(out_3[[i]][900:1000,"C1"]),
                                C_min = min(out_3[[i]][900:1000,"C1"]))
}


sim.df_3 <- ldply(sim.list_3) %>%
  mutate(a11 = aii_seq,
         a12 = aij_seq) %>% 
  gather(state, value, -rep, -a11, -a12) %>%
  separate(state, into = c("species","max_min"))
```

```{r bifurcation simulation, include=FALSE, cache=TRUE}
## eco-evo sims

## respecify initial attack rates based on new A-value
aii <- A*0.61

# params
params_2C_2R_McCann_linear_bifur <- data.frame(general_parameters,
                                               a11 = aii,
                                               a12 = eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_linear)), 
                                               a21 = eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_linear)), 
                                               a22 = aii,
                                               w11 = wii,
                                               w12 = wij,
                                               w21 = wij,
                                               w22 = wii,
                                               h11 = h,
                                               h12 = h,
                                               h21 = h,
                                               h22 = h)
                                            
params_1C_2R_McCann_linear_bifur <- params_2C_2R_McCann_linear_bifur[c("r1","r2","K1","K2","e11","e12","a11","a12","m1","w11","w12","h11","h12")]

# eco-evo simulations
sim_2C_2R_McCann_linear_bifur <- eco_evo_CR(init_parameters = params_2C_2R_McCann_linear_bifur, 
                                             init_states = states_2C_2R, # same as previous models
                                             eco_CR_model = McCann_2C_2R, 
                                             AD_CR_models = c(mC1_McCann, mC2_McCann),
                                             species_traits = c(1,2), 
                                             eco_param_names = c("a11","a22"), 
                                             eco_tradeoff_names = c("a12","a21"),  
                                             evo_param_names = c("a11m","a22m"),  
                                             evo_tradeoff_names = c("a12m","a21m"), 
                                             tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                             extra_tradeoff_params = c(A=A, n=n_linear)) 
sim_1C_2R_McCann_linear_bifur <- eco_evo_CR(init_parameters = params_1C_2R_McCann_linear_bifur, 
                                             init_states = states_1C_2R, # same as previous models
                                             eco_CR_model = McCann_1C_2R, 
                                             AD_CR_models = c(mC1_McCann),
                                             species_traits = c(1), 
                                             eco_param_names = c("a11"), 
                                             eco_tradeoff_names = c("a12"),  
                                             evo_param_names = c("a11m"),  
                                             evo_tradeoff_names = c("a12m"), 
                                             tradeoff_functions = c(a12_tradeoff),
                                             extra_tradeoff_params = c(A=A, n=n_linear)) 

# save simulation output 
write.csv(sim_2C_2R_McCann_linear_bifur, "sim_2C_2R_McCann_linear_bifur.csv")
write.csv(sim_1C_2R_McCann_linear_bifur, "sim_1C_2R_McCann_linear_bifur.csv")
```

```{r bifur evo plot, echo=FALSE}
McCann_displacements_bifur <- bind_rows(
  mutate(sim_2C_2R_McCann_linear_bifur, Model = "McCann", n = n_linear, Competitor = "Yes")[c(1,nrow(sim_2C_2R_McCann_linear_bifur)), ], 
  mutate(sim_1C_2R_McCann_linear_bifur, Model = "McCann", n = n_linear, Competitor = "No")[c(1,nrow(sim_1C_2R_McCann_linear_bifur)), ]) 
McCann_displacements_bifur$Time <- rep(c("Begin","End"),2)

## put it all together

# consumer abundances
#bind_rows(mutate(sim.df, size = 4), mutate(sim.df_3, size = 3)) %>%
#  filter(species == "C") %>%
#  ggplot(., aes(x = a11/(a11+a12), y = value, group=interaction(max_min, size), color=as.factor(size))) +
#  geom_line() +
#  ylab("Consumer abundance (max and min)")

#get_stability_boundary <- bind_rows(mutate(sim.df, Competitor = "Yes"), mutate(sim.df_3, Competitor = "No")) %>%
#  filter(species == "R") %>%
#  spread(max_min, value)

# with eco-evo begin and end points
bifurcation_plot <- bind_rows(mutate(sim.df, Competitor = "Yes"), mutate(sim.df_3, Competitor = "No")) %>%
  filter(species == "R") %>%
  ggplot(., aes(x = a11/(a11+a12), y = value, group=interaction(max_min, Competitor))) +
  geom_line(aes(linetype=Competitor), color=cbPalette[2]) +
  geom_point(data = McCann_displacements_bifur, aes(x = a11/(a11+a12), y=R1+R2, shape=Competitor, size=Time), color=cbPalette[2], fill=cbPalette[2], inherit.aes = FALSE) +
  #geom_point(data = filter(McCann_displacements_bifur, Time=="End"), aes(x = a11/(a11+a12), y=R1+R2, shape=Competitor), color="white", fill=cbPalette[2], size=6, inherit.aes = FALSE) +
  #geom_point(data = filter(McCann_displacements_bifur, Time=="Begin"), aes(x = a11/(a11+a12), y=R1+R2, shape=Competitor), color="white", fill=cbPalette[2], size=3, inherit.aes = FALSE) +
  scale_shape_manual(values=c(24,21))  +
  scale_size_manual(values=c(3,6)) +
  scale_linetype_manual(values=c("dotted","solid")) +
  ylab(bquote(atop("Resource abundance","("*R[1]+R[2]*": max and min)"))) +
  xlab(expression(paste("Specialization ", bgroup("(",frac(a[ii],a[ii]+a[ij]),")")))) +
  #guides(fill = guide_legend(override.aes=list(shape=21))) +
  geom_segment(x=0.815, xend=0.815, y=0, yend=2.65, arrow = arrow(length = unit(0.03, "npc")), color="grey", fill="grey") +
  geom_text(x=0.77, y=2, label="Stability\nboundary", color="grey") +
  theme_cowplot(font_size = 18)
  #geom_vline(xintercept = 0.82, linetype="dotted", color="grey")

save_plot(filename = "bifurcation_plot.pdf", bifurcation_plot, base_width = 8.5, base_height = 6)
```

```{r bifur_plot, echo=FALSE, fig.pos="H", fig.cap="\\label{fig:bifur_plot}**Character divergence creates unstable food webs**. I simulated the eco-evolutionary dynamics of character displacement assuming a more realistic functional response for consumers. The results are qualtitatively similar for consumer dynamics (not shown). Note that the lines illustrate the ecological consequences across the range of consumer specialization, while the points are the results of an eco-evolutionary simulation. In this simulation, this symmetry in attack rates may be broken, which is why the point of instability does not exactly match the lines. I stopped the simulations once consumers reached an evolutionary stable strategy, a constraint of maximum specialization, or created an unstable food web. I do not project beyoned this, because the dynamics of mutant invaders becomes unclear when resource distributions are unstable. The grey arrow denotes the boundary of local stability."}
knitr::include_graphics("bifurcation_plot.pdf")
```

## Robustness to consumer asymmetry

The previous analytical results and simulations make a strong assumption that competing consumers start off as perfect mirror images of each other in their attack rates (i.e. symmetry). 
Yet, theory indicates a predictable asymmetry between initial consumer attack rates. 
This predictable asymmetry emerges from a process of community assembly where a single consumer invades a system, reaches an ESS as a generalist, followed by the invasion of a second, more specialized, consumer. 
This theoretical scenario has been hypothesized as the sequence of events leading to character displacement in threespine stickleback in small coastal lakes of British Columbia [@Schluter1992; @Schluter2000].

To test whether my results were robust to this asymmetry, I used the evolved attack rates at the end of the single consumer simulations as the starting values for the competitor in the two consumer simulations. 
I did this for all foraging scenarios and tradeoffs previously examined. 
I found that my previous inferences are robust to including consumer asymmetry across different tradeoffs and foraging scenarios (see Appendix S4). <!--A\ref{fig:MacArthur_Plot_asymm}, A\ref{fig:LS_Plot_asymm}, A\ref{fig:McCann_Plot_asymm}).-->

# Discussion

## Resource abundances

One of the criteria used to demonstrate character displacement is that "sites of sympatry [two consumers] and allopatry [one consumer] should not differ greatly in food, ..." [@Schluter1992].
In contrast, my results suggest that ecological character displacement causes predictable differences in resource abundances.
In fact, the ecological and evolutionary scenarios that favored the greatest character divergence always decreased the abundance of resources. <!-- build paragraph around this topic sentence -->
For example, the magnitude of character displacement was highest when mobile consumers competed for resources that occur in different habitats compared to within the same area.
An empirical example of this is threespine stickleback that have diverged into limnetic and benthic species with specialized traits to forage on zooplankton and benthic invertebrates, respectively [@Schluter1992; @Schluter2000].
These resources occur in distinct zones of the lake (pelagic and littoral), therefore stickleback must move between these zones and compete when foraging for resources. 
Interestingly, a disproporationate number of the documented cases of character displacement involve carnivores [@Schluter2000] that are larger, and likely more mobile, than their resources [@McCann2005], suggesting my predictions may apply to many cases of ecological character displacement.

Similarly, the evolutionary tradeoff that favored character divergence resulted in lower resources across all foraging scenarios.
Although data on the shape of the tradeoff in consumer foraging traits is scarce, two classic examples of character displacement, Darwin's finches and threespine stickleback, both appear to exhibit a tradeoff where extreme trait values increase the net foraging rate of consumers [@Schluter1985; @Arnegard2014]. 
While it is theoretically possible that character displacement does not alter resource abundances, this was limited to the simplest, and arguably least realistic, foraging scenario and under tradeoffs that did not favor large displacements, and thus less likely to detect in nature.
Taken together, my results call for empirical work to test these clear theoretical predictions and suggest a revision is needed for one of the criteria used to demonstrate character displacement. 

<!--
The simplest foraging scenario examined here (linear functional response on resources occuring in the same habitat) is the foundation of mechanistic models of resource competition [@MacArthur1972; @Lawlor1976; @Abrams1986]. 
Under this scenario, it is theoretically possible that character displacement results in increased resource abundances [green lines in \ref{fig:MacArthur_Plot}].
This only occurs, however, under an evolutionary tradeoff that constrains the magnitude of character displacement.
This suggests that it would be unlikely to ever observe divergent character displacement and increases in resource abundances in a real system. 
In contrast, the evolutionary tradeoff that favors character displacement the most decreased resource abundances. 
Although data on the shape of the tradeoff in consumer foraging traits is scarce, two classic examples of character displacement, Darwin's finches and threespine stickleback, both appear to exhibit a tradeoff where extreme trait values increase the foraging rate of consumers (orange lines in \ref{fig:MacArthur_Plot}A,B). 
This is evident by the disruptive selection observed for beak size/shape in Darwin's finches [@Schluter1985] and benthic/limnetic ecotypes for stickleback [@Arnegard2014] in resource-limited environments. 
<!-- key point of the paragraph 
Taken together, my model predicts that even in the simplest foraging scenario, the most likely relationship we would observe in nature is for food webs where consumers have undergone character displacement to have lower total resource densites.

A general result emerging from my analysis was that, when consumers were competing for resources in distinct habitats, character displacement always supressed resource abundances. 
<!-- show that this is common scenario 
Consumers are generally larger, and as a result, more mobile than their resources; thus, their foraging behavior acts to couple resource dynamics across traditional habitat boundaries [@McCann2005].
An example of character displacement that matches this foraging scenario is threespine stickleback in postglacial lakes of British Columbia, Canada [@Schluter1992; @Schluter2000].
In these lakes, stickleback have undergone character displacement into limnetic and benthic species that have evolved specialized traits to forage on zooplankton and benthic invertebrates, respectively.
These resources occur in distinct zones of the lake (pelagic and littoral) and stickleback move between these zones when foraging for resources. 
<!-- good closing sentences --
A disproporationate number of the documented cases of character displacement involve carnivores that are larger, and likely more mobile, than their resources [@Schluter2000],
Therefore, my predictions may apply to many cases of ecological character displacement.
-->

<!-- consider removing entirely. This is a prediction I could test with Seth in another paper...
Character displacement is far from an all-or-nothing process, but may vary in its magnitude [@Schluter2000]. 
My results suggest that the magnitude of character displacement will be negatively correlated with total resource abundances, at least when resources occur in distinct habitats (line trajectories in \ref{fig:LS_Plot}B, \ref{fig:McCann_Plot}B).
This prediction could be tested either experimentally, by putting populations that vary in divergence in a common resource setting, or with field data that statistically controls for other factors affecting resources.
Note though, this prediction will only apply to comparisons within species where there is likely little difference in the shape of the tradeoff among populations.
-->

## Food-web Stability

My most striking result was that character divergence, when examined through the lens of food-web theory, made food webs less resilient to perturbations. 
In fact, under the most realistic foraging scenario, character divergence can even result in an unstable food web. 
The mechanism underlying this destabilization is quite general.
Character divergence generally increases the strength of consumer-resource interactions, but does not alter the strength of intraspecific interactions.
This relative increase in interspecific interactions, combined with the natural oscillatory tendency of consumer-resource dynamics [@Lotka1925; @Volterra1926], creates a food-web structure that is less resilient to perturbations [@Chesson2008; @Rip2011; @McCann2011].

Interestingly, the ecological conditions that favor character divergence are those that are already the least resilient to perturbations.
For example, @McPeek2019 showed that character divergence is favored in food webs that are either highly productive, easy to find and capture resources, or under weak abiotic stress.
This corresponds to higher values of $K$ (productivity) or $A$ (capacity to find and capturing resources), or lower values of $m$ (abiotic stress).
Each of these corresponding changes decrease food-web resilience, as they increase the strength of consumer-resource interactions relative to intraspecific interactions.
For example, increasing productivity reduces intraspecific competition in resource populations while increasing the flux of energy to consumers, resulting in the paradox of enrichment [@Rosenzweig1971]. 
Similarly, higher feeding rates or lower consumer mortality both increase the relative strength of consumer-resource interactions, which predictably destabilizes food webs [@Rip2011; @McCann2011].
This suggests that the most dramatic examples of character divergence will not only occur in, but also cause, the least stable food-web structures. 

A handful of empirical patterns support the hypothesis that character divergence decreases food-web resilience. 
For example, a single species of threespine stickleback lives in hundreds of small coastal lakes of British Columbia, but the species pair, where character divergence has resulted in specialized limnetic and benthic species, are only known from six lakes in four independent watersheds [@Schluter1992; @Schluter2000].
Perhaps many lakes had a species pair in the past, but have lost a species due to a less resilient food-web structure [@Borrelli2015a; @Borrelli2015b].
The species pair are known to be vulnerable to perturbations, as they have gone extinct in two of the six lakes after the introduction of nonnative species [@Hatfield2001; @Taylor2006; @Rudman2016].
The vulnerability of the stickleback system also corresponds with the fact that aquatic food webs have several properties that make them less resilient to perturbations, such as higher productivity and more efficient energy transfer to consumers [@Rip2011].
Detecting the ghost of competition past [@Connell1980] may be quite difficult, but it could be possible with recent advances in genomics.
<!--Testing this hypothesis ---that some lakes with a single species had a species pair in the past --- may be quite difficult, but it could be possible with recent advances in genomics.-->
For example, @Feulner2018 detected genomic signatures of hybridization in sympatric whitefish species following periods of eutrophication.
Perhaps solitary stickleback in some lakes retain genomic signatures of having been a habitat specialist in the past.

<!-- interesting, but tighten up 
A plausible explanation for this rarity is that the food-web structure makes the species pair more vulnerable to extinction, and many lakes that used to have a species pair have  single species of stickleback are more stable
A plausible explanation for this rarity is that nonadaptive selection results in a more ecologically stable food-web topology [@Borrelli2015a; @Borrelli2015b].
Testing this hypothesis ---some lakes with a single species had two in the past --- may be quite difficult, but it may be feasible with recent advances in genomics.
For example, @Feulner2018 detected genomic signatures of hybridization in sympatric whitefish species following periods of eutrophication.
Perhaps stickleback in some lakes retain genomic signatures of having been a habitat specialist in the past.
Other evidence also suggests that the species pair of stickleback are vulnerable to perturbations.
For example, the introduction of nonnative species into two of the six lakes have resulted in the extinction of the species pair [@Hatfield2001; @Taylor2006; @Rudman2016].
-->

My results contrast, but do not necessarily contradict, the notion from coexistence theory that character displacement contributes to species coexistence [@Lawlor1976]. 
Rather than studying resilience, coexistence theory usually studies the mutual ability of consumers with different phenotypes to invade when rare [mutual invasibility, @Chesson2000].
In the context of character displacement, a shortcoming of this mutual invasibility measure is that it does not allow a comparison between food webs with and without a competiting consumer. 
Such comparisons are necessary for inferring the effects of character displacement, a point that has been made clear in the criteria to demonstrate character displacement [@Schluter1992; @Schluter2000].
Although the addition of a consumer to a food web can decrease its resilience in the absence of evolution [@May1973], my results are primarily driven by an eco-evolutionary feedback between consumer evolution and resource abundances (compare initial and ending points in Fig. \ref{fig:MacArthur_Plot}C, \ref{fig:LS_Plot}C, \ref{fig:McCann_Plot}C).

## Caveats

I studied this eco-evolutionary feedback between consumers and resources using an Adaptive Dynamics approach.
A strength of this approach is that it enabled me to gain analytical insight to the effects of character divergence on food-web dynamics in a more realistic foraging scenario.
This is much less tractable in quantitative genetic [@Taper1985; @McPeek2017] or explicit genetic [@Doebeli1996] models of character displacement, which is why the foraging scenarios previously examined have been limited [but see @McPeek2017]. 
A weakness, however, is that I assume a separation of time scales between ecological and evolutionary dynamics, an assumption that is becoming less tenable [@Hairston2005; @Hendry2016].
I also do not explicitly model an underlying phenotypic trait for consumer attack rates nor do I allow for intraspecific variation. 
That being said, my theoretical predictions are likely robust to these assumptions. 
This is because models that explicitly include resource dynamics inevitably show that resource competition results in character divergence, regardless of whether a quantitative genetic or Adaptive Dynamics approach is used [@Lawlor1976; @Taper1985]. 
A quantitative genetic model may certainly show differences in the magnitude of character divergence, but this should not affect the consequences for food-web dynamics. <!-- In fact, recent work by @McPeek2017 has shown that divergence in a quantitative genetics model can lead to decreased resource abundances and unstable dynamics. -->It is important to note that my conclusions only apply to food webs with biotic resources that are nutritionally substitutable. 
It would be interesting to extend these current analyses to non-substitutable resources where chracter convergence is expected [@Abrams1987; @Fox2008].

## Conclusions

Here, I show that an adaptive process that generates phenotypic diversity generally makes that diversity more susceptible to future extinctions.
This destabilizing effect emerges from an eco-evolutionary feedback involving direct and indirect interactions between species in a food-web context.
<!--This highlights how the process of adaptation, when considered in a food-web context, may generate feedbacks that destabilize the interconnected parts of the system.
This suggests that observed patterns of biodiversity may not simply be a result of evolutionary constraints, but also ecological constraints
To what extent are current patterns in biodiversity a result of ecological constraints on the persistence of evolved phenotypes? -->
This result contrasts with the current notion that patterns of phenotypic diversity are solely the result of evolutionary constraints imposed by mutation, natural selection, gene flow, and genetic drift.
In particular, my result supports the recent suggestion that food-web stability can impose an ecological constraint on phenotypic diversity that is agnostic to these evolutionary processes [@Borrelli2015b].
I expect that identifying when and where this ecological constraint arises will yield novel insight to the patterns of biodiversity we see in nature.
<!--Identifying when and where we expect this ecological constraint to arise may yield novel insight to the patterns of biodiversity we see in nature. --> 

<!-- Omitting conclusions section for now. I will wait for feedback from friendly reviews

## Conclusions

<!-- originally opening paragraph of discussion; I think it provides too good of a summary though to put at the beginning. It makes subsequent discussion sound redundant
My results show that character displacement leads to predictable differences in resource abundances and the resilience of food webs to perturbations.
Specifically, I found that, whenever character displacement increased the effective attack rate of consumers, it resulted in lower resource abundances and less resilient food webs. 
Character displacement always increased attack rates whenever consumers were competing for resources that occured in distinct habitats. 
This occurred under different evolutionary tradeoffs and in both simple and more realistic foraging scenarios.
Although character displacement did not always increase effective attack rates, these contingent effects only occurred under the simplest and (arguably) least realistic foraging scenario. 
My study takes advantage of past work showing that adaptive divergence in consumer attack rates is always favored under the scenarios examined here [@LawlorSmith1976; @Abrams1986].
Taken together, my results indicate that the adaptive process of character displacement often comes at the ecological cost of making food webs less resilient to perturbations. 

<!--
## Conclusions
- needs revision
- do this after I rewrite/edit the rest of the Discussion

Competition theory suggested that character displacement was a stabilizing force in ecological communities [@Lawlor1976]. 
My results show the exact opposite, when a food-web perspective is taken.
Importantly, a food-web approach permits comparisons between communities in the presence of absence of a competitor, allowing a fair comparison of the effects of character displacement on food-web dynamics.
These results appear to be quite general, as they characterize the general foraging scenario where consumers are more mobile than their resources. 
These results also suggest that the very evolutionary process that generates biodiversity, creates an ecological scenario that makes that diversity fragile to loss. 
These results highlight how evolution, when considered in a food-web context, may actually be a destabilizing force in ecological communities. 
This may generally be true of consumer evolution, as was pointed out decades ago [@Rosenzweig1963].
These results also highlight a tension between adaptive process (evolution of consumers to increase feeding efficiency) and a non-adaptive process (food-web stability).
These results suggest that in systems with evidence of ecological character displacement, why do they persist? 
These results open up a new avenue for research on ecological character displacement, one that explores in more detail the dynamical consequences of consumer evolution, rather than just static effects that assume resources are persistent and stable. 
It also suggest that actually observing evidence of ecological character displacement may be difficult ...
It also highlights how evolution of key species in a food web may make these systems more susceptible to environmental change. 
It's been argued that "inferences about the evolution of community structure cannot be based on ecological arguments about community stability or likely coexistence" [@McPeek2019].
In contrast, our results suggest that current patterns in food-web structure may be the result of non-adaptive processes selecting for more stable food-web configurations.
Our results also call for a revision of one of the criteria of character displacement, since it is clear that this process can result in different resource dynamics.
In fact, this resource similarity hypothesis has not been tested in natural systems, although it has been qualitatively inferred, and some quantitative estimates based on physical properties of systems have been measured to try and say these habitats are similar. (NEED TO CHECK SCHLUTER 2000 BOOK, THE AM NAT STUDY SUGGESTS THAT IT IS A COMMONLY FILLED CRITERIA.)
More generally, our results highlight how variation in food-web structure can alter eco-evolutionary feedbacks within communities [@McPeek2017], that also have consequences for their resilience to environmental disturbances.
This calls for food-web ecologists to more criticaly consider the role of evolutionary processes in shaping food-web structure and dynamics.
-->

# Acknowledgements

This work was inspired by discussions with Seth Rudman, Dolph Schluter, Ben Gilbert, and Kevin McCann.
Sally Otto provided much help in early analyses of the mathematical model. 
I would not have been able to take the theory as far as I did without her guidance and encouragement.
For funding support, I thank the University of British Columbia (Four-Year Fellowship to M.A. Barbour), NSERC (Discovery grant to Greg Crutsinger), and the Swiss National Science Foundation (grant 31003A_160671 to Jordi Bascompte).
 

# Supplementary Material

```{r MacArthur_asymm, include=FALSE}
# replaced MacArthur_displacements with MacArthur_displacements_asymm

Mac_attack_asymm <- ggplot(tradeoff_df, aes(x=aii/(aii+aij), y=aii+aij, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(MacArthur_displacements_asymm, Time=="End"), aes(x = a11/(a11+a12), y=a11+a12, fill=factor(n), shape=Competitor), size=3, color="white") + 
  #geom_point(data = filter(MacArthur_displacements_asymm, Time=="Begin"), aes(x = a11/(a11+a12), y=a11+a12, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(expression(a[ii]+a[ij])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Mac_resources_asymm <- cbind.data.frame(select(tradeoff_df, n, aii, aij), MacArthur_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=R1+R2, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(MacArthur_displacements_asymm, Time=="End"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=3, color="white") +
  #geom_point(data = filter(MacArthur_displacements_asymm, Time=="Begin"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(expression(R[i]+R[j])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Stability_Mac_asymm <- cbind.data.frame(select(tradeoff_df, n, aii, aij), MacArthur_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=-1*max.Re.eigen, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(MacArthur_displacements_asymm, Time=="End"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=3, color="white", show.legend=FALSE) + 
  geom_point(data = filter(MacArthur_displacements_asymm, Time=="Begin"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  ylab(expression("Stability "(-lambda[max]))) + 
  scale_shape_manual(values=c(24,21))  +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  geom_hline(yintercept=0, color="grey") +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Mac_plots_asymm <- plot_grid(Mac_attack_asymm + theme(legend.position = "none"), 
                             Mac_resources_asymm   + theme(legend.position = "none"), 
                             Stability_Mac_asymm   + theme(legend.position = "none"), 
                       ncol=2, labels = "AUTO", align = 'hv')
Mac_plots_asymm

save_plot(filename="Figure_ECD_MacArthur_asymm.pdf", plot=Mac_plots_asymm, base_height = 6, base_width = 6)
```

```{r MacArthur_Plot_asymm, include=FALSE, eval=FALSE, fig.pos="H", fig.cap="\\label{fig:MacArthur_Plot_asymm}**Effect of character displacement when consumers can forage for both resources simultaneously and have an asymmetry in initial attack rates.** Different line colors correspond to different tradeoff values (green, *n* = 1.15; blue, *n* = 1; orange, *n* = 0.85). Large circles (two consumers) and triangles (one consumer) correspond to the end points of the eco-evolutionary simulation, whereas as small shapes correspond to the starting points. Panel (A) shows how the shape of this tradeoff affects the magnitude of character displacement and the evolution of total attack rates in the consumer community. Panels (B) and (C) show how different tradeoffs indirectly affect total resource abundances (B) and food-web stability (C). These simulations used the following parameter values: *r* = 1; *K* = 4; *e* = 0.8; *m* = 1; *A* = 2. We set an initial value of *a~ii~* = 1.2 and *a~ij~* depended on the value of *n*. To create an asymmetry in initial attack rates, we used the ending *a~ii~* and *a~ij~* values for the one consumer simulation as the starting values for *C~2~* in the two consumer simulation. We set initial consumer and resource abundances as: *R~i~* = *R~j~* = 2; *C~i~* = *C~j~* = 1."}
knitr::include_graphics("Figure_ECD_MacArthur_asymm.pdf")
```

```{r LawlorSmith_asymm, include=FALSE}
# replaced LawlorSmith_displacements with LawlorSmith_displacements_asymm

LS_attack_asymm <- ggplot(tradeoff_df, aes(x=aii/(aii+aij), y=wii*aii+wij*aij, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(LawlorSmith_displacements_asymm, Time=="End"), aes(x = a11/(a11+a12), y=w11*a11+w12*a12, fill=factor(n), shape=Competitor), size=3, color="white") + 
  #geom_point(data = filter(LawlorSmith_displacements_asymm, Time=="Begin"), aes(x = a11/(a11+a12), y=w11*a11+w12*a12, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(expression(w*a[ii]+(1-w)*a[ij])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

LS_resources_asymm <- cbind.data.frame(select(tradeoff_df, n, aii, aij), LawlorSmith_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=R1+R2, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(LawlorSmith_displacements_asymm, Time=="End"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=3, color="white") + 
  #geom_point(data = filter(LawlorSmith_displacements_asymm, Time=="Begin"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(expression(R[i]+R[j])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Stability_LS_asymm <- cbind.data.frame(select(tradeoff_df, n, aii, aij), LawlorSmith_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=-1*max.Re.eigen, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(LawlorSmith_displacements_asymm, Time=="End"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=3, color="white", show.legend=FALSE) + 
  geom_point(data = filter(LawlorSmith_displacements_asymm, Time=="Begin"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  ylab(expression("Stability "(-lambda[max]))) + 
  scale_shape_manual(values=c(24,21))  +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  geom_hline(yintercept=0, color="grey") +
  guides(fill = guide_legend(override.aes=list(shape=21)))

LS_plots_asymm <- plot_grid(LS_attack_asymm   + theme(legend.position = "none"), 
                             LS_resources_asymm   + theme(legend.position = "none"), 
                             Stability_LS_asymm   + theme(legend.position = "none"), 
                       ncol=2, labels = "AUTO", align='hv')
LS_plots_asymm

save_plot(filename="Figure_ECD_LS_asymm.pdf", plot=LS_plots_asymm, base_height = 6, base_width = 6)
# moved to supplementary information
```

```{r McCann_asymm, include=FALSE}
# replaced McCann_displacements with McCann_displacements_asymm

McCann_attack_asymm <- ggplot(tradeoff_df, aes(x=aii/(aii+aij), y=wii*aii+wij*aij, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(McCann_displacements_asymm, Time=="End"), aes(x = a11/(a11+a12), y=w11*a11+w12*a12, fill=factor(n), shape=Competitor), size=3, color="white") + 
  #geom_point(data = filter(McCann_displacements_asymm, Time=="Begin"), aes(x = a11/(a11+a12), y=w11*a11+w12*a12, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(expression(w*a[ii]+(1-w)*a[ij])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

McCann_resources_asymm <- cbind.data.frame(select(tradeoff_df, n, aii, aij), McCann_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=R1+R2, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(McCann_displacements_asymm, Time=="End"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=3, color="white") + 
  #geom_point(data = filter(McCann_displacements_asymm, Time=="Begin"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  ylab(expression(R[i]+R[j])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Stability_McCann_asymm <- cbind.data.frame(select(tradeoff_df, n, aii, aij), McCann_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=-1*max.Re.eigen, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(McCann_displacements_asymm, Time=="End"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=3, color="white", show.legend=FALSE) + 
  geom_point(data = filter(McCann_displacements_asymm, Time=="Begin"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=1.5, color="white") +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  ylab(expression("Stability "(-lambda[max]))) + #ylab(expression(-1%*%"Re"(lambda[max]))) +
  scale_shape_manual(values=c(24,21))  +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  geom_hline(yintercept=0, color="grey") +
  guides(fill = guide_legend(override.aes=list(shape=21)))

McCann_plots_asymm <- plot_grid(McCann_attack_asymm   + theme(legend.position = "none"), 
                             McCann_resources_asymm   + theme(legend.position = "none"), 
                             Stability_McCann_asymm   + theme(legend.position = "none"), 
                       ncol=2, labels = "AUTO", align = 'hv')
McCann_plots_asymm

save_plot(filename="Figure_ECD_McCann_asymm.pdf", plot=McCann_plots_asymm, base_height = 6, base_width = 6)
# moved to supplementary information
```

```{r all asymmetry}

all_asymm_plots <- plot_grid(
  Mac_attack_asymm + ggtitle("Scenario I\n") + theme(legend.position = "none", axis.text.x=element_blank()) + xlab("") + ylab(bquote(atop("Effective attack rate","("*a[ii]+a[ij]*")"))), #, plot.title=element_text(size=8)
  LS_attack_asymm  + ggtitle("Scenario II\n") + theme(legend.position = "none", axis.text.x=element_blank()) + xlab("") + ylab(bquote(w[ii]*a[ii]+"("*1-w[ii]*")"*a[ij]*")")), #, plot.title=element_text(size=8)
  McCann_attack_asymm + ggtitle("Scenario III")  + theme(legend.position = "none", axis.text.x=element_blank()) + xlab("") + ylab(bquote(w[ii]*a[ii]+"("*1-w[ii]*")"*a[ij]*")")), #, plot.title=element_text(size=8), plot.subtitle=element_text(size=8)
  Mac_resources_asymm   + theme(legend.position = "none", axis.text.x=element_blank()) + xlab("") + ylab(bquote(atop("Resource abundance","("*R[1]+R[2]*")"))),
  LS_resources_asymm   + theme(legend.position = "none", axis.text.x=element_blank()) + xlab("") + ylab(""),
  McCann_resources_asymm   + theme(legend.position = "none", axis.text.x=element_blank()) + xlab("") + ylab(""),
  Stability_Mac_asymm   + theme(legend.position = "none") + scale_x_continuous(labels=c(0,0.25,0.5,0.75,1)) + xlab("") + ylab(bquote(atop("Food-web stability","("*-lambda[max]*")"))),
  Stability_LS_asymm   + theme(legend.position = "none") + scale_x_continuous(labels=c(0,0.25,0.5,0.75,1)) + xlab("") + ylab(""),
  Stability_McCann_asymm   + theme(legend.position = "none") + scale_x_continuous(labels=c(0,0.25,0.5,0.75,1)) + xlab("") + ylab(""),
  ncol=3, align='v'#, rel_widths = c(1,0.9,0.9)
)

all_asymm_plots <- add_sub(all_asymm_plots, label = expression(paste("Specialization ", bgroup("(",frac(a[ii],a[ii]+a[ij]),")"))))

save_plot(filename="asymm_figs.pdf", plot=all_asymm_plots, base_height = 11, base_width = 8.5)
```

