---
title: "How does character divergence affect resource dynamics?"
output: html_document
author: Matt Barbour
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	include = FALSE
)
source('eco_evo_simulations.R')
```

### Model of resource competition

We analyzed a continuous-time model of consumer-resource dynamics for two consumers ($C_1,C_2$) competing for two shared resources ($R_1,R_2$): 

$$\frac{dR_1}{dt}=r_1K_1(1-\frac{R_1}{K_1})-F_{11}(R_1)C_1-F_{21}(R_1)C_2$$
$$\frac{dR_2}{dt}=r_2K_2(1-\frac{R_2}{K_2})-F_{12}(R_2)C_1-F_{22}(R_2)C_2$$
$$\frac{dC_1}{dt}=e_{11}F_{11}(R_1)C_1+e_{12}F_{12}(R_2)C_1-m_1C_1$$
$$\frac{dC_2}{dt}=e_{21}F_{21}(R_1)C_2+e_{22}F_{22}(R_2)C_2-m_2C_2$$
where $r_i$ represents intrinsic growth rates, $K_i$ represents carrying capacity, $e_{ij}$ represents the conversion efficiency of resources into new consumers, and $m_i$ represents the mortality rate of consumers. $F_{ij}(R_j)$ represents the consumer's feeding rate (or functional response) on a specific resource (in this case, $C_i$ on $R_j$). This model is a useful characterization of a scenario where consumers compete for two distinct resources (e.g. zooplankton and benthic invertebrates) rather than if resources are better characterized by a continuous trait distribution (e.g. seed size, Taper and Case 1985). In the scenario where consumer feeding rates increase linearly with resource density as a function of their attack rate, such that $F_{ij}(R_j)=a_{ij}R_j$, then our model becomes MacArthur's model of resource competition (MacArthur 1972). The evolution of consumer attack rates in this model, and several extensions, have been analyzed in detail (Lawlor and Smith 1976; Abrams 1986). The general result of these analyses is that consumer divergence is an inevitable outcome of competition. To be explicit, this means that the specialization of evolved consumers ($\frac{a_{ii}{a_{ii}+a_{ij}}$) is greater in the presence of competitor compared to when no competitor is present. 

Here, we examine the effects of this inevitable divergence in attack rates on food-web dynamics. In particular, we examine how divergence in attack rates affects resource abundances as well as the resilience of both resources and consumers to perturbations. We do this by (i) deriving analytical expressions for the relationship between attack rates and food-web dynamics and (ii) simulate the effects of competition on the eco-evolutionary dynamics of consumers and resources. For these simulations, we used an Adaptive Dynamics approach. At each evolutionary time step, we created a mutant consumer by randomly choosing a consumer and modifying its attack rate by either subtracting or adding a small constant (0.001 in the following simulations) with equal probability. Assuming this mutant consumer was rare, we then determined whether the mutant had higher relative fitness than the resident consumer, and thus could invade and replace the resident consumer. If the mutant was able to invade, we updated the attack rate of the resident consumer to the mutant attack rate and allowed consumer and resource dynamics to reach a steady state. We then repeated the simulation 10,000 times, which was sufficient for consumers to either reach an evolutionary stable strategy (ESS, Price & Maynard Smith 1973) or limit (e.g. $\frac{a_{ii}{a_{ii}+a_{ij}}$ is constrained to a maximum of 1 and minimum of 0). Below is a table of the parameters used in these simulations. Our mathematical analyses show that the consequences of character displacement on food-web dynamics are not intuitive and depend critically on the foraging scenario and tradeoff in consumer attack rates. 

## Effect of character divergence on resource abundances

We start by examing the effects of character displacement on the abundance of resources at equilibrium, which will also set the stage for a later analysis of food-web stability. In particular, we examine three different foraging scenarios: (i) consumers forage for resource simultaneously and their feeding rates increase linearly with resource density (MacArthur 1972); (ii) consumers *cannot* forage for resources simultaneously and their feeding rates increase linearly with resource density (Lawlor & Smith 1976); (iii) consumers *cannot* forage for resources simulaneously and their feeding rates on each resource depend on both resource densities and saturate at high densities (McCann 2005).   

### Consumers forage for resources simultaneously

The first foragine scenario we explore is already assumed in MacArthur's model of resource competition, namely that consumers can forage for both resources simultaneously. In essence, this implies that both resources occur within the same microhabitat. To gain analytical insight to this scenario, we assume that resources are equivalent ($r=r_1=r_2$ and $K=K_1=K_2$) as well as consumers ($e=e_{11}=e_{12}=e_{21}=e_{22}$; $m=m_1=m_2$), except that consumer attack rates are mirror images of each other ($a_{ii}=a_{11}=a_{22}$; $a_{ij}=a_{12}=a_{21}$). While this scenario is simple, it isolates the process of character displacement, rather than whether these effects depend on inherent differences in consumers or resources. In the appendix, we show that when both consumers and resources are present that the abundance of resources at equilibrium are equivalent ($R=R_1=R_2$) and are determined by the following equation:

$$\hat{R}=\frac{1}{a_{ii}+a_{ij}}\cdot\frac{m}{e}$$
Note that a key determinant of resource abundance is the consumer's total attack rate, $a_{ii}+a_{ij}$. Since the total attack rate is in the denominator, this implies that resource abundances will decrease if evolution favors an increase in total attack rate. We assume that consumers are not 'Darwinian demons' (Law 1979) and thus the evolution of their attack rates are subject to certain constraints. We modelled these constraints using the following general function: 

$$\Big(\frac{a_{ii}}{A}\Big)^n+\Big(\frac{a_{ij}}{A}\Big)^n=1$$

where $A$ is the total investment in attack rates and $n$ describes the shape of the tradeoff. This function has the useful property that it differentiates between cases where intermediate combinations of $a_{ii}$ and $a_{ij}$ are higher, on average, than the extremes (when $n>1$) or, conversely, where the two extremes are higher, on average, than intermediate investments (when $n<1$; Sargent and Otto 2006). When $n=1$, the tradeoff function is linear, and all combinations of $a_ii$ and $a_ij$ have the same total attack rate.

```{r Tradeoff function, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
bind_rows(concaveDN_df, linear_df, concaveUP_df) %>%
  ggplot(., aes(x=aii, y=aij, linetype = factor(n))) + 
  geom_line() + 
  xlab(expression(a[ii])) +
  ylab(expression(a[ij])) +
  scale_linetype_manual(values=1:3, name="Tradeoff (n)") 
```

We know from past work that consumers still undergo character divergence regardless of the shape of the tradeoff (Lawlor and Smith 1976; Abrams 1986). Interestingly, we find that the shape of the tradeoff qualitatively affects the relationship between character divergence and resource abundance. For example, if consumer's are constrained by a linear tradeoff ($n=1$), such that a unit increase in $a_{ii}$ results in a unit decrease in $a_{ij}$, then character divergence has no effect on resource abundances. If the tradeoff is concave down ($n>1$), then resource abundances can actually increase under character displacement! This is because the total attack rate of consumers is maximized at intermediate values ($a_{ii}=a_{aij}$) and decreases as consumers diverge. Note though that detecting this effect in nature will likely be difficult, since a concave down tradeoff results in relatively small displacement relative to other tradeoff forms (Lawlor and Smith 1976). When the tradeoff is concave up ($n<1$), however, we see that character divergence suppresses resource densities. Although this equilibrium equation for resource abundances was derived for the scenario where both consumers and both resources are present, it predicts well the abundance of resources when there is only one consumer (white circle). This is because a consumer, in the absence of competition, evolves to be a generalist that has equal attack rates on each resource, resulting in equivalent resource abundances. 


```{r Same resource habitat, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
Mac_attack <- ggplot(tradeoff_df, aes(x=aii/(aii+aij), y=aii+aij, linetype = factor(n))) + 
  geom_line() +
  geom_point(data = filter(MacArthur_displacements, Time=="End"), aes(x = a11/(a11+a12), y=a11+a12, fill=Competitor), shape=21, size=5, inherit.aes = FALSE) +
  ylab(expression(a[ii]+a[ij])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_linetype_manual(values=1:3, name="Tradeoff (n)") +
  scale_fill_manual(values=c("white","black"))

Mac_resources <- cbind.data.frame(tradeoff_df, MacArthur_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=R1+R2, linetype = factor(n))) + 
  geom_line() +
  geom_point(data = filter(MacArthur_displacements, Time=="End"), aes(x = a11/(a11+a12), y=R1+R2, fill=Competitor), shape=21, size=5, inherit.aes = FALSE) +
  ylab(expression(R[i]+R[j])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_linetype_manual(values=1:3, name="Tradeoff (n)") +
  scale_fill_manual(values=c("white","black"))

Mac_plots <- plot_grid(Mac_attack + theme(legend.position = "none"), Mac_resources + theme(legend.position = "none"), nrow=1)

Mac_legend <- get_legend(Mac_attack)

Mac_plot_legend <- plot_grid(Mac_plots, Mac_legend, ncol=2, rel_widths = c(3,0.3), align='hv')

Mac_title <- ggdraw() + draw_label("Resources in same habitat", fontface='bold')
plot_grid(Mac_title, Mac_plot_legend, ncol=1, rel_heights=c(0.1, 1)) # rel_heights values control title margins
```

### Consumers *cannot* forage for resources simultaneously

Most models of character displacement have assumed a scenario where consumers can forage for both resources simultaneously (Taper and Case 1985; Abrams 1986). This assumption may be valid for some foraging scenarios (e.g. Darwin's finches foraging for seeds); however, in many situations consumers forage for resources that occur in distinct habitats, and thus cannot forage for both simultaneosly. The only chracter displacement model that we are aware of that modeled resources in distinct habitats was one examined by Lawlor and Smith (1976). This model takes the same form as the previous model, except now the consumer's functional response takes the form:

$$F_{ij}(R_j)=w_{ij}a_{ij}R_j$$

where $w_{ij}$ represents the proportion of time a consumer ($C_i$) spends foraging in a habitat where a particular resource ($R_j$) is found (i.e. habitat preference). Note that since $w_ij$ is a proportion that $w_{ii}=1-w_{ij}$. As with attack rates, we assume that consumer habitat preferences are mirror images of each other ($w=w_{11}=w_[22]$). 

Lawlor and Smith (1976) found that consumers still underwent character divergence regardless of whether consumers could or could not forage for resources simultaneously. We find that the foraging scenario qualitatively affects the relationship between character divergence and resource abundances. To demonstrate this, note that now resource abundances at equilibrium (both consumers and resources present) are determined by the following equation (see derivation in Appendix):

$$\hat{R}=\frac{1}{wa_{ii}+(1-w)a_{ij}}\cdot\frac{m}{e}$$

This equation implies that if consumers evolve to become specialists on resources that occur in their preferred habitat (e.g. $w>0.5$ and $a_{ii}>a_{ij}$), then resource abundances will always decrease, regardless of the tradeoff. Thus, character divergence always results in resource suppression if consumers are competing for resources that occur in distinct habitats. 

Note that the shape of the tradeoff can dampen or amplify the effect of character displacement. This is not because the tradeoff affects the magnitude of displacement, because as you can see, it has little effect (slightly less with concave down tradeoff). Its because for the concave up tradeoff, consumers have the lowest attack rate at intermediate values, but highest at extreme values, resulting in the largest change in resource abundances with character divergence. 

These results do lead to an interesting prediction that could be tested. If consumers are competing for resources that occur in distinct habitats, then greater ecological character displacement corresponds to a greater decrease in resource densities. Note that this prediction is only useful for comparing divergence within species. It cannot be used to predict across species where the nature of the trade-offs could be different.

It is important to note that, in this foraging scenario, resource abundances in the absence of competition no longer correspond to the analytical expression we derived when both consumers are present. This is because consumers actually evolve to be slightly specialized on the resources that occur in their non-preferred habitat. Note that our analytical expression consistently underestimates the effect of character displacement on resource dynamics. This implies that resource abundances are always higher than our analytical expression suggests when there is only one consumer. We will revisit this subtle point when we examine the effects of character displacement on food-web stability.

```{r Distinct resource habitats, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
LS_attack <- ggplot(tradeoff_df, aes(x=aii/(aii+aij), y=wii*aii+wij*aij, linetype = factor(n))) + 
  geom_line() +
  geom_point(data = filter(LawlorSmith_displacements, Time=="End"), aes(x = a11/(a11+a12), y=w11*a11+w12*a12, fill=Competitor), shape=21, size=5, inherit.aes = FALSE) +
  ylab(expression(w[ii]*a[ii]+(1-w[ii])*a[ij])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_linetype_manual(values=1:3, name="Tradeoff (n)") +
  scale_fill_manual(values=c("white","black"))

LS_resources <- cbind.data.frame(tradeoff_df, LawlorSmith_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=R1+R2, linetype = factor(n))) + 
  geom_line() +
  geom_point(data = filter(LawlorSmith_displacements, Time=="End"), aes(x = a11/(a11+a12), y=R1+R2, fill=Competitor),
             shape=21, size=5, inherit.aes = FALSE) +
  ylab(expression(R[i]+R[j])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_linetype_manual(values=1:3, name="Tradeoff (n)") +
  scale_fill_manual(values=c("white","black"))

LS_plots <- plot_grid(LS_attack + theme(legend.position = "none"), LS_resources + theme(legend.position = "none"), nrow=1)

LS_legend <- get_legend(LS_attack)

LS_plot_legend <- plot_grid(LS_plots, LS_legend, nrow=1, rel_widths = c(3,0.3))

LS_title <- ggdraw() + draw_label("Resources in different habitats", fontface='bold')
plot_grid(LS_title, LS_plot_legend, ncol=1, rel_heights=c(0.1, 1)) # rel_heights values control title margins
```

This effect of the foraging scenario on the relationship between character divergence and resource abundances appears to be quite general. For example, even if we consider a more realistic consumer functional response (derived by McCann et al. 2005):

$$F_{ii}(R_i,R_j)=\frac{a_{ii}W_{ii}R_i}{1+a_{ii}hW_{ii}R_i+a_{ij}hW_{ij}R_j}$$

where consumer feeding rates on $R_i$ are influenced by both resource densities; saturate as resource densities increase (due to handling time $h$); and consumer habitat preferences are modified by relative resource densities, such that:

$$W_{ii}=\frac{wR_i}{wR_i+(1-w)R_j}$$ 

we still observe the same qualitative relationship between character divergence and resource suppression. This is because resource competition always leads to character divergence (see proof in Appendix) and equilibrium resource abundances are governed by similar dynamics:

$$\hat{R}=\frac{1}{wa_{ii}+(1-w)a_{ij}}\cdot\frac{m}{e-hm}$$

This more realistic consumer functional response does actually make an interesting evolutionary prediction that differs from the scenario where consumer feeding rate scales linearly with resource density. Namely, that in the absence of competition, consumers remain slightly more specialized on the resources that occur in their preferred habitats, which actually opposes the prediction from the model where consumer feeding rate scales linearly with resource density. 

```{r}
McCann_attack <- ggplot(tradeoff_df, aes(x=aii/(aii+aij), y=wii*aii+wij*aij, linetype = factor(n))) + 
  geom_line() +
  geom_point(data = filter(McCann_displacements, Time=="End"), aes(x = a11/(a11+a12), y=w11*a11+w12*a12, fill=Competitor), shape=21, size=5, inherit.aes = FALSE) +
  ylab(expression(w[ii]*a[ii]+(1-w[ii])*a[ij])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_linetype_manual(values=1:3, name="Tradeoff (n)") +
  scale_fill_manual(values=c("white","black"))

McCann_resources <- cbind.data.frame(tradeoff_df, McCann_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=R1+R2, linetype = factor(n))) + 
  geom_line() +
  geom_point(data = filter(McCann_displacements, Time=="End"), aes(x = a11/(a11+a12), y=R1+R2, fill=Competitor), shape=21, size=5, inherit.aes = FALSE) +
  ylab(expression(R[i]+R[j])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_fill_manual(values=c("white","black"))

McCann_plots <- plot_grid(McCann_attack + theme(legend.position = "none"), McCann_resources + theme(legend.position = "none"), nrow=1)

McCann_legend <- get_legend(McCann_attack)

McCann_plot_legend <- plot_grid(McCann_plots, McCann_legend, nrow=1, rel_widths = c(3,0.3))

McCann_title <- ggdraw() + draw_label("Resources in different habitats & realistic functional response", fontface='bold')
plot_grid(McCann_title, McCann_plot_legend, ncol=1, rel_heights=c(0.1, 1)) # rel_heights values control title margins
```


### Predictions for threespine stickleback

The scenario where the relationship between character divergence and resource suppression is the strongest is when the tradeoff in attack rates is concave up and consumers are competing for resources that occur in distinct habitats. Prior work in threespine stickleback suggests that the evolution of stickleback attack rates are constrained by a concave-up tradeoff (Schluter 1993; Arnegard et al. 2014) and that stickleback ecotypes are competing for resources that occur in distinct habitats (benthic vs. limnetic). Thus, we predict that character divergence in sticklebacks would supress resource densities. 


## Effect of character divergence on food-web stability

This relationship between character divergence and resource abundances begs the question: how does character divergence affect food-web stability? This question has been addressed empirically by Pimentel as well as with a conceptual model. Lawlor and Smith though did a detailed theoretical analysis of how character divergence affects three different aspects of stability. They looked at stability through the lens of competition. The first aspect was whether character divergence resulted in mutual invasibility of consumers, a common metric of "stable coexistence" in competition models. Another very interesting aspect they looked at was a global metric that examined the persistence of the system to perturbations in resources. Here, they conclude the divergence increases community stability, because it expands the range of resource perturbations that a system can withstand before a consumer going extinct. Note though, that they overlooked that there conclusions do not actually quantify the effects of ecological character displacement on stability because they do not compare scenarios where a consumer is in allopatry and one where consumers are in sympatry. Finally, they also look at the Lyapunov exponent (local stability), and while they find a negative effect of divergence, they suggest that it would likely be overshadowed by the stabilizing effects of divergence on mutual invasibility and global stability.

Here we focus on local stability, which makes the most sense in a food-web context. We find that divergence follows the typical "check-mark" stability pattern that has been described recently in theoretical food-web models.

Importantly, this metric of stability allows us to compare the stability of three-species vs. four-species system, which is key for understanding how ecological character displacement affects food-web dynamics.



### Conclusions

Although we used an Adaptive Dynamics approach here, we expect that our results would apply to different models of the genetic architecture of attack rates (e.g. quantitative genetics, Taper & Case 1985), given that character divergence is an inevitable outcome of resource competition, regardless of the model of genetic architecture, when resources dynamics are explicitly modelled (Taper & Case 1985).

These conclusions are only for substitutable resources and that exhibit biological dynamics.